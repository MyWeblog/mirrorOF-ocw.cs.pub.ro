    
    

<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <title>cns:labs:lab-01</title>
<meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="date" content="2016-10-04T15:28:11+0300"/>
<meta name="keywords" content="cns,labs,lab-01"/>
<link rel="search" type="application/opensearchdescription+xml" href="../../../../lib/exe/opensearch.php" title="CS Open CourseWare"/>
<link rel="start" href="../../../../../courses.1.html"/>
<link rel="alternate" type="application/rss+xml" title="Recent Changes" href="../../../../feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Current Namespace" href="../../../../feed.php%3Fmode=list&amp;ns=cns:labs"/>
<link rel="alternate" type="text/html" title="Plain HTML" href="lab-01.html"/>
<link rel="canonical" href="../../../../cns/labs/lab-01.html"/>
<link rel="stylesheet" type="text/css" href="../../../../lib/exe/css.php%3Ft=arctic&amp;tseed=1476798676.css"/>
<script type="text/javascript">/*<![CDATA[*/var NS='cns:labs';var JSINFO = {"id":"cns:labs:lab-01","namespace":"cns:labs","isadmin":0,"isauth":0};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../../../../lib/exe/js.php%3Ftseed=1476798676"></script>
<script type="text/x-mathjax-config">/*<![CDATA[*/MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ["$","$"], ["\\(","\\)"] ],
        displayMath: [ ["$$","$$"], ["\\[","\\]"] ],
        processEscapes: true
    }
});
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
<script type="text/javascript">/*<![CDATA[*/
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
		  
/*!]]>*/</script>
<script type="text/javascript">/*<![CDATA[*/
var pageTracker = _gat._getTracker("UA-38383934-1");
pageTracker._initData();
pageTracker._trackPageview();
		  
/*!]]>*/</script>
</head>
<body>
<div class="dokuwiki export">
<!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle">Table of Contents</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="lab-01.html#lab_01_-_introduction_basic_exploration_tools">Lab 01 - Introduction. Basic Exploration Tools</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="lab-01.html#resources">Resources</a></div></li>
<li class="level2"><div class="li"><a href="lab-01.html#supporting_files">Supporting files</a></div></li>
<li class="level2"><div class="li"><a href="lab-01.html#introduction">Introduction</a></div></li>
<li class="level2"><div class="li"><a href="lab-01.html#even-password_1p">1. even-password [1p]</a></div></li>
<li class="level2"><div class="li"><a href="lab-01.html#odd-password_2p">2. odd-password [2p]</a></div></li>
<li class="level2"><div class="li"><a href="lab-01.html#halting-problem_25p">3. halting-problem [2.5p]</a></div></li>
<li class="level2"><div class="li"><a href="lab-01.html#straceme_2p">4. straceme [2p]</a></div></li>
<li class="level2"><div class="li"><a href="lab-01.html#guesser_25p">5. guesser [2.5p]</a></div></li>
<li class="level2"><div class="li"><a href="lab-01.html#extraarm_tasks_2p">6. Extra: ARM Tasks [2p]</a></div></li>
</ul></li>
</ul>
</div>
</div>
<!-- TOC END -->

<h1 class="sectionedit1" id="lab_01_-_introduction_basic_exploration_tools">Lab 01 - Introduction. Basic Exploration Tools</h1>
<div class="level1">

</div>
<!-- EDIT1 SECTION "Lab 01 - Introduction. Basic Exploration Tools" [1-62] -->
<h2 class="sectionedit2" id="resources">Resources</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> <a href="http://www.gnu.org/software/gdb/documentation/" class="urlextern" title="http://www.gnu.org/software/gdb/documentation/"  rel="nofollow">gdb documentation</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://unixhelp.ed.ac.uk/CGI/man-cgi?strings" class="urlextern" title="http://unixhelp.ed.ac.uk/CGI/man-cgi?strings"  rel="nofollow">strings (1) manual</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://linuxcommand.org/man_pages/xxd1.html" class="urlextern" title="http://linuxcommand.org/man_pages/xxd1.html"  rel="nofollow">xxd (1) manual</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://stackoverflow.com/questions/2388595/perl-how-do-i-escape-encode-special-characters/2388736#2388736" class="urlextern" title="http://stackoverflow.com/questions/2388595/perl-how-do-i-escape-encode-special-characters/2388736#2388736"  rel="nofollow">Perl - How do I escape/encode special characters</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://stackoverflow.com/questions/7668919/sending-hex-packets-in-python/7668943#7668943" class="urlextern" title="http://stackoverflow.com/questions/7668919/sending-hex-packets-in-python/7668943#7668943"  rel="nofollow">Sending hex packets in Python</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://www.python.org/dev/peps/pep-0223/" class="urlextern" title="http://www.python.org/dev/peps/pep-0223/"  rel="nofollow">Hex escape strings in Python</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://linux.die.net/man/1/strace" class="urlextern" title="http://linux.die.net/man/1/strace"  rel="nofollow">strace (1) manual</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://linux.die.net/man/1/objdump" class="urlextern" title="http://linux.die.net/man/1/objdump"  rel="nofollow">objdump (1) manual</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://unixhelp.ed.ac.uk/CGI/man-cgi?nm" class="urlextern" title="http://unixhelp.ed.ac.uk/CGI/man-cgi?nm"  rel="nofollow">nm (1) manual</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://man7.org/linux/man-pages/man8/ld.so.8.html" class="urlextern" title="http://man7.org/linux/man-pages/man8/ld.so.8.html"  rel="nofollow">ld.so (8) manual</a></div>
</li>
<li class="level1"><div class="li"> <a href="https://github.com/pwntester/cheatsheets/blob/master/radare2.md" class="urlextern" title="https://github.com/pwntester/cheatsheets/blob/master/radare2.md"  rel="nofollow">Radare2 Cheatsheet</a></div>
</li>
<li class="level1"><div class="li"> For the bonus:</div>
<ul>
<li class="level2"><div class="li"> <a href="http://ftp.jaist.ac.jp/pub/raspberrypi/raspbian/images/raspbian-2015-05-07/" class="urlextern" title="http://ftp.jaist.ac.jp/pub/raspberrypi/raspbian/images/raspbian-2015-05-07/"  rel="nofollow">Linux ARM Raspbian image</a></div>
</li>
<li class="level2"><div class="li"> <a href="https://github.com/dhruvvyas90/qemu-rpi-kernel/blob/master/kernel-qemu-3.10.25-wheezy" class="urlextern" title="https://github.com/dhruvvyas90/qemu-rpi-kernel/blob/master/kernel-qemu-3.10.25-wheezy"  rel="nofollow">Linux ARM kernel image</a></div>
</li>
</ul>
</li>
</ul>

</div>
<!-- EDIT2 SECTION "Resources" [63-1264] -->
<h2 class="sectionedit3" id="supporting_files">Supporting files</h2>
<div class="level2">

<p>
<a href="http://elf.cs.pub.ro/oss/res/labs/lab-01.tar.gz" class="urlextern" title="http://elf.cs.pub.ro/oss/res/labs/lab-01.tar.gz"  rel="nofollow">Lab archive</a>
</p>

</div>
<!-- EDIT3 SECTION "Supporting files" [1265-1359] -->
<h2 class="sectionedit4" id="introduction">Introduction</h2>
<div class="level2">

<p>
You will spend a large part of the labs and assignments working with *binaries*; in some of the cases we will also provide you with source code. You will have to find vulnerabilities in those binaries, then (possibly) exploit them and (possibly) fix the vulnerabilities in order to illustrate various secure coding practices. To achieve this, first you need to get comfortable with at least some of the common tools that are right for the job.
</p>

<p>
In the introductory lab we&#039;ll spice things up a bit by providing some simple binaries (with no source code) for you to play with. In order to solve the lab, you&#039;ll have to perform both <strong>static analysis</strong> and <strong>dynamic analysis</strong> on said binaries.
</p>

<p>
If you&#039;re too comfortable with the x86 architecture and feel that you could use some challenge, the <a href="http://elf.cs.pub.ro/oss/res/labs/lab-01.tar.gz" class="urlextern" title="http://elf.cs.pub.ro/oss/res/labs/lab-01.tar.gz"  rel="nofollow">lab archive</a> also contains the binaries compiled for ARM. You can try them out by running a Raspbian image on <a href="http://www.unixmen.com/emulating-raspbian-using-qemu/" class="urlextern" title="http://www.unixmen.com/emulating-raspbian-using-qemu/"  rel="nofollow">QEMU</a> (<a href="http://ftp.jaist.ac.jp/pub/raspberrypi/raspbian/images/raspbian-2015-05-07/" class="urlextern" title="http://ftp.jaist.ac.jp/pub/raspberrypi/raspbian/images/raspbian-2015-05-07/"  rel="nofollow">Raspbian image</a>, <a href="https://github.com/dhruvvyas90/qemu-rpi-kernel/blob/master/kernel-qemu-3.10.25-wheezy" class="urlextern" title="https://github.com/dhruvvyas90/qemu-rpi-kernel/blob/master/kernel-qemu-3.10.25-wheezy"  rel="nofollow">Linux kernel image</a>).
</p>

</div>
<!-- EDIT4 SECTION "Introduction" [1360-2611] -->
<h2 class="sectionedit5" id="even-password_1p">1. even-password [1p]</h2>
<div class="level2">

<p>
GLaDOS&#039; binary <code>even-password</code> is asking you to provide a password:
</p>
<pre class="code">$ ./even-password
Enter password:</pre>

<p>
Unfortunately, the program isn&#039;t very well thought out, the password being hard-coded. There are a few possible approaches to this (try them all):
</p>
<ul>
<li class="level1"><div class="li"> Using <code>strings</code> to see if the password is hard-coded as an <abbr title="American Standard Code for Information Interchange">ASCII</abbr> string</div>
</li>
<li class="level1"><div class="li"> Using <code>objdump</code> to see if the password is hard-coded as a set of instructions (e.g. copying characters into a buffer)</div>
</li>
<li class="level1"><div class="li"> Using Radare2 to get a user-readable disassembly of the program</div>
</li>
</ul>

<p>
Here&#039;s a short tutorial on using Radare2. We can analyze a binary using <code>r2 [binary_name]</code>, where <code>[binary_name]</code> is a given binary. To get online help, we can use the following commands:
</p>
<pre class="code">$ r2 even-password
[0x08048400]&gt; ?
Usage: [.][times][cmd][~grep][@[@iter]addr!size][|&gt;pipe] ; ...
Append &#039;?&#039; to any char command to get detailed help
...
[0x08048400]&gt; p? #provide help for p command
Usage: p[=68abcdDfiImrstuxz] [arg|len]
...</pre>

<p>
To disassemble the file, we can use the <code>pd</code> command, e.g.
</p>
<pre class="code">[0x08048400]&gt; pd@main 
            ;-- main:
            0x080484fd    55           push ebp
            0x080484fe    89e5         mov ebp, esp
            0x08048500    83e4f0       and esp, 0xfffffff0
            0x08048503    83ec20       sub esp, 0x20
            0x08048506    c7042400860. mov dword [esp], str.Enterpassword
            0x0804850d    e88efeffff   call 0x1080483a0
               0x080483a0(unk) ; sym.imp.printf
...</pre>

</div>
<!-- EDIT5 SECTION "1. even-password [1p]" [2612-4154] -->
<h2 class="sectionedit6" id="odd-password_2p">2. odd-password [2p]</h2>
<div class="level2">

<p>
Same as the previous task, only this time the password is a non-<abbr title="American Standard Code for Information Interchange">ASCII</abbr> string. The following approach should work:
</p>
<ol>
<li class="level1"><div class="li"> Disassemble the binary and look at <code>main</code>. What functions does it call?</div>
</li>
<li class="level1"><div class="li"> Once you have the program flow figured out, look at how the password checking is done and figure out the password.</div>
</li>
<li class="level1"><div class="li"> Use <code>python</code> or <code>perl</code> to output the string.</div>
</li>
</ol>

<p>
<strong>Note</strong>: You can use Radare2 to disassemble individual functions with the <code>pdf</code> command. You can also use it to output <a href="http://radare.org/y/?p=examples&amp;f=graph" class="urlextern" title="http://radare.org/y/?p=examples&amp;f=graph"  rel="nofollow">control flow graphs</a>, using the <code>ag</code> command.
</p>

<p>
<strong>Note</strong>: to output raw bytes, use the following snippets as reference:
</p>
<pre class="code">$ # python
$ python -c &#039;print &quot;\x02&quot;*20 + &quot;\x03&quot;&#039; # output 0x02 20 times, followed by 0x03 and a newline

$ # perl
$  perl -e &#039;print &quot;\x02&quot;x20 . &quot;\x03&quot;&#039; # output 0x02 20 times, followed by 0x03</pre>

<p>
For more complex strings, consider putting everything in a (Python or Perl) script.
</p>

</div>
<!-- EDIT6 SECTION "2. odd-password [2p]" [4155-5135] -->
<h2 class="sectionedit7" id="halting-problem_25p">3. halting-problem [2.5p]</h2>
<div class="level2">

<p>
Disassemble <code>halting-problem</code> and take a look at it:
</p>
<pre class="code">[0x08048330]&gt; af@main
[0x08048330]&gt; pdf@main
/ (fcn) sym.main 64
|           0x0804842d    55           push ebp
|           0x0804842e    89e5         mov ebp, esp
|           0x08048430    83e4f0       and esp, 0xfffffff0
|           0x08048433    83ec10       sub esp, 0x10
|           0x08048436    c7042400850. mov dword [esp], str.BrbImouttogetcookies.
|           ; CODE (CALL) XREF from 0x08048306 (fcn.08048306)
|           ; CODE (CALL) XREF from 0x08048300 (sym.imp.puts)
|           ; CODE (CALL) XREF from 0x08048326 (fcn.08048326)
|           0x0804843d    e8befeffff   call 0x108048300 ; (sym.imp.puts)
|              sym.imp.puts(unk)
|           0x08048442    c704241d850. mov dword [esp], str.Goingtohaltanytimenow...
|           0x08048449    e8b2feffff   call 0x108048300 ; (sym.imp.puts)
|              sym.imp.puts()
|           0x0804844e    c70424a0860. mov dword [esp], 0x186a0
|           ; CODE (CALL) XREF from 0x080482f0 (sym.imp.sleep)
|           0x08048455    e896feffff   call 0x1080482f0 ; (sym.imp.sleep)
|              sym.imp.sleep()
|           0x0804845a    c704243a850. mov dword [esp], str.Done
|           0x08048461    e89afeffff   call 0x108048300 ; (sym.imp.puts)
|              sym.imp.puts()
|           0x08048466    b800000000   mov eax, 0x0
|           0x0804846b    c9           leave
\           0x0804846c    c3           ret</pre>

<p>
Notice that it calls <code>sleep</code> with the value <code>0x186a0</code>:
</p>
<pre class="code">$ rax2 0x186a0
100000</pre>

<p>
Use a hex editor of your choice (Bless, HTE etc.) to edit the value to something more convenient. If you prefer using <code>vim</code>, then you can convert the current buffer to hex and back to binary. Load the executable in <code>vim</code>, then use the following:
</p>
<pre class="code">:%!xxd
&lt;edit stuff&gt;
:%!xxd -r</pre>

<p>
To find the code, you can search for the opcodes (use <code>pd 2@addr</code> and <code>px</code> to see the exact values).
</p>

</div>
<!-- EDIT7 SECTION "3. halting-problem [2.5p]" [5136-7125] -->
<h2 class="sectionedit8" id="straceme_2p">4. straceme [2p]</h2>
<div class="level2">

<p>
Use only dynamic analysis to figure out what <code>straceme</code> does. First <code>strace</code> it:
</p>
<pre class="code">$ strace ./straceme
...</pre>

<p>
It doesn&#039;t seem to be doing anything relevant, so let&#039;s run it in <code>gdb</code>. We use <code>layout asm</code> to display the current location in the assembly code, and <code>stepi</code>/<code>si</code> to step individual instruction.
</p>
<pre class="code">$ gdb ./straceme
(gdb) b main
(gdb) r
(gdb) layout asm
(gdb) stepi
&lt;repeat this a few times, to observe the program&#039;s control flow&gt;</pre>

<p>
If we run the program a couple of times, we observe that the condition for <code>cmpl $0x2,0x8(%ebp)</code> fails. Let&#039;s inspect that address:
</p>
<pre class="code">(gdb) x $ebp+0x8
0xffffd950:     0x00000001</pre>

<p>
The <code>ebp</code> register holds the base pointer for the current stack frame. We notice that <code>$ebp + 8</code> holds the value 1, while our program expects the value <code>2</code>. What is that value?
</p>

<p>
After figuring that out, run the program with <code>strace</code> again to determine the password.
</p>

</div>
<!-- EDIT8 SECTION "4. straceme [2p]" [7126-8103] -->
<h2 class="sectionedit9" id="guesser_25p">5. guesser [2.5p]</h2>
<div class="level2">

<p>
<code>guesser</code> reads an <code>unsigned int</code> from <code>/dev/urandom</code> and asks you to guess it.
</p>
<ol>
<li class="level1"><div class="li"> Disassemble the binary using <code>objdump</code> or Radare2 and examine its control flow.</div>
</li>
<li class="level1"><div class="li"> Run the binary using <code>gdb</code> and place a breakpoint after the <code>read</code> call.</div>
</li>
<li class="level1"><div class="li"> Inspect the memory location of the variable where the random value was placed by <code>read</code>. If in doubt, consult the <a href="http://www.gnu.org/software/gdb/documentation/" class="urlextern" title="http://www.gnu.org/software/gdb/documentation/"  rel="nofollow">GDB documentation</a> and the <a href="http://linux.die.net/man/2/read" class="urlextern" title="http://linux.die.net/man/2/read"  rel="nofollow">read (2) manpage</a>.</div>
</li>
<li class="level1"><div class="li"> Resume the program&#039;s execution and input the random value</div>
</li>
</ol>

</div>
<!-- EDIT9 SECTION "5. guesser [2.5p]" [8104-8702] -->
<h2 class="sectionedit10" id="extraarm_tasks_2p">6. Extra: ARM Tasks [2p]</h2>
<div class="level2">

<p>
Try the above tasks using the ARM binaries. For static analysis you can use Radare2 directly on the host machine. For the other tools (gdb, strace, objdump) you can use the QEMU setup described in the introduction.
</p>
<ol>
<li class="level1"><div class="li"> For scrolling in the QEMU VM you can use <code>Shift PageUp</code> and <code>Shift PageDown</code>.</div>
</li>
<li class="level1"><div class="li"> In order to copy the lab binaries in the QEMU machine, you can temporary mount and update the RPI image.</div>
</li>
</ol>
<pre class="code">$ file 2015-05-05-raspbian-wheezy.img
;; From the output of the file command, take the partition 2 &#039;startsector&#039;
;; value an multiply by 512, and use this figure as the offset value in the mount command below.
$ sudo mount 2015-05-05-raspbian-wheezy.img -o offset=62914560 /mnt
;; Add the tasks in the filesystem mounted in /mnt.
$ sudo umount 2015-05-05-raspbian-wheezy.img /mnt</pre>

</div>
<!-- EDIT10 SECTION "6. Extra: ARM Tasks [2p]" [8703-] --></div>
</body>
</html>
