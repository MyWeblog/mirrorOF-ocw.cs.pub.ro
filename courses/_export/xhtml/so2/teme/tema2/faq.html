    
    

<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <title>so2:teme:tema2:faq</title>
<meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="date" content="2013-03-30T22:50:44+0200"/>
<meta name="keywords" content="so2,teme,tema2,faq"/>
<link rel="search" type="application/opensearchdescription+xml" href="../../../../../lib/exe/opensearch.php" title="CS Open CourseWare"/>
<link rel="start" href="../../../../../../courses.1.html"/>
<link rel="alternate" type="application/rss+xml" title="Recent Changes" href="../../../../../feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Current Namespace" href="../../../../../feed.php%3Fmode=list&amp;ns=so2:teme:tema2"/>
<link rel="alternate" type="text/html" title="Plain HTML" href="faq.html"/>
<link rel="canonical" href="../../../../../so2/teme/tema2/faq.html"/>
<link rel="stylesheet" type="text/css" href="../../../../../lib/exe/css.php%3Ft=arctic&amp;tseed=1479898000.css"/>
<script type="text/javascript">/*<![CDATA[*/var NS='so2:teme:tema2';var JSINFO = {"id":"so2:teme:tema2:faq","namespace":"so2:teme:tema2","isadmin":0,"isauth":0};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../../../../../lib/exe/js.php%3Ftseed=1479898000"></script>
<script type="text/x-mathjax-config">/*<![CDATA[*/MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ["$","$"], ["\\(","\\)"] ],
        displayMath: [ ["$$","$$"], ["\\[","\\]"] ],
        processEscapes: true
    }
});
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
<script type="text/javascript">/*<![CDATA[*/
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
		  
/*!]]>*/</script>
<script type="text/javascript">/*<![CDATA[*/
var pageTracker = _gat._getTracker("UA-38383934-1");
pageTracker._initData();
pageTracker._trackPageview();
		  
/*!]]>*/</script>
</head>
<body>
<div class="dokuwiki export">
<!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle">Table of Contents</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="faq.html#faq_pentru_tema_2">FAQ pentru Tema 2</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="faq.html#intrebari_generale">Întrebări generale</a></div>
<ul class="toc">
<li class="level3"><div class="li"><a href="faq.html#treaba_cu_com1_si_com2">1 - Treaba cu COM1 și COM2</a></div></li>
<li class="level3"><div class="li"><a href="faq.html#functii_blocante">2 - Funcții blocante</a></div></li>
<li class="level3"><div class="li"><a href="faq.html#doua_buffere">3 - Două buffere</a></div></li>
<li class="level3"><div class="li"><a href="faq.html#intreruperile_se_opresc">4 - Întreruperile se opresc</a></div></li>
</ul>
</li>
<li class="level2"><div class="li"><a href="faq.html#intrebari_specifice_linux">Întrebări specifice Linux</a></div>
<ul class="toc">
<li class="level3"><div class="li"><a href="faq.html#un_handler_pentru_doua_intreruperi">1 - Un handler pentru două întreruperi</a></div></li>
<li class="level3"><div class="li"><a href="faq.html#aflarea_adresei_de_baza">2 - Aflarea adresei de bază</a></div></li>
<li class="level3"><div class="li"><a href="faq.html#legatura_intre_readwrite_si_intreruperi">3 - Legătura între read/write și întreruperi</a></div></li>
<li class="level3"><div class="li"><a href="faq.html#buffer_circular">4 - Buffer circular</a></div></li>
</ul>
</li>
<li class="level2"><div class="li"><a href="faq.html#intrebari_specifice_windows">Întrebări specifice Windows</a></div>
<ul class="toc">
<li class="level3"><div class="li"><a href="faq.html#kesetevent_in_intrerupere">1 - KeSetEvent în întrerupere</a></div></li>
<li class="level3"><div class="li"><a href="faq.html#acpi">2 - ACPI</a></div></li>
<li class="level3"><div class="li"><a href="faq.html#dezactivare_com1_com2">3 - Dezactivare COM1 &amp; COM2</a></div></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<!-- TOC END -->

<h1 class="sectionedit1" id="faq_pentru_tema_2">FAQ pentru Tema 2</h1>
<div class="level1">

</div>
<!-- EDIT1 SECTION "FAQ pentru Tema 2" [1-32] -->
<h2 class="sectionedit2" id="intrebari_generale">Întrebări generale</h2>
<div class="level2">

</div>
<!-- EDIT2 SECTION "Întrebări generale" [33-66] -->
<h3 class="sectionedit3" id="treaba_cu_com1_si_com2">1 - Treaba cu COM1 și COM2</h3>
<div class="level3">

<p>
<a href="http://cursuri.cs.pub.ro/lurker/message/20070409.085228.ec1e8544.en.html" class="urlextern" title="http://cursuri.cs.pub.ro/lurker/message/20070409.085228.ec1e8544.en.html"  rel="nofollow"> Context</a>
</p>

<p>
<img src="../../../../../lib/images/smileys/icon_question.gif" class="icon" alt=":?:" /> Ce treabă are COM1 cu COM2?
</p>

<p>
<img src="../../../../../lib/images/smileys/icon_exclaim.gif" class="icon" alt=":!:" /> COM1 și COM2 sunt legate împreună printr-un pipe al mașinii virtuale. Un write pe COM1 va scrie date care vor ajunge pe COM2 (pentru read)
</p>

</div>
<!-- EDIT3 SECTION "1 - Treaba cu COM1 și COM2" [67-374] -->
<h3 class="sectionedit4" id="functii_blocante">2 - Funcții blocante</h3>
<div class="level3">

<p>
<a href="http://cursuri.cs.pub.ro/lurker/message/20070409.171859.803d4283.en.html" class="urlextern" title="http://cursuri.cs.pub.ro/lurker/message/20070409.171859.803d4283.en.html"  rel="nofollow"> Context </a>
</p>

<p>
<img src="../../../../../lib/images/smileys/icon_question.gif" class="icon" alt=":?:" /> Ce înseamnă că read și write trebuie să fie blocante?
</p>

<p>
<img src="../../../../../lib/images/smileys/icon_exclaim.gif" class="icon" alt=":!:" /> Read trebuie să se blocheze dacă nu există date citite de pe port(bufferul pentru read este gol) până când vin date, și write trebuie să se blocheze dacă nu ai spațiu de scris în bufferul de write până când se eliberează o parte din el prin scriere pe port. 
</p>

</div>
<!-- EDIT4 SECTION "2 - Funcții blocante" [375-840] -->
<h3 class="sectionedit5" id="doua_buffere">3 - Două buffere</h3>
<div class="level3">

<p>
<a href="http://cursuri.cs.pub.ro/lurker/message/20070409.171859.803d4283.en.html" class="urlextern" title="http://cursuri.cs.pub.ro/lurker/message/20070409.171859.803d4283.en.html"  rel="nofollow"> Context </a>
</p>

<p>
<img src="../../../../../lib/images/smileys/icon_question.gif" class="icon" alt=":?:" /> De ce am nevoie de două buffere, unul pentru read și unul pentru write?
</p>

<p>
<img src="../../../../../lib/images/smileys/icon_exclaim.gif" class="icon" alt=":!:" /> E nevoie de două buffere pentru fiecare device (deci 4 în total), având următoarele funcții:
</p>
<ul>
<li class="level1"><div class="li"> Bufferul pentru operația read: scrii în acest buffer datele primite pe portul serial (luate cu inb în handlerul de întrerupere) și le iei din acest buffer și le scrii în bufferul din userspace (în funcția <code>read</code> a device-ului).</div>
</li>
<li class="level1"><div class="li"> Bufferul pentru operatia write: scrii în el din bufferul din userspace (în funcția <code>write</code> a device-ului) și iei din el în handler-ul de întrerupere și scrii pe port (cu outb).</div>
</li>
</ul>

<p>
Nu se poate folosi același buffer pentru ambele operații având în vedere că se referă la date diferite, unul la datele scrise pe port și altul la datele citite de pe port, date care de obicei sunt diferite. Nu prea te interesează să citești de pe portul serial ce tocmai ai scris pe el, ci ce s-a scris la celălalt capăt. 
</p>

</div>
<!-- EDIT5 SECTION "3 - Două buffere" [841-1910] -->
<h3 class="sectionedit6" id="intreruperile_se_opresc">4 - Întreruperile se opresc</h3>
<div class="level3">

<p>
<a href="http://cursuri.cs.pub.ro/lurker/message/20040823.155105.42901b76.en.html" class="urlextern" title="http://cursuri.cs.pub.ro/lurker/message/20040823.155105.42901b76.en.html"  rel="nofollow"> Context </a>
</p>

<p>
<img src="../../../../../lib/images/smileys/icon_question.gif" class="icon" alt=":?:" /> Se generează doar una/câteva întreruperi apoi se opresc. Care ar fi motivul?
</p>

<p>
<img src="../../../../../lib/images/smileys/icon_exclaim.gif" class="icon" alt=":!:" /> În întrerupere trebuie neapărat să citești IIR, altfel nu se va genera ack pentru întreruperea în curs și nu o să mai primești întreruperi.
</p>

</div>
<!-- EDIT6 SECTION "4 - Întreruperile se opresc" [1911-2280] -->
<h2 class="sectionedit7" id="intrebari_specifice_linux">Întrebări specifice Linux</h2>
<div class="level2">

</div>
<!-- EDIT7 SECTION "Întrebări specifice Linux" [2281-2320] -->
<h3 class="sectionedit8" id="un_handler_pentru_doua_intreruperi">1 - Un handler pentru două întreruperi</h3>
<div class="level3">

<p>
<a href="http://cursuri.cs.pub.ro/lurker/message/20070413.104853.300f0d29.en.html" class="urlextern" title="http://cursuri.cs.pub.ro/lurker/message/20070413.104853.300f0d29.en.html"  rel="nofollow"> Context </a>
</p>

<p>
<img src="../../../../../lib/images/smileys/icon_question.gif" class="icon" alt=":?:" /> În handler-ul pentru intrerupere 
</p>
<pre class="code c">irqreturn_t my_handler<span class="br0">&#40;</span><span class="kw4">int</span> irq_no<span class="sy0">,</span><span class="kw4">void</span> <span class="sy0">*</span>dev_id<span class="sy0">,</span><span class="kw4">struct</span> pt_regs <span class="sy0">*</span>regs<span class="br0">&#41;</span></pre>

<p>
putem să folosim dev_id astfel încât să refere serial[0] și serial[1] ? 
serial [0] de exemplu este :
</p>
<pre class="code c">err <span class="sy0">=</span> request_irq<span class="br0">&#40;</span>MY_IRQ1<span class="sy0">,</span>my_handler<span class="sy0">,</span>SA_INTERRUPT<span class="sy0">,</span><span class="st0">&quot;uart16550&quot;</span><span class="sy0">,&amp;</span>serial<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>

<p>
<img src="../../../../../lib/images/smileys/icon_exclaim.gif" class="icon" alt=":!:" /> Poți să înregistrezi același handler pentru ambele întreruperi (și MY_IRQ1 și MY_IRQ2); spre exemplu:
</p>
<pre class="code c">request_irq<span class="br0">&#40;</span>MY_IRQ1<span class="sy0">,</span>my_handler<span class="sy0">,</span>SA_INTERRUPT<span class="sy0">,</span><span class="st0">&quot;uart16550&quot;</span><span class="sy0">,&amp;</span>my_serial<span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
request_irq<span class="br0">&#40;</span>MY_IRQ2<span class="sy0">,</span>my_handler<span class="sy0">,</span>SA_INTERRUPT<span class="sy0">,</span><span class="st0">&quot;uart16550&quot;</span><span class="sy0">,&amp;</span>my_serial<span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>

<p>
În acest caz membrul dev_id va fi &amp;my_serial[0] sau &amp;my_serial[1], după cum s-a transmis întreruperea MY_IRQ1 sau MY_IRQ2.
</p>

</div>
<!-- EDIT8 SECTION "1 - Un handler pentru două întreruperi" [2321-3184] -->
<h3 class="sectionedit9" id="aflarea_adresei_de_baza">2 - Aflarea adresei de bază</h3>
<div class="level3">

<p>
<a href="http://cursuri.cs.pub.ro/lurker/message/20070413.104853.300f0d29.en.html" class="urlextern" title="http://cursuri.cs.pub.ro/lurker/message/20070413.104853.300f0d29.en.html"  rel="nofollow"> Context </a>
</p>

<p>
<img src="../../../../../lib/images/smileys/icon_question.gif" class="icon" alt=":?:" /> Cum am putea afla pt ce COM este întreruperea (adresa mai exact , adică 0x3f8 sau 0x2f8),fără să citim registrul IIR? 
</p>

<p>
<img src="../../../../../lib/images/smileys/icon_exclaim.gif" class="icon" alt=":!:" /> Presupunând că ai înregistrat bine cele două întreruperi pentru același handler, 
</p>
<pre class="code c"><span class="kw1">if</span> <span class="br0">&#40;</span>irq_no <span class="sy0">==</span> MY_IRQ1<span class="br0">&#41;</span> <span class="br0">&#123;</span>
<span class="coMULTI">/* intrerupere COM1 -&gt; base_port = 0x3f8 */</span>
<span class="br0">&#125;</span>
<span class="kw1">else</span> <span class="br0">&#123;</span>
<span class="coMULTI">/* intrerupere COM2 -&gt; base_port = 0x2f8 */</span>
<span class="br0">&#125;</span> </pre>

<p>
O alternativă ar fi câmpul dev_id care să fie pointer la o structură specifică fiecărui COM, unde se va găsi și adresa de bază
</p>
<pre class="code c"><span class="kw4">struct</span> structura_mea <span class="sy0">*</span> sm <span class="sy0">=</span> <span class="br0">&#40;</span><span class="kw4">struct</span> structura_mea <span class="sy0">*</span><span class="br0">&#41;</span> dev_id<span class="sy0">;</span>
sm<span class="sy0">-&gt;</span>base<span class="sy0">;</span></pre>

</div>
<!-- EDIT9 SECTION "2 - Aflarea adresei de bază" [3185-3903] -->
<h3 class="sectionedit10" id="legatura_intre_readwrite_si_intreruperi">3 - Legătura între read/write și întreruperi</h3>
<div class="level3">

<p>
<a href="http://cursuri.cs.pub.ro/lurker/message/20090403.231201.5eb2428d.en.html" class="urlextern" title="http://cursuri.cs.pub.ro/lurker/message/20090403.231201.5eb2428d.en.html"  rel="nofollow"> Context </a>
</p>

<p>
<img src="../../../../../lib/images/smileys/icon_question.gif" class="icon" alt=":?:" /> Din câte am înțeles, în write copiez din userspace într-un write buffer local. Write Bufferul este scris pe serial cu outb în handlerul de intrerupere. În read copiez în userspace dintr-un read buffer local. Read bufferul este umplut cu date primite pe serială(inb) în handlerul de întrerupere. Cum se leagă exact funcțiile de read și write de întrerupere? Mie îmi intră o singură dată în întrerupere la inițializarea modulului. 
</p>

<p>
<img src="../../../../../lib/images/smileys/icon_exclaim.gif" class="icon" alt=":!:" /> La sfârșitul fiecărei funcții write va trebui fie să reactivați întreruperile 
</p>
<pre class="code c">outb<span class="br0">&#40;</span><span class="nu12">0x00</span><span class="sy0">,</span> IER<span class="br0">&#41;</span><span class="sy0">;</span> outb <span class="br0">&#40;</span><span class="nu12">0x03</span><span class="sy0">,</span> IER<span class="br0">&#41;</span><span class="sy0">;</span></pre>

<p>
 fie activați întreruperea de empty buffer doar când există ceva în buffer-ul device-ului de scris.
</p>

</div>
<!-- EDIT10 SECTION "3 - Legătura între read/write și întreruperi" [3904-4753] -->
<h3 class="sectionedit11" id="buffer_circular">4 - Buffer circular</h3>
<div class="level3">

<p>
<a href="http://cursuri.cs.pub.ro/lurker/message/20100209.175807.e1d4fe9b.en.html" class="urlextern" title="http://cursuri.cs.pub.ro/lurker/message/20100209.175807.e1d4fe9b.en.html"  rel="nofollow"> Context </a>
</p>

<p>
<img src="../../../../../lib/images/smileys/icon_question.gif" class="icon" alt=":?:" /> Există vreo implementare de buffer circular în Linux?
</p>

<p>
<img src="../../../../../lib/images/smileys/icon_exclaim.gif" class="icon" alt=":!:" /> Da, detalii găsiți în <a href="http://lwn.net/Articles/347619/" class="urlextern" title="http://lwn.net/Articles/347619/"  rel="nofollow"> următorul articol LWN</a>
</p>

</div>
<!-- EDIT11 SECTION "4 - Buffer circular" [4754-5026] -->
<h2 class="sectionedit12" id="intrebari_specifice_windows">Întrebări specifice Windows</h2>
<div class="level2">

</div>
<!-- EDIT12 SECTION "Întrebări specifice Windows" [5027-5069] -->
<h3 class="sectionedit13" id="kesetevent_in_intrerupere">1 - KeSetEvent în întrerupere</h3>
<div class="level3">

<p>
<a href="http://cursuri.cs.pub.ro/lurker/message/20080425.094835.6a48d122.en.html" class="urlextern" title="http://cursuri.cs.pub.ro/lurker/message/20080425.094835.6a48d122.en.html"  rel="nofollow"> Context </a>
</p>

<p>
<img src="../../../../../lib/images/smileys/icon_question.gif" class="icon" alt=":?:" /> Se poate apela <code>KeSetEvent</code> din handlerul întreruperii ? 
</p>

<p>
<img src="../../../../../lib/images/smileys/icon_exclaim.gif" class="icon" alt=":!:" /> NU. Din <a href="http://www.osronline.com/DDKx/kmarch/k105_1prm.htm" class="urlextern" title="http://www.osronline.com/DDKx/kmarch/k105_1prm.htm"  rel="nofollow"> documentația KeSetEvent</a>: the caller can be running at <code>IRQL ⇐ DISPATCH_LEVEL</code>. Nu puteți folosi <code>KeSetEvent</code> dintr-un handler de întrerupere. Va trebui să planificați un DPC pentru acest lucru. Mai multe detalii despre IRQL puteți afla <a href="http://ext2fsd.sourceforge.net/documents/irql.htm" class="urlextern" title="http://ext2fsd.sourceforge.net/documents/irql.htm"  rel="nofollow"> aici </a>.
</p>

</div>
<!-- EDIT13 SECTION "1 - KeSetEvent în întrerupere" [5070-5648] -->
<h3 class="sectionedit14" id="acpi">2 - ACPI</h3>
<div class="level3">

<p>
<img src="../../../../../lib/images/smileys/icon_question.gif" class="icon" alt=":?:" /> Cum dezactivez ACPI?
</p>

<p>
<img src="../../../../../lib/images/smileys/icon_exclaim.gif" class="icon" alt=":!:" /> Go to Device Manager (Right Click on MyComputer → Properties → Hardware). Under Computer entry, right click on Standard PC → Disable)
</p>

</div>
<!-- EDIT14 SECTION "2 - ACPI" [5649-5836] -->
<h3 class="sectionedit15" id="dezactivare_com1_com2">3 - Dezactivare COM1 &amp; COM2</h3>
<div class="level3">

<p>
<img src="../../../../../lib/images/smileys/icon_question.gif" class="icon" alt=":?:" /> Cum dezactivez COM1 &amp; COM2?
</p>

<p>
<img src="../../../../../lib/images/smileys/icon_exclaim.gif" class="icon" alt=":!:" /> Go to Device Manager (Right Click on MyComputer → Properties → Hardware). Under Ports (COM &amp; LPT) entry, right click on COM1/COM2  → Disable)
</p>

</div>
<!-- EDIT15 SECTION "3 - Dezactivare COM1 & COM2" [5837-] --></div>
</body>
</html>
