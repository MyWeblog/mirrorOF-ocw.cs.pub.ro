    
    

<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <title>so2:laboratoare:lab_compilare</title>
<meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="date" content="2013-05-24T13:38:52+0300"/>
<meta name="keywords" content="so2,laboratoare,lab_compilare"/>
<link rel="search" type="application/opensearchdescription+xml" href="../../../../lib/exe/opensearch.php" title="CS Open CourseWare"/>
<link rel="start" href="../../../../../courses.1.html"/>
<link rel="alternate" type="application/rss+xml" title="Recent Changes" href="../../../../feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Current Namespace" href="../../../../feed.php%3Fmode=list&amp;ns=so2:laboratoare"/>
<link rel="alternate" type="text/html" title="Plain HTML" href="lab_compilare.html"/>
<link rel="canonical" href="../../../../so2/laboratoare/lab_compilare.html"/>
<link rel="stylesheet" type="text/css" href="../../../../lib/exe/css.php%3Ft=arctic&amp;tseed=1476798676.css"/>
<script type="text/javascript">/*<![CDATA[*/var NS='so2:laboratoare';var JSINFO = {"id":"so2:laboratoare:lab_compilare","namespace":"so2:laboratoare","isadmin":0,"isauth":0};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../../../../lib/exe/js.php%3Ftseed=1476798676"></script>
<script type="text/x-mathjax-config">/*<![CDATA[*/MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ["$","$"], ["\\(","\\)"] ],
        displayMath: [ ["$$","$$"], ["\\[","\\]"] ],
        processEscapes: true
    }
});
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
<script type="text/javascript">/*<![CDATA[*/
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
		  
/*!]]>*/</script>
<script type="text/javascript">/*<![CDATA[*/
var pageTracker = _gat._getTracker("UA-38383934-1");
pageTracker._initData();
pageTracker._trackPageview();
		  
/*!]]>*/</script>
</head>
<body>
<div class="dokuwiki export">
<!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle">Table of Contents</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="lab_compilare.html#laborator_extra_-_compilarea_kernel-ului">Laborator Extra - Compilarea kernel-ului</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="lab_compilare.html#compilarea_kernel-ului_linux">Compilarea kernel-ului Linux</a></div>
<ul class="toc">
<li class="level3"><div class="li"><a href="lab_compilare.html#pregatire">Pregătire</a></div></li>
<li class="level3"><div class="li"><a href="lab_compilare.html#cerinte_hardware_si_software">Cerințe hardware și software</a></div></li>
<li class="level3"><div class="li"><a href="lab_compilare.html#ce_hardware_exista_in_sistem">Ce hardware există în sistem?</a></div></li>
<li class="level3"><div class="li"><a href="lab_compilare.html#obtinerea_surselor">Obținerea surselor</a></div></li>
<li class="level3"><div class="li"><a href="lab_compilare.html#configurare">Configurare</a></div></li>
<li class="level3"><div class="li"><a href="lab_compilare.html#initrd_-_ramdisk-ul_initial">initrd - ramdisk-ul inițial</a></div></li>
<li class="level3"><div class="li"><a href="lab_compilare.html#re_denumirea_versiunii_de_kernel">(re)denumirea versiunii de kernel</a></div></li>
<li class="level3"><div class="li"><a href="lab_compilare.html#compilare">Compilare</a></div></li>
<li class="level3"><div class="li"><a href="lab_compilare.html#instalare">Instalare</a></div></li>
<li class="level3"><div class="li"><a href="lab_compilare.html#instalare_imagine_kernel">Instalare imagine kernel</a></div></li>
<li class="level3"><div class="li"><a href="lab_compilare.html#instalare_module_de_kernel">Instalare module de kernel</a></div></li>
<li class="level3"><div class="li"><a href="lab_compilare.html#configurare_grub">Configurare GRUB</a></div></li>
<li class="level3"><div class="li"><a href="lab_compilare.html#repornire_sistem">Repornire sistem</a></div></li>
<li class="level3"><div class="li"><a href="lab_compilare.html#link-uri">Link-uri</a></div></li>
</ul>
</li>
<li class="level2"><div class="li"><a href="lab_compilare.html#compilarea_kernel-ului_windows">Compilarea kernel-ului Windows</a></div>
<ul class="toc">
<li class="level3"><div class="li"><a href="lab_compilare.html#compilare1">Compilare</a></div></li>
<li class="level3"><div class="li"><a href="lab_compilare.html#instalare1">Instalare</a></div></li>
<li class="level3"><div class="li"><a href="lab_compilare.html#configurare_bootini">Configurare boot.ini</a></div></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<!-- TOC END -->

<h1 class="sectionedit1" id="laborator_extra_-_compilarea_kernel-ului">Laborator Extra - Compilarea kernel-ului</h1>
<div class="level1">

</div>
<!-- EDIT1 SECTION "Laborator Extra - Compilarea kernel-ului" [1-56] -->
<h2 class="sectionedit2" id="compilarea_kernel-ului_linux">Compilarea kernel-ului Linux</h2>
<div class="level2">

<p>
Principalul motiv pentru care se dorește compilarea kernel-ului este adaptarea acestuia la un anumit sistem cu scopul creșterii performanțelor, adaptare care de obicei constă în:
</p>
<ul>
<li class="level1"><div class="li">utilizarea unor opțiuni de compilare prin care arhitectura procesorului este folosită la maxim (ex: alegerea tipului de procesor - implicit se folosește un procesor generic gen i386)</div>
</li>
<li class="level1"><div class="li">activarea/dezactivarea suportului pentru anumite componente hardware sau software (ex: selectarea anumitor driver-e, selectarea unor anumite protocoale de comunicatie)</div>
</li>
</ul>

<p>
În cazul kernel-ului Linux, suportul pentru hardware/software poate să fie:
</p>
<ul>
<li class="level1"><div class="li"><strong>built-in</strong> - suportul este inclus direct în imaginea (fisierul) kernel-ului</div>
</li>
<li class="level1"><div class="li">sub forma de <strong>module de kernel</strong> - suportul se găsește în fișiere separate care se încarcă on-demand</div>
</li>
</ul>

<p>
Deși adăugarea funcționalităților în kernel poate duce la creșterea eficienței în anumite subsisteme,  acest lucru poate avea ca și consecință îngreunarea sistemului în ansamblu (bloated), lucru nerecomandat.
</p>

<p>
Majoritatea distribuțiilor includ în kernel numai suportul pentru componentele critice, fără de care sistemul de operare nu poate funcționa. Restul componentelor sunt compilate sub forma de module, module care sunt încărcate în funcție de hardware-ul/necesitățile fiecărui sistem/utilizator. 
</p>

<p>
Există și situații în care kernel-ul care vine cu o anumită distribuție este mai vechi sau nu are compilat suportul pentru o anumită componentă. De asemenea, compilarea unui kernel optimizat este des întalnită pe sistemele care ruleaza server-e unde se dorește exploatarea la maxim a resurselor sistemului.
</p>

<p>
Pentru a putea efectua modificări de tipul celor mentionate mai sus, trebuie inițial efectuată configurarea kernel-ului. După această etapă se poate porni compilarea kernel-ului și a modulelor de kernel.
</p>

</div>
<!-- EDIT2 SECTION "Compilarea kernel-ului Linux" [57-1975] -->
<h3 class="sectionedit3" id="pregatire">Pregătire</h3>
<div class="level3">

</div>
<!-- EDIT3 SECTION "Pregătire" [1976-1997] -->
<h3 class="sectionedit4" id="cerinte_hardware_si_software">Cerințe hardware și software</h3>
<div class="level3">

<p>
Înaintea compilării kernel-ului trebuie verificat dacă sistemul satisface cerințele hardware și software.
</p>

<p>
Din punct de vedere hardware:
</p>
<ul>
<li class="level1"><div class="li">deși un sistem Linux minimal poate rula în sisteme cu puțină memorie RAM, cerințele minime pentru o distribuție Linux, în momentul de față, variază în jurul valorilor de 128-256 <abbr title="Megabyte">MB</abbr> RAM.</div>
</li>
<li class="level1"><div class="li">în funcție de opțiunile alese pentru compilare, spațiul ocupat pe disc poate depăși valoarea de 500 <abbr title="Megabyte">MB</abbr> - în aceste condiții, se recomandă un minim de 1 <abbr title="Gigabyte">GB</abbr> liber pe hard-disk-ul pe care se realizează compilarea.</div>
</li>
</ul>

<p>
Timpul de compilare variază în funcție de numărul de componente activate pentru compilare în momentul configurării.
</p>

<p>
Compilarea se poate realiza pe un sistem mai puternic urmând ca apoi să se mute pachetul ce conține kernel-ul pe sistemul destinație.
</p>

<p>
Cerințele software pentru kernel-ul de compilat se găsesc precizate în fișierul <a href="http://koala.cs.pub.ro/lxr/linux26/Documentation/Changes" class="urlextern" title="http://koala.cs.pub.ro/lxr/linux26/Documentation/Changes"  rel="nofollow">Documentation/Changes</a> din cadrul surselor:
</p>
<pre class="code">o  Gnu C                  3.2                     # gcc --version
o  Gnu make               3.79.1                  # make --version
o  binutils               2.12                    # ld -v
o  util-linux             2.10o                   # fdformat --version
o  module-init-tools      0.9.10                  # depmod -V
o  e2fsprogs              1.29                    # tune2fs
o  jfsutils               1.1.3                   # fsck.jfs -V
o  reiserfsprogs          3.6.3                   # reiserfsck -V 2&gt;&amp;1|grep reiserfsprogs
o  xfsprogs               2.6.0                   # xfs_db -V
o  pcmciautils            004                     # pccardctl -V
o  quota-tools            3.09                    # quota -V
o  PPP                    2.4.0                   # pppd --version
o  isdn4k-utils           3.1pre1                 # isdnctrl 2&gt;&amp;1|grep version
o  nfs-utils              1.0.5                   # showmount --version
o  procps                 3.2.0                   # ps --version
o  oprofile               0.9                     # oprofiled --version
o  udev                   081                     # udevinfo -V
o  grub                   0.93                    # grub --version</pre>

<p>
Observații:
</p>
<ul>
<li class="level1"><div class="li">cerințele de mai sus sunt valabile pentru versiunea de kernel 2.6.31.6.</div>
</li>
<li class="level1"><div class="li">utilitarele <code>e2fsprogs</code>, <code>jfsutils</code>, <code>reiserfsprogs</code>, <code>xfsprogs</code> sunt folosite pentru sistemul de fișiere asociat</div>
</li>
<li class="level1"><div class="li"><code>PPP</code> și <code>isdn4k-utils</code> sunt necesare numai dacă legăturile sistemului la Internet sunt de tip PPP sau ISDN.</div>
</li>
</ul>

</div>
<!-- EDIT4 SECTION "Cerințe hardware și software" [1998-4620] -->
<h3 class="sectionedit5" id="ce_hardware_exista_in_sistem">Ce hardware există în sistem?</h3>
<div class="level3">

<p>
Un kernel compilat poate oferi suport doar pentru hardware-ul utilizatorului, micșorând astfel dimensiunea imaginii obținute. De asemenea, cunoașterea hardware-ului în sistem este necesară pentru un kernel mai rapid și alegerea opțiunilor de compilare și a driver-elor de dispozitiv corecte.
Informații despre controller-ele Ethernet, VGA, placa de sunet se află cu ajutorul comenzii <code>lspci</code> (din pachetul <code>pciutils</code>):
</p>
<pre class="code"># lspci
00:00.0 Host bridge: VIA Technologies, Inc. K8M800 Host Bridge
00:00.1 Host bridge: VIA Technologies, Inc. K8M800 Host Bridge
00:00.2 Host bridge: VIA Technologies, Inc. K8M800 Host Bridge
00:00.3 Host bridge: VIA Technologies, Inc. K8M800 Host Bridge
00:00.4 Host bridge: VIA Technologies, Inc. K8M800 Host Bridge
00:00.7 Host bridge: VIA Technologies, Inc. K8M800 Host Bridge
00:01.0 PCI bridge: VIA Technologies, Inc. VT8237 PCI bridge [K8T800/K8T890 South]
00:0a.0 Ethernet controller: Linksys, A Division of Cisco Systems [AirConn] ...</pre>

<p>
Tipul procesorului se află cu ajutorul <code>procfs</code> (montat în <code>/proc</code>).
</p>
<pre class="code"># cat /proc/cpuinfo
processor       : 0
vendor_id       : AuthenticAMD
cpu family      : 15
model           : 28
model name      : Mobile AMD Sempron(tm) Processor 2800+
stepping        : 0
cpu MHz         : 1601.122
cache size      : 256 KB
fdiv_bug        : no
hlt_bug         : no
f00f_bug        : no
coma_bug        : no
fpu             : yes
fpu_exception   : yes
cpuid level     : 1
wp              : yes
flags           : fpu vme de pse tsc msr pae mce cx8 apic sep mtrr ...
bogomips        : 3205.53</pre>

</div>
<!-- EDIT5 SECTION "Ce hardware există în sistem?" [4621-6264] -->
<h3 class="sectionedit6" id="obtinerea_surselor">Obținerea surselor</h3>
<div class="level3">

<p>
Sursele de kernel de Linux pot fi obținute din pachete specifice distribuției sau pot fi descărcate sursele <a href="http://www.kernel.org" class="urlextern" title="http://www.kernel.org"  rel="nofollow">oficiale</a> ale lui <a href="http://en.wikipedia.org/wiki/Linus_Torvalds" class="urlextern" title="http://en.wikipedia.org/wiki/Linus_Torvalds"  rel="nofollow">Linus Torvalds</a>.
</p>

<p>
În cazul în care se alege varianta folosirii surselor oficiale, se recomandă folosirea unui <a href="http://mirrors.kernel.org/" class="urlextern" title="http://mirrors.kernel.org/"  rel="nofollow">mirror</a> din <a href="http://www.kernel.org/mirrors/countries/html/RO.html" class="urlextern" title="http://www.kernel.org/mirrors/countries/html/RO.html"  rel="nofollow">Romania</a>.
</p>

<p>
Sursele kernel-ului se găsesc în subdirectorul <code>/pub/linux/kernel/v2.6</code> (pentru versiunea 2.6). Se poate folosi http sau ftp pentru obținerea surselor:
</p>
<pre class="code"># cd /usr/src
# wget ftp://ftp.idilis.lkams.kernel.org/pub/linux/kernel/v2.6/linux-2.6.24.2.tar.gz</pre>

<p>
Se dezarhivează sursele. Se recomandă crearea unei legături simbolice cu numele <code>linux</code> către directorul ce contine sursele.
</p>
<pre class="code"># cd /usr/src
# tar xzf linux-2.6.24.2.tar.gz
# ln -s linux-2.6.24.2 linux
# ls -l
total 40924
lrwxrwxrwx  1 root src        14 2008-02-19 13:52 linux -&gt; linux-2.6.24.2
drwxrwxrwx 19 root root     4096 2008-02-16 19:21 linux-2.6.24.2
-rw-r--r--  1 root src  41853865 2008-02-16 19:28 linux-2.6.24.2.tar.gz</pre>

<p>
Kernel-ul compilat de pe <a href="http://elf.cs.pub.ro/so/vm/" class="urlextern" title="http://elf.cs.pub.ro/so/vm/"  rel="nofollow">mașina virtuală de Linux disponibilă</a> este un kernel versiunea 2.6.31.6.
</p>

</div>
<!-- EDIT6 SECTION "Obținerea surselor" [6265-7578] -->
<h3 class="sectionedit7" id="configurare">Configurare</h3>
<div class="level3">

<p>
Partea de configurare este partea cea mai importantă a procesului de compilare. În cadrul acesteia se decide ce caracteristici vor fi incluse în noul kernel; sunt necesare cunoștințe ale hardware-ului sistemului și ale facilităților dorite.
</p>

<p>
Procesul de configurare era unul destul de dificil de realizat la primele versiuni, însa acest lucru s-a schimbat odată cu introducerea unor interfețe care folosesc X Window sau ncurses.
Pentru verificarea opțiunilor posibile de compilare se poate rula comanda:
</p>
<pre class="code"># make help
Cleaning targets:
  clean           - remove most generated files but keep the config
  mrproper        - remove all generated files + config + various backup files

Configuration targets:
  config          - Update current config utilising a line-oriented program
  menuconfig      - Update current config utilising a menu based program
  xconfig         - Update current config utilising a QT based front-end
  gconfig         - Update current config utilising a GTK based front-end
  oldconfig       - Update current config utilising a provided .config as base
  randconfig      - New config with random answer to all options
  defconfig       - New config with default answer to all options
  allmodconfig    - New config selecting modules when possible
  allyesconfig    - New config where all options are accepted with yes
  allnoconfig     - New config where all options are answered with no
  ...</pre>

<p>
Pentru utilizarea unei interfețe text-based (ncurses), va trebui instalat pachetul <code>libncurses-dev</code>. Pentru utilizarea unei interfețe folosind front-end GTK (de obicei într-un desktop environment GNOME) vor trebui instalate pachetele <code>libgtk2.0-dev</code> și <code>libglade2.0-dev</code>. Pentru QT va trebui instalat pachetul <code>libqt4-dev</code>.
</p>

<p>
Avantajul folosirii interfetei ncurses este faptul că este relativ ușor de utilizat și nu necesită prezenta unui mediu grafic.
</p>

<p>
În cazul în care sursele conțineau o configurație anterioară care nu mai este dorită, va trebui rulată una dintre comenzile:
</p>
<pre class="code"># make clean
# make mrproper</pre>

<p>
Rularea uneia dintre comenzile:
</p>
<pre class="code"># make menuconfig
# make gconfig
# make xconfig</pre>

<p>
rezultă în afișarea unui meniu. Acesta conține mai multe intrări de configurare (<code>General setup</code>, <code>Networking</code>, <code>Device drivers</code>, <code>File systems</code>, etc.) care pot fi utilizate pentru configurări ale unui subdomeniu. Acestea pot conține, la rândul lor, alte subdomenii de configurare.
</p>

<p>
O opțiune finită de configurare (spre exemplu <code>Device Drivers → Block Devices → Normal floppy disk support</code>) poate prezenta utilizatorului trei optiuni de configurare:
</p>
<ul>
<li class="level1"><div class="li">absența completă din kernel-ul finit (se apasa <code>&lt;N&gt;</code>)</div>
</li>
<li class="level1"><div class="li">compilarea acesteia în cadrul imaginii de kernel (<strong>built-in</strong>) (se apasa <code>&lt;Y&gt;</code>)</div>
</li>
<li class="level1"><div class="li">compilarea acesteia sub forma de <strong>modul de kernel</strong> (se apasa <code>&lt;M&gt;</code>)</div>
</li>
</ul>

<p>
Compilarea <strong>built-in</strong> înseamnă introducerea codului obiect asociat opțiunii în imaginea de kernel care va rezulta. Compilarea în forma de <strong>modul de kernel</strong> înseamnă că pentru activarea acelei facilități, kernel-ul va încărca modulul (codul obiect asociat) și îl va descărca atunci când nu are nevoie de el. Kernel-ul este astfel extensibil și pentru adăugarea anumitor facilități nu este nevoie de recompilare. Pentru lucrul cu module de kernel vor trebui adăugate opțiunile din Loadable module support (<code>Enable loadable module support</code>).
</p>

<p>
Multe opțiuni nu vor fi încorporate în cadrul kernel-ului întrucât nu sunt necesare. Altele pot fi compilate numai <strong>built-in</strong>. Opțiunile care suportă varianta <strong>modul de kernel</strong> sau <strong>built-in</strong> se recomandă a fi compilate ca <strong>module de kernel</strong> pentru a fi încărcate la nevoie. Pe procesoarele moderne, timpul în care se încarcă/descarcă module este suficient de mic încat compilarea ca <strong>modul de kernel</strong> sau <strong>built-in</strong> să nu afecteze performanța.
</p>

<p>
O opțiune utilă este precizarea unei versiuni locale pentru kernel, astfel încât acesta să fie identificat; exista posibilitatea compilării aceleiași versiuni de kernel pentru scopuri distincte; oferirea unei versiuni locale generează o versiune de kernel unică.
</p>

<p>
Precizarea tipului de procesor și a arhitecturii este un pas necesar pentru a crea un kernel eficient. Majoritatea opțiunilor țin de preferințele utilizatorilor (desi probabil multi vor alege suport de networking, sunet etc.) sau de hardware-ul existent.
</p>

<p>
Dacă se dorește crearea unui kernel pentru dezvoltare (development) atunci vor trebui activate opțiunile din <code>Kernel hacking</code>; acestea oferă informații de debug suplimentare, cu dezavantajul unui kernel mai mare și mai lent.
</p>

<p>
Configurația este salvată în cadrul fișierului <code>.config</code> din directorul rădăcină al surselor. Este indicat să se realizeze un backup al acestui fișier înainte de configurare pentru a avea o configurație sigură la care să se revină în cazul apariției de probleme.
</p>

</div>
<!-- EDIT7 SECTION "Configurare" [7579-12586] -->
<h3 class="sectionedit8" id="initrd_-_ramdisk-ul_initial">initrd - ramdisk-ul inițial</h3>
<div class="level3">

<p>
<strong>initrd</strong> (initial ramdisk) este un sistem de fișiere temporar având ca suport memoria RAM (ramdisk) care este folosit la pornirea sistemului (booting). Initrd este folosit pentru a încărca driver-ele necesare încărcării sistemului de fișiere rădăcina.
</p>

<p>
Motivația folosirii initrd este flexibilitatea. Distributiile Linux au un kernel generic Linux care trebuie să boot-eze de pe sisteme cu hardware diferit. Kernel-ul inclus trebuie să fie modular, nefiind posibilă compilarea statică a tuturor opțiunilor fără a mări semnificativ imaginea kernel-ului. Este, în consecinta, necesar să se cunoască la booting locația sistemului de fișiere rădăcină și ce driver-e vor trebui încărcate în kernel. Această problemă este rezolvată prin introducerea initrd ca pas intermediar în pasul de boot-ing. Acesta actioneaza ca un sistem de fisiere rădăcină temporar. Conținutul acestui sistem rădăcină este dat de imaginea de initrd.
</p>

<p>
De obicei, compilarea unui kernel pentru un sistem dat nu necesită utilizarea initrd, deoarece se cunoaste hardware-ul existent și sistemul de fisiere utilizat. Pentru a se evita utilizarea initrd, vor trebui compilate în imaginea de kernel (<strong>built-in</strong>) driver-ele de hard-disk, SCSI (dacă există) și de sisteme de fișiere. Daca aceste driver-e ar fi compilate ca module atunci ar trebui încărcate de pe hard-disk, făra însă a putea accesa hard-disk-ul (din lipsa driver-elor). În această situație se foloseste initrd. Driver-ele în cauză se găsesc în:
</p>
<ul>
<li class="level1"><div class="li"><code>Device Drivers → ATA/ATAPI/MFM/RLL support</code> - de obicei trebuie compilate <strong>built-in</strong> driverele IDE specifice hardware-ului folosit pentru a putea beneficia de modurile Ultra DMA. Daca nu, se pot pune driverele generice (<code>generic/default IDE chipset support</code> și <code>Generic PCI IDE Chipset Support</code>)</div>
</li>
<li class="level1"><div class="li"><code>Device Drivers → SCSI device support</code></div>
</li>
<li class="level1"><div class="li"><code>File systems</code> (va trebui configurat ca <strong>built-in</strong> suportul pentru sistemul de fișiere rădăcină)</div>
</li>
</ul>

<p>
Pentru utilizarea initrd este necesar pachetul <code>initrd-tools</code>.
</p>

</div>
<!-- EDIT8 SECTION "initrd - ramdisk-ul inițial" [12587-14698] -->
<h3 class="sectionedit9" id="re_denumirea_versiunii_de_kernel">(re)denumirea versiunii de kernel</h3>
<div class="level3">

<p>
Înainte de compilare, este indicat să se creeze un indicator unic pentru imaginea de kernel creată. Aceasta se poate realiza completând campul EXTRAVERSION din Makefile-ul kernelului. Se poate seta acest camp la orice șir de caractere.
</p>

</div>
<!-- EDIT9 SECTION "(re)denumirea versiunii de kernel" [14699-14986] -->
<h3 class="sectionedit10" id="compilare">Compilare</h3>
<div class="level3">

<p>
Faza de compilare presupune <strong>obținerea</strong> imaginii de kernel și compilarea <strong>modulelor</strong> de kernel. Acest lucru se realizează prin intermediul a doua comenzi:
</p>
<pre class="code make"><span class="co1"># make bzImage</span>
<span class="co1"># make modules</span></pre>

<p>
Prima comandă creează o imagine de kernel comprimată. Acest pas poate dura de la câteva minute până la câteva zeci, depinzând de configurația hardware. După încheiere, imaginea comprimată se regasește în <code>arch/i386/boot/bzImage</code> (pentru o arhitectura x86).
</p>

<p>
A doua comandă compilează <strong>modulele</strong> care pot fi încărcate de kernel. Acest pas poate dura de câteva ori mai mult decât pasul precedent. Fișierele obiect ce reprezintă modulele (cu extensia <code>.ko</code>) rezidă în directoarele asociate, urmând a fi instalate.
</p>

</div>
<!-- EDIT10 SECTION "Compilare" [14987-15764] -->
<h3 class="sectionedit11" id="instalare">Instalare</h3>
<div class="level3">

<p>
Instalarea presupune copierea imaginii de kernel și a modulelor in locurile prevăzute și configurarea bootloader-ului pentru a boot-a noul kernel. Acest pas se leagă de directorul <code>/boot</code> unde se găsesc toate fișierele importante.
</p>

</div>
<!-- EDIT11 SECTION "Instalare" [15765-16025] -->
<h3 class="sectionedit12" id="instalare_imagine_kernel">Instalare imagine kernel</h3>
<div class="level3">

<p>
Imaginea de kernel și fișierele asociate sunt copiate în directoarele necesare cu ajutorul comenzii <code>make install</code>.
</p>

<p>
Pașii executați prin intermediul comenzii <code>make install</code> sunt detaliați mai jos.
</p>

<p>
Imaginea de kernel va trebui copiată în <code>/boot</code>:
</p>
<pre class="code bash"><span class="co0"># cd /usr/src/linux</span>
<span class="co0"># cp arch/x86/boot/bzImage /boot/vmlinuz-2.6.24.2mykernel</span></pre>

<p>
(șirul <em>mykernel</em> este folosit pentru identificarea imaginii de kernel; poate coincide cu versiunea locală precizată la configurare)
</p>

<p>
În plus față de imaginea de kernel, se recomandă copierea fișierului de configurare și a tabelei de simboluri.
</p>
<pre class="code bash"><span class="co0"># cd /usr/src/linux</span>
<span class="co0"># cp .config /boot/config-2.6.24.2mykernel</span>
<span class="co0"># cp System.map /boot/System.map-2.6.24.2mykernel</span></pre>

</div>
<!-- EDIT12 SECTION "Instalare imagine kernel" [16026-16814] -->
<h3 class="sectionedit13" id="instalare_module_de_kernel">Instalare module de kernel</h3>
<div class="level3">

<p>
Instalarea modulelor de kernel se realizează prin intermediul comenzii:
</p>
<pre class="code"># make modules_install</pre>

<p>
Modulele sunt instalate in <code>/lib/modules/2.6.24.2mykernel</code>.
</p>

<p>
Daca s-a configurat sistemul pentru a folosi <em>initrd</em>, va trebui creată imaginea de <em>ramdisk</em>. Pentru aceasta se ruleaza comanda:
</p>
<pre class="code"># cd /boot
# mkinitramfs -o /boot/initrd.img-2.6.24.2mykernel 2.6.24.2mykernel</pre>

<p>
Comanda va inspecta directorul <code>/lib/modules/2.6.24.2mykernel</code> si va crea imaginea de ramdisk corespunzatoare.
</p>

</div>
<!-- EDIT13 SECTION "Instalare module de kernel" [16815-17373] -->
<h3 class="sectionedit14" id="configurare_grub">Configurare GRUB</h3>
<div class="level3">

<p>
Dupa instalarea imaginii de kernel și a modulelor de kernel va trebui configurat bootloader-ul pentru a ști de unde să incarce imaginea la pornirea sistemului.
</p>

<p>
Vom presupune configurarea <a href="http://www.gnu.org/software/grub/" class="urlextern" title="http://www.gnu.org/software/grub/"  rel="nofollow">GRUB</a> (GRand Unified Bootloader), în detrimentul <a href="http://lilo.go.dyndns.org/" class="urlextern" title="http://lilo.go.dyndns.org/"  rel="nofollow">LILO</a> (LInux LOader), pentru că este mai răspăndit. Configurări pentru LILO se pot găsi și in <a href="lab_compilare.html#link-uri" title="so2:laboratoare:lab_compilare ↵" class="wikilink1">link-urile de mai jos</a>.
</p>

<p>
Există două versiuni majore de GRUB, 1 și 2. Mai departe ne vom ocupa de configurare GRUB2.
</p>

<p>
Pentru a adăuga o intrare în meniul GRUB-ului se editează fișierul <code>/etc/grub.d/40_custom</code> și apoi se rulează comanda:
</p>
<pre class="code"># update-grub</pre>

<p>
Un exemplu de configurare este prezentat în continuare:
</p>
<pre class="code">[...]

menuentry &quot;Linux&quot; {
    set root=(hd0,1)
    linux /boot/vmlinuz-2.6.24.2mykernel root=/dev/sda1
    initrd /boot/initrd.img-2.6.24.2mykernel
}
</pre>

<p>
Opțiunea initrd poate fi omisă în cazul în care nu s-a configurat un ramdisk inițial.
</p>

</div>
<!-- EDIT14 SECTION "Configurare GRUB" [17374-18417] -->
<h3 class="sectionedit15" id="repornire_sistem">Repornire sistem</h3>
<div class="level3">

<p>
Pentru rularea noului kernel, va trebui repornit sistemul și optat pentru noul kernel din meniul bootloader-ului. 
</p>

<p>
<strong>ATENTIE</strong>: Se recomandă păstrarea fostului kernel, în cazul în care apar probleme la noul kernel compilat. Probleme pot aparea din neincluderea driver-elor necesare în cazul în care nu se folosește initrd, omiterea driver-ului de sistem de fișiere necesar etc.
</p>

<p>
E posibil sa avem la dispoziție un kernel care ruleaza dar caruia ii lipsesc funcționalitați (de exemplu networking), pentru ca s-a omis compilarea driver-elor pentru placa de rețea. În acest caz se poate recompila kernel-ul pentru introducerea noilor funcționalități. Noua compilare va dura mai puțin în cazul în care modificările sunt minime.
</p>

<p>
O metoda de troubleshooting este compararea unei configurații functionale cu cea curentă prin inspecția fișierelor <code>.config</code> asociate.
</p>

</div>
<!-- EDIT15 SECTION "Repornire sistem" [18418-19333] -->
<h3 class="sectionedit16" id="link-uri">Link-uri</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"><a href="http://en.wikipedia.org/wiki/Initrd" class="urlextern" title="http://en.wikipedia.org/wiki/Initrd"  rel="nofollow">initrd</a></div>
</li>
<li class="level1"><div class="li"><a href="http://www.gentoo.org/doc/en/handbook/handbook-x86.xml?part=1&amp;chap=7" class="urlextern" title="http://www.gentoo.org/doc/en/handbook/handbook-x86.xml?part=1&amp;chap=7"  rel="nofollow">Gentoo - Configuring the kernel</a></div>
</li>
<li class="level1"><div class="li"><a href="http://www.osnews.com/story.php?news_id=2949" class="urlextern" title="http://www.osnews.com/story.php?news_id=2949"  rel="nofollow">The Very Verbose Guide to Updating and Compiling Your Debian Kernel</a></div>
</li>
<li class="level1"><div class="li"><a href="http://www.debian.org/doc/FAQ/ch-kernel.en.html" class="urlextern" title="http://www.debian.org/doc/FAQ/ch-kernel.en.html"  rel="nofollow">Debian and the kernel</a></div>
</li>
<li class="level1"><div class="li"><a href="http://www.digitalhermit.com/linux/Kernel-Build-HOWTO.html" class="urlextern" title="http://www.digitalhermit.com/linux/Kernel-Build-HOWTO.html"  rel="nofollow">Kernel Build - HowTo</a></div>
</li>
<li class="level1"><div class="li"><a href="http://www.faqs.org/docs/Linux-HOWTO/Kernel-HOWTO.html" class="urlextern" title="http://www.faqs.org/docs/Linux-HOWTO/Kernel-HOWTO.html"  rel="nofollow">The Linux Kernel HOWTO</a></div>
</li>
<li class="level1"><div class="li"><a href="http://www.comptechdoc.org/os/linux/usersguide/linux_ugkernel.html" class="urlextern" title="http://www.comptechdoc.org/os/linux/usersguide/linux_ugkernel.html"  rel="nofollow">Linux Kernel</a></div>
</li>
<li class="level1"><div class="li"><a href="http://www.dirac.org/linux/system.map/" class="urlextern" title="http://www.dirac.org/linux/system.map/"  rel="nofollow">The System.map file</a></div>
</li>
<li class="level1"><div class="li"><a href="http://www.tldp.org/HOWTO/LILO.html" class="urlextern" title="http://www.tldp.org/HOWTO/LILO.html"  rel="nofollow">LILO mini-HOWTO</a></div>
</li>
<li class="level1"><div class="li"><a href="http://www.gentoo.org/doc/en/handbook/handbook-x86.xml?part=1&amp;chap=10" class="urlextern" title="http://www.gentoo.org/doc/en/handbook/handbook-x86.xml?part=1&amp;chap=10"  rel="nofollow">Configuring the Bootloader</a></div>
</li>
<li class="level1"><div class="li"><a href="http://www.linuxjournal.com/article/4622" class="urlextern" title="http://www.linuxjournal.com/article/4622"  rel="nofollow">Boot with GRUB</a></div>
</li>
<li class="level1"><div class="li"><a href="http://koala.cs.pub.ro/lxr/linux26/README" class="urlextern" title="http://koala.cs.pub.ro/lxr/linux26/README"  rel="nofollow">README</a> din cadrul surselor kernel-ului</div>
</li>
<li class="level1"><div class="li"><a href="http://www.dedoimedo.com/computers/grub.html" class="urlextern" title="http://www.dedoimedo.com/computers/grub.html"  rel="nofollow"> Configurare GRUB1</a></div>
</li>
<li class="level1"><div class="li"><a href="http://www.dedoimedo.com/computers/grub-2.html" class="urlextern" title="http://www.dedoimedo.com/computers/grub-2.html"  rel="nofollow"> Configurare GRUB2</a></div>
</li>
</ul>

</div>
<!-- EDIT16 SECTION "Link-uri" [19334-20493] -->
<h2 class="sectionedit17" id="compilarea_kernel-ului_windows">Compilarea kernel-ului Windows</h2>
<div class="level2">

<p>
În cadrul <a href="http://www.microsoft.com/resources/sharedsource/Licensing/WindowsAcademic.mspx" class="urlextern" title="http://www.microsoft.com/resources/sharedsource/Licensing/WindowsAcademic.mspx"  rel="nofollow">Windows Academic Program</a> există posibilitatea accesului la codul sursa a kernel-ului de Windows NT, prin intermediul inițiativei <a href="http://www.microsoft.com/resources/sharedsource/Licensing/researchkernel.mspx" class="urlextern" title="http://www.microsoft.com/resources/sharedsource/Licensing/researchkernel.mspx"  rel="nofollow">Windows Research Kernel</a> (WRK).
</p>

<p>
Codul sursă prezintă componentele cele mai importante din cadrul nuclelui (managementul memoriei, procese, thread-uri, scheduling, I/O manager) și poate fi folosit și modificat în scopuri non-comerciale. Se pot astfel urmări diversele mecanisme de implementare și design care stau la baza kernel-ului și se pot testa diverse alte soluții prin modificarea surselor. Accesul la sursele kernel-ului este limitat, anumite subdomenii (cum ar fi networking-ul) fiind absente.
</p>

<p>
Accesul la codul sursă pentru nucleul de Windows NT înseamna posibilitatea de modificare a acestuia și, evident, de compilare a kernel-ului și de boot-are. Sursele sunt accesibile prin intermediul <a href="http://elf.cs.pub.ro/so2/res/wrk/wrk.iso" class="urlextern" title="http://elf.cs.pub.ro/so2/res/wrk/wrk.iso"  rel="nofollow">imaginii de CD</a> pusă la dispoziție de Microsoft în cadrul inițiativei WRK.
</p>

<p>
Din păcate, kernel-ul de Windows nu vine cu opțiuni de configurare, astfel încat procesul se rezumă la rularea comenzii de compilare și la instalarea noului kernel. Dacă se dorește un tip special de funcționalitate vor trebui alterate sursele.
</p>

<p>
De asemenea, kernel-ul poate fi compilat numai pe un sistem Windows 2003 SP1 sau Windows XP x64. Versiunea curentă (WRK-1.2) nu poate fi compilată pe un sistem Windows XP x86. Sursele sunt disponibile în directorul <code>C:\cygwin\home\Administrator\so2\WRK\</code> din cadrul <a href="http://elf.cs.pub.ro/so/vm/" class="urlextern" title="http://elf.cs.pub.ro/so/vm/"  rel="nofollow">mașinii virtuale de Windows</a>.
</p>

<p>
Etapele de compilare sunt prezentate și în fișierul <strong>README.txt</strong> din rădăcina surselor.
</p>

</div>
<!-- EDIT17 SECTION "Compilarea kernel-ului Windows" [20494-22364] -->
<h3 class="sectionedit18" id="compilare1">Compilare</h3>
<div class="level3">

<p>
Pentru compilarea surselor se parcurg următorii pași (vom utiliza de acum inainte <code>%wrk%</code> ca rădăcina surselor de kernel de Windows):
</p>
<pre class="code">C:\&gt;set wrk=C:\cygwin\home\Administrator\so2\WRK\WRK-v1.2
C:\&gt;set arch=x86
C:\&gt;set path=%wrk%\tools\%arch%;%path%
C:\&gt;cd %wrk%\base
C:\cygwin\home\Administrator\so2\WRK\WRK-v1.2\base&gt;cd ntos
C:\cygwin\home\Administrator\so2\WRK\WRK-v1.2\base\ntos&gt;nmake -nologo %arch%=</pre>

<p>
Imaginea de kernel obținută se va regăsi în <code>%wrk%\base\ntos\BUILD\EXE</code> și va purta numele <code>wrkx86.exe</code> pentru un sistem cu arhitectura x86. Imaginea obținută este doar nucleul; modulele de kernel folosite vor fi cele existente în sistem în acel moment.
</p>

</div>
<!-- EDIT18 SECTION "Compilare" [22365-23079] -->
<h3 class="sectionedit19" id="instalare1">Instalare</h3>
<div class="level3">

<p>
Procesul de instalare presupune copierea imaginii kernel-ului în <code>%SystemRoot%\system32</code>:
</p>
<pre class="code">C:\&gt;copy %wrk%\base\ntos\BUILD\EXE\wrkx86.exe %SystemRoot%\system32\</pre>

<p>
Totuși, în afara imaginii de kernel, va trebui precizată imaginea de HAL (Hardware Abstraction Layer) care va fi utilizată. Va trebui gasită imaginea corecta de HAL; există trei imagini de HAL disponibile in <code>%wrk%\WS03SP1HALS\x86</code>. Pentru a afla care imagine este cea corectă va trebui utilizat linker-ul (folosind  comanda <code>link</code> și analizată imaginea de HAL existentă în acest moment în sistem).
</p>
<pre class="code">C:\&gt;&quot;C:\Program Files\Microsoft Visual Studio 8\VC\vcvarsall.bat&quot;
Setting environment for using Microsoft Visual Studio 2005 x86 tools.
C:\&gt;link -dump -all %SystemRoot%\system32\hal.dll | findstr pdb
  80011530: 68 61 6C 2E 70 64 62 00 00 00 00 00 00 00 00 00  hal.pdb.........
    42435B3A cv           20 00001518      918    Format: RSDS, {2ECB059A-3F06-4
285-8E30-3FDE64119692}, 1, hal.pdb</pre>

<p>
Motivul pentru care în ieșirea comenzii nu apare șirul <code>halaacpi.dll</code> este că a fost dezactivat <a href="http://en.wikipedia.org/wiki/ACPI" class="urlextern" title="http://en.wikipedia.org/wiki/ACPI"  rel="nofollow">ACPI</a> pe mașina virtuală de Windows 2003.
</p>

<p>
Asocierea dintre ieșirea comenzii de mai sus și imaginile disponibile în <code>%wrk%\WS03SP1HALS\x86</code> este (după cum este precizat și în README.txt):
</p>
<pre class="code">    halacpi.dll  -&gt; halacpim.dll
    halaacpi.dll -&gt; halmacpi.dll
    halapic.dll  -&gt; halmps.dll</pre>

<p>
De obicei, imaginea căutată va fi <code>halmacpi.dll</code>.
</p>

<p>
Imaginea corectă de HAL va fi copiată tot în <code>%SystemRoot%\system32</code>:
</p>
<pre class="code">C:\&gt;copy %wrk%\WS03SP1HALS\x86\halmacpi\halmacpi.dll %SystemRoot%\System32\</pre>

</div>
<!-- EDIT19 SECTION "Instalare" [23080-24779] -->
<h3 class="sectionedit20" id="configurare_bootini">Configurare boot.ini</h3>
<div class="level3">

<p>
Pentru a boota proaspătul kernel va trebui adaugată o intrare în <code>C:\boot.ini</code>, fișierul de configurare pentru loader-ul de Windows NT. Se recomandă copierea unei linii de bootare existente și modificarea ei pentru a boota noul kernel și noua imagine de HAL, ca mai jos:
</p>
<pre class="code">[boot loader]
timeout=30
default=multi(0)disk(0)rdisk(0)partition(1)\WINDOWS
[operating systems]
multi(0)disk(0)rdisk(0)partition(1)\WINDOWS=&quot;Windows Server 2003, Standard&quot;
/fastdetect /NoExecute=OptOut
multi(0)disk(0)rdisk(0)partition(1)\WINDOWS=&quot;Windows Server 2003, Standard - WRK-1.2
compiled kernel&quot; /kernel=wrkx86.exe /hal=halmacpi.dll /fastdetect /NoExecute=OptOut</pre>

<p>
Pentru vizualizarea <code>boot.ini</code> în Windows Explorer, va trebui să accesați <code>Tools → Folder Options → View → Hide protected operating system files (Recommended)</code>. Fișierul este implicit read-only; pentru editare va trebui să anulați această opțiune. Alternativ puteți face acest lucru din linia de comanda:
</p>
<pre class="code">C:\&gt;attrib -h -s -r boot.ini</pre>

<p>
După configurarea <code>boot.ini</code>, sistemul poate boota în noul kernel compilat.
</p>
<ul>
<li class="level1"><div class="li"><a href="http://support.microsoft.com/kb/323427/en-us" class="urlextern" title="http://support.microsoft.com/kb/323427/en-us"  rel="nofollow">How to manually edit the Boot.ini file in a Windows Server 2003 environment</a></div>
</li>
<li class="level1"><div class="li"><a href="http://support.microsoft.com/kb/833721/en-us" class="urlextern" title="http://support.microsoft.com/kb/833721/en-us"  rel="nofollow">Available switch options for the Windows XP and the Windows Server 2003 Boot.ini files</a></div>
</li>
</ul>

</div>
<!-- EDIT20 SECTION "Configurare boot.ini" [24780-] --></div>
</body>
</html>
