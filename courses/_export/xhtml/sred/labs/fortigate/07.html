    
    

<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <title>sred:labs:fortigate:07</title>
<meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="date" content="2015-06-01T20:51:32+0300"/>
<meta name="keywords" content="sred,labs,fortigate,07"/>
<link rel="search" type="application/opensearchdescription+xml" href="../../../../../lib/exe/opensearch.php" title="CS Open CourseWare"/>
<link rel="start" href="../../../../../../courses.1.html"/>
<link rel="alternate" type="application/rss+xml" title="Recent Changes" href="../../../../../feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Current Namespace" href="../../../../../feed.php%3Fmode=list&amp;ns=sred:labs:fortigate"/>
<link rel="alternate" type="text/html" title="Plain HTML" href="07.html"/>
<link rel="canonical" href="../../../../../sred/labs/fortigate/07.html"/>
<link rel="stylesheet" type="text/css" href="../../../../../lib/exe/css.php%3Ft=arctic&amp;tseed=1476798676.css"/>
<script type="text/javascript">/*<![CDATA[*/var NS='sred:labs:fortigate';var JSINFO = {"id":"sred:labs:fortigate:07","namespace":"sred:labs:fortigate","isadmin":0,"isauth":0};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../../../../../lib/exe/js.php%3Ftseed=1476798676"></script>
<script type="text/x-mathjax-config">/*<![CDATA[*/MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ["$","$"], ["\\(","\\)"] ],
        displayMath: [ ["$$","$$"], ["\\[","\\]"] ],
        processEscapes: true
    }
});
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
<script type="text/javascript">/*<![CDATA[*/
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
		  
/*!]]>*/</script>
<script type="text/javascript">/*<![CDATA[*/
var pageTracker = _gat._getTracker("UA-38383934-1");
pageTracker._initData();
pageTracker._trackPageview();
		  
/*!]]>*/</script>
</head>
<body>
<div class="dokuwiki export">
<!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle">Table of Contents</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="07.html#f07_-_ipsec_site-to-site">F07 - IPSec site-to-site</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="07.html#topology">Topology</a></div></li>
<li class="level2"><div class="li"><a href="07.html#tasks">Tasks</a></div>
<ul class="toc">
<li class="level3"><div class="li"><a href="07.html#basic_setup">1. Basic Setup</a></div>
<ul class="toc">
<li class="level4"><div class="li"><a href="07.html#a_connectivity_tests">A. Connectivity tests</a></div></li>
<li class="level4"><div class="li"><a href="07.html#b_loopback_interfaces">B. Loopback interfaces</a></div></li>
<li class="level4"><div class="li"><a href="07.html#c_routing">C. Routing</a></div></li>
<li class="level4"><div class="li"><a href="07.html#d_policies">D. Policies</a></div></li>
<li class="level4"><div class="li"><a href="07.html#e_test">E. Test</a></div></li>
</ul>
</li>
<li class="level3"><div class="li"><a href="07.html#route-based_ipsec_site-to-site">2. Route-based IPSec site-to-site</a></div>
<ul class="toc">
<li class="level4"><div class="li"><a href="07.html#a_ipsec_phase_1">A. IPSec Phase 1</a></div></li>
<li class="level4"><div class="li"><a href="07.html#b_ipsec_phase_2">B. IPSec Phase 2</a></div></li>
<li class="level4"><div class="li"><a href="07.html#c_policies">C. Policies</a></div></li>
<li class="level4"><div class="li"><a href="07.html#d_routing">D. Routing</a></div></li>
<li class="level4"><div class="li"><a href="07.html#debugging">Debugging</a></div></li>
</ul>
</li>
<li class="level3"><div class="li"><a href="07.html#bonus_policy-based_ipsec_site-to-site">3. (BONUS) Policy-based IPSec site-to-site</a></div></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<!-- TOC END -->

<h1 class="sectionedit1" id="f07_-_ipsec_site-to-site">F07 - IPSec site-to-site</h1>
<div class="level1">

</div>
<!-- EDIT1 SECTION "F07 - IPSec site-to-site" [19-58] -->
<h2 class="sectionedit2" id="topology">Topology</h2>
<div class="level2">

<p>
<a href="../../../../../_detail/sred/labs/fortigate/fg_topology_05.png%3Fid=sred%253Alabs%253Afortigate%253A07.html" class="media" title="sred:labs:fortigate:fg_topology_05.png"><img src="../../../../../_media/sred/labs/fortigate/fg_topology_05.png" class="mediacenter" alt="" /></a>
</p>

</div>
<!-- EDIT2 SECTION "Topology" [59-126] -->
<h2 class="sectionedit3" id="tasks">Tasks</h2>
<div class="level2">

</div>
<!-- EDIT3 SECTION "Tasks" [127-145] -->
<h3 class="sectionedit4" id="basic_setup">1. Basic Setup</h3>
<div class="level3">

<p>
In this task you will prepare the FortiGate firewalls for IPSec site-to-site configuration.
</p>

</div>

<h4 id="a_connectivity_tests">A. Connectivity tests</h4>
<div class="level4">

<p>
<p><div class="noteimportant"> Use the topology above to discover the required IP addresses 
</div></p>
</p>

<p>
<p><div class="notetip"> We recommend you write down a diagram of the network containing IP addresses and interface names. It will be of great help to you throughout the lab. 
</div></p>
</p>

<p>
Check that:
</p>
<ul>
<li class="level1"><div class="li"> You can <code>ping</code> the outside (port2) interface of <strong>FortiGate2</strong> from the outside (port2) interface of <strong>FortiGate1</strong></div>
</li>
<li class="level1"><div class="li"> You can <code>ping</code> the inside (port1) interface of <strong>FortiGate2</strong> from the inside (port1) interface of <strong>FortiGate1</strong></div>
</li>
<li class="level1"><div class="li"> You can log in successfully on <strong>FortiGate1</strong> and <strong>FortiGate2</strong> from the host computer</div>
</li>
<li class="level1"><div class="li"> You can <code>ping</code> the <code>Ubuntu Server</code> from <strong>FortiGate1</strong> and <strong>FortiGate2</strong></div>
</li>
</ul>

<p>
<p><div class="noteimportant"> Traffic from the host computer to the <code>Ubuntu Server</code> is routed through <strong>FortiGate1</strong>. 
</div></p>
</p>

</div>

<h4 id="b_loopback_interfaces">B. Loopback interfaces</h4>
<div class="level4">

<p>
Configure the following loopback interfaces on the FortiGate devices:
</p>
<ul>
<li class="level1"><div class="li"> On <strong>FortiGate1</strong>: 11.11.11.11/24</div>
</li>
<li class="level1"><div class="li"> On <strong>FortiGate2</strong>: 22.22.22.22/24</div>
</li>
</ul>

</div>

<h4 id="c_routing">C. Routing</h4>
<div class="level4">

<p>
Configure the following routes:
</p>
<ul>
<li class="level1"><div class="li"> On <strong>FortiGate1</strong>: 22.22.22.0/24 via 200.0.0.20</div>
</li>
<li class="level1"><div class="li"> On <strong>FortiGate2</strong>: 11.11.11.0/24 via 200.0.0.10</div>
</li>
</ul>

</div>

<h4 id="d_policies">D. Policies</h4>
<div class="level4">

<p>
<p><div class="notewarning"> Before proceeding further, delete all preconfigured policies. 
</div></p>
Configure the following policies on both firewalls:
</p>
<ul>
<li class="level1"><div class="li"> All traffic from <em>port2</em> to <em>loopback</em> should be permitted</div>
</li>
<li class="level1"><div class="li"> All traffic from <em>loopback</em> to <em>port2</em> should be permitted</div>
</li>
</ul>

</div>

<h4 id="e_test">E. Test</h4>
<div class="level4">

<p>
Test that <strong>FortiGate2</strong> can ping 11.11.11.11 and that <strong>FortiGate1</strong> can ping 22.22.22.22.
</p>

</div>
<!-- EDIT4 SECTION "1. Basic Setup" [146-1832] -->
<h3 class="sectionedit5" id="route-based_ipsec_site-to-site">2. Route-based IPSec site-to-site</h3>
<div class="level3">

<p>
In this task, you will implement Route-based site-to-site IPSec VPN.
</p>

</div>

<h4 id="a_ipsec_phase_1">A. IPSec Phase 1</h4>
<div class="level4">

<p>
Define IPSec Phase 1 using the following:
</p>
<ul>
<li class="level1"><div class="li"> name: IPSec_tun1</div>
</li>
<li class="level1"><div class="li"> IP address: the IP address of the remote interface (<strong>port2</strong>)</div>
</li>
<li class="level1"><div class="li"> password: SREDkey1</div>
</li>
<li class="level1"><div class="li"> advanced settings: IPSec interface mode</div>
</li>
</ul>

<p>
<p><div class="noteimportant"> You need to activate IPSec interface mode, with default settings (use the <strong>Advanced</strong> button). You must do this when you create the tunnel, you will not be able to edit the setting later 
</div></p>
</p>

<p>
<p><div class="notetip"> Use the <em>VPN</em> tab. 
</div></p>
</p>

</div>

<h4 id="b_ipsec_phase_2">B. IPSec Phase 2</h4>
<div class="level4">

<p>
Define IPSec Phase 2 using the following:
</p>
<ul>
<li class="level1"><div class="li"> name: IPSec_tun2</div>
</li>
</ul>

<p>
Use the phase 1 you created earlier.
</p>

</div>

<h4 id="c_policies">C. Policies</h4>
<div class="level4">

<p>
Create a route-based policy that only allows the local loopback network to access the remote loopback network and viceversa (remote loopback to local loopback).
</p>

</div>

<h4 id="d_routing">D. Routing</h4>
<div class="level4">

<p>
Edit the routes you created earlier so that:
</p>
<ul>
<li class="level1"><div class="li"> <strong>FortiGate1</strong> routes traffic towards 22.22.22.0/24 through the VPN tunnel</div>
</li>
<li class="level1"><div class="li"> <strong>FortiGate2</strong> routes traffic towards 11.11.11.0/24 through the VPN tunnel</div>
</li>
</ul>

</div>

<h4 id="debugging">Debugging</h4>
<div class="level4">

<p>
Use <strong>IPSec VPN Monitor</strong> to bring the tunnel up.
</p>

<p>
<p><div class="notetip"> Use the <em>VPN/Monitor/IPSec Monitor</em> tab. 
</div></p>
</p>

<p>
Attempt to ping the remote loopback interface using the local loopback interface.
</p>

<p>
<p><div class="notetip">
You will need to specify the source of the ICMP packet. To do this on a FortiGate, use:
</p>
<pre class="code"># execute ping-options source 11.11.11.11
# execute ping 22.22.22.22</pre>

<p>

</div></p>
</p>

<p>
<p><div class="notetip">
</p>
<ul>
<li class="level1"><div class="li"> diag debug enable</div>
<ul>
<li class="level4"><div class="li"> diag debug app ike 1</div>
</li>
<li class="level4"><div class="li"> diag vpn tunnel list</div>
</li>
</ul>
</li>
</ul>

<p>

</div></p>
</p>

<p>
Start a packet capture using wireshark on <em>vmnet4</em>. Check that the packets are encrypted.
</p>

</div>
<!-- EDIT5 SECTION "2. Route-based IPSec site-to-site" [1833-3564] -->
<h3 class="sectionedit6" id="bonus_policy-based_ipsec_site-to-site">3. (BONUS) Policy-based IPSec site-to-site</h3>
<div class="level3">

<p>
In this task, you will implement Policy-based site-to-site IPSec VPN.
</p>

<p>
Create a policy-based policy that only allows the local loopback network to access the remote loopback network and viceversa (remote loopback to local loopback).
</p>

</div>
<!-- EDIT6 SECTION "3. (BONUS) Policy-based IPSec site-to-site" [3565-] --></div>
</body>
</html>
