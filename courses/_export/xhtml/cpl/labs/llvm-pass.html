    
    

<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <title>cpl:labs:llvm-pass</title>
<meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="date" content="2015-12-08T00:32:52+0200"/>
<meta name="keywords" content="cpl,labs,llvm-pass"/>
<link rel="search" type="application/opensearchdescription+xml" href="../../../../lib/exe/opensearch.php" title="CS Open CourseWare"/>
<link rel="start" href="../../../../../courses.1.html"/>
<link rel="alternate" type="application/rss+xml" title="Recent Changes" href="../../../../feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Current Namespace" href="../../../../feed.php%3Fmode=list&amp;ns=cpl:labs"/>
<link rel="alternate" type="text/html" title="Plain HTML" href="llvm-pass.html"/>
<link rel="canonical" href="../../../../cpl/labs/llvm-pass.html"/>
<link rel="stylesheet" type="text/css" href="../../../../lib/exe/css.php%3Ft=arctic&amp;tseed=1476798676.css"/>
<script type="text/javascript">/*<![CDATA[*/var NS='cpl:labs';var JSINFO = {"id":"cpl:labs:llvm-pass","namespace":"cpl:labs","isadmin":0,"isauth":0};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../../../../lib/exe/js.php%3Ftseed=1476798676"></script>
<script type="text/x-mathjax-config">/*<![CDATA[*/MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ["$","$"], ["\\(","\\)"] ],
        displayMath: [ ["$$","$$"], ["\\[","\\]"] ],
        processEscapes: true
    }
});
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
<script type="text/javascript">/*<![CDATA[*/
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
		  
/*!]]>*/</script>
<script type="text/javascript">/*<![CDATA[*/
var pageTracker = _gat._getTracker("UA-38383934-1");
pageTracker._initData();
pageTracker._trackPageview();
		  
/*!]]>*/</script>
</head>
<body>
<div class="dokuwiki export">
<!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle">Table of Contents</h3>
<div>

<ul class="toc">
<li class="level1"><div class="li"><a href="llvm-pass.html#llvm_passes">LLVM Passes</a></div>
<ul class="toc">
<li class="level2"><div class="li"><a href="llvm-pass.html#crearea_unui_pass">Crearea unui Pass</a></div>
<ul class="toc">
<li class="level3"><div class="li"><a href="llvm-pass.html#pass-uri_existente">Pass-uri existente</a></div></li>
<li class="level3"><div class="li"><a href="llvm-pass.html#hello_world">Hello World</a></div></li>
<li class="level3"><div class="li"><a href="llvm-pass.html#integrarea_unui_pas_in_llvm">Integrarea unui pas în LLVM</a></div></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<!-- TOC END -->

<h1 class="sectionedit1" id="llvm_passes">LLVM Passes</h1>
<div class="level1">

<p>
<a href="http://llvm.org/docs/WritingAnLLVMPass.html" class="urlextern" title="http://llvm.org/docs/WritingAnLLVMPass.html"  rel="nofollow">LLVM Passes</a> este un subsistem al framework-ului LLVM ce permite crearea de module simple pentru transformarea, prelucrarea și analiza codului intermediar <code>LLVM IR</code>.
</p>

<p>
Există numeroase pass-uri deja implementate în versiunea oficială LLVM. Acestea primesc ca input cod <code>LLVM IR</code> și oferă ca output fie <code>LLVM IR</code> (în cazul în care este un pass de transformare), fie un text cu diverse statistici (în cazul în care este un pass de analiză).
</p>

</div>
<!-- EDIT1 SECTION "LLVM Passes" [1-530] -->
<h2 class="sectionedit2" id="crearea_unui_pass">Crearea unui Pass</h2>
<div class="level2">

<p>
<code>LLVM Passes</code> pot fi rulate cu ajutorul tool-ului <code>opt</code>.
</p>

</div>
<!-- EDIT2 SECTION "Crearea unui Pass" [531-623] -->
<h3 class="sectionedit3" id="pass-uri_existente">Pass-uri existente</h3>
<div class="level3">
<pre class="code bash">student<span class="sy0">@</span>cpl-vm ~ $ opt <span class="re5">--help</span>
OVERVIEW: llvm .bc -<span class="sy0">&gt;</span> .bc modular optimizer and analysis printer
&nbsp;
USAGE: opt <span class="br0">&#91;</span>options<span class="br0">&#93;</span> <span class="sy0">&lt;</span>input bitcode <span class="kw2">file</span><span class="sy0">&gt;</span>
&nbsp;
OPTIONS:
  <span class="re5">-O1</span>                                             - Optimization level <span class="nu0">1</span>. Similar to clang <span class="re5">-O1</span>
  <span class="re5">-O2</span>                                             - Optimization level <span class="nu0">2</span>. Similar to clang <span class="re5">-O2</span>
  <span class="re5">-O3</span>                                             - Optimization level <span class="nu0">3</span>. Similar to clang <span class="re5">-O3</span>
  <span class="re5">-Os</span>                                             - Like <span class="re5">-O2</span> with extra optimizations <span class="kw1">for</span> size. Similar to clang <span class="re5">-Os</span>
  <span class="re5">-Oz</span>                                             - Like <span class="re5">-Os</span> but reduces code <span class="kw2">size</span> further. Similar to clang <span class="re5">-Oz</span>
  <span class="re5">-S</span>                                              - Write output <span class="kw2">as</span> LLVM assembly
  <span class="re5">-analyze</span>                                        - Only perform analysis, no optimization
  <span class="re5">-asm-instrumentation</span>                            - Instrumentation of inline assembly and assembly <span class="kw3">source</span> files
    =none                                         -   no instrumentation at all
    =address                                      -   instrument instructions with memory arguments
  <span class="re5">-asm-show-inst</span>                                  - Emit internal instruction representation to assembly <span class="kw2">file</span>
  Optimizations available:
<span class="br0">&#91;</span>...<span class="br0">&#93;</span>
    <span class="re5">-bb-vectorize</span>                                 - Basic-Block Vectorization
    <span class="re5">-constprop</span>                                    - Simple constant propagation
    <span class="re5">-da</span>                                           - Dependence Analysis
    <span class="re5">-dce</span>                                          - Dead Code Elimination
    <span class="re5">-domtree</span>                                      - Dominator Tree Construction
    <span class="re5">-dot-callgraph</span>                                - Print call graph to <span class="st_h">'dot'</span> <span class="kw2">file</span>
    <span class="re5">-dot-cfg</span>                                      - Print CFG of <span class="kw1">function</span> to <span class="st_h">'dot'</span> <span class="kw2">file</span>
    <span class="re5">-dot-cfg-only</span>                                 - Print CFG of <span class="kw1">function</span> to <span class="st_h">'dot'</span> <span class="kw2">file</span> <span class="br0">&#40;</span>with no <span class="kw1">function</span> bodies<span class="br0">&#41;</span>
    <span class="re5">-dot-dom</span>                                      - Print dominance <span class="kw2">tree</span> of <span class="kw1">function</span> to <span class="st_h">'dot'</span> <span class="kw2">file</span>
    <span class="re5">-dot-dom-only</span>                                 - Print dominance <span class="kw2">tree</span> of <span class="kw1">function</span> to <span class="st_h">'dot'</span> <span class="kw2">file</span> <span class="br0">&#40;</span>with no <span class="kw1">function</span> bodies<span class="br0">&#41;</span>
    <span class="re5">-dot-postdom</span>                                  - Print postdominance <span class="kw2">tree</span> of <span class="kw1">function</span> to <span class="st_h">'dot'</span> <span class="kw2">file</span>
    <span class="re5">-dot-postdom-only</span>                             - Print postdominance <span class="kw2">tree</span> of <span class="kw1">function</span> to <span class="st_h">'dot'</span> <span class="kw2">file</span> <span class="br0">&#40;</span>with no <span class="kw1">function</span> bodies<span class="br0">&#41;</span>
    <span class="re5">-instcount</span>                                    - Counts the various types of Instructions
    <span class="re5">-loop-deletion</span>                                - Delete dead loops
    <span class="re5">-loop-reroll</span>                                  - Reroll loops
    <span class="re5">-loop-rotate</span>                                  - Rotate Loops
    <span class="re5">-loop-unroll</span>                                  - Unroll loops
    <span class="re5">-loop-vectorize</span>                               - Loop Vectorization
    <span class="re5">-loops</span>                                        - Natural Loop Information
    <span class="re5">-mem2reg</span>                                      - Promote Memory to Register
    <span class="re5">-memdep</span>                                       - Memory Dependence Analysis
    <span class="re5">-print-callgraph</span>                              - Print a call graph
    <span class="re5">-reg2mem</span>                                      - Demote all values to stack slots
    <span class="re5">-sample-profile</span>                               - Sample Profile loader
    <span class="re5">-simplifycfg</span>                                  - Simplify the CFG
    <span class="re5">-verify</span>                                       - Module Verifier
    <span class="re5">-view-callgraph</span>                               - View call graph
    <span class="re5">-view-cfg</span>                                     - View CFG of <span class="kw1">function</span>
    <span class="re5">-view-cfg-only</span>                                - View CFG of <span class="kw1">function</span> <span class="br0">&#40;</span>with no <span class="kw1">function</span> bodies<span class="br0">&#41;</span>
    <span class="re5">-view-dom</span>                                     - View dominance <span class="kw2">tree</span> of <span class="kw1">function</span>
    <span class="re5">-view-dom-only</span>                                - View dominance <span class="kw2">tree</span> of <span class="kw1">function</span> <span class="br0">&#40;</span>with no <span class="kw1">function</span> bodies<span class="br0">&#41;</span>
    <span class="re5">-view-postdom</span>                                 - View postdominance <span class="kw2">tree</span> of <span class="kw1">function</span>
    <span class="re5">-view-postdom-only</span>                            - View postdominance <span class="kw2">tree</span> of <span class="kw1">function</span> <span class="br0">&#40;</span>with no <span class="kw1">function</span> bodies<span class="br0">&#41;</span>
  <span class="re5">-p</span>                                              - Print module after each transformation
  <span class="re5">-stats</span>                                          - Enable statistics output from program <span class="br0">&#40;</span>available with Asserts<span class="br0">&#41;</span>
  <span class="re5">-time-passes</span>                                    - Time each pass, printing elapsed <span class="kw1">time</span> <span class="kw1">for</span> each on <span class="kw3">exit</span>
<span class="br0">&#91;</span>...<span class="br0">&#93;</span></pre>

</div>
<!-- EDIT3 SECTION "Pass-uri existente" [624-5056] -->
<h3 class="sectionedit4" id="hello_world">Hello World</h3>
<div class="level3">

<p>
Vom rula pass-ul default hello pe un cod simplu.
</p>

<p>
Codul sursă al pass-ului Hello din LLVM se găsește în directorul <code>$LLVM_SRC/lib/Transforms/Hello</code>. Vizualizați codul sursă și makefile-ul. Pentru detalii suplimentare consultați <a href="http://llvm.org/docs/WritingAnLLVMPass.html" class="urlextern" title="http://llvm.org/docs/WritingAnLLVMPass.html"  rel="nofollow">pagina de manual</a>.
</p>

<p>
După cum ați observat anterior, acesta nu este găsit by default de către tool-ul <code>opt</code>. Va trebui să îi specificăm calea către biblioteca dinamică compilată.
</p>
<pre class="code bash">student<span class="sy0">@</span>cpl-vm ~<span class="sy0">/</span>llvm-3.6.2 $ opt <span class="re5">-load</span> llvm-3.6.2<span class="sy0">/</span>install<span class="sy0">/</span>lib<span class="sy0">/</span>LLVMHello.so <span class="re5">--help</span>
OVERVIEW: llvm .bc -<span class="sy0">&gt;</span> .bc modular optimizer and analysis printer
&nbsp;
USAGE: opt <span class="br0">&#91;</span>options<span class="br0">&#93;</span> <span class="sy0">&lt;</span>input bitcode <span class="kw2">file</span><span class="sy0">&gt;</span>
&nbsp;
<span class="br0">&#91;</span>...<span class="br0">&#93;</span>
    <span class="re5">-hello</span>                                        - Hello World Pass
    <span class="re5">-hello2</span>                                       - Hello World Pass <span class="br0">&#40;</span>with getAnalysisUsage implemented<span class="br0">&#41;</span>
<span class="br0">&#91;</span>...<span class="br0">&#93;</span></pre>

<p>
Fie următorul cod sursă C:
</p>
<dl class="code">
<dt><a href="../../../code/cpl/labs/llvm-pass%3Fcodeblock=2" title="Download Snippet" class="mediafile mf_c">ex.c</a></dt>
<dd><pre class="code C"><span class="co2">#include &lt;stdio.h&gt;</span>
&nbsp;
<span class="kw4">int</span> compute<span class="br0">&#40;</span><span class="kw4">int</span> x<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="kw1">return</span> <span class="nu0">10</span> <span class="sy0">+</span> <span class="nu0">4</span> <span class="sy0">*</span> x<span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw4">int</span> main<span class="br0">&#40;</span><span class="kw4">void</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="kw4">int</span> x <span class="sy0">=</span> <span class="nu0">10</span> <span class="sy0">*</span> <span class="nu0">12</span><span class="sy0">;</span>
&nbsp;
    <a href="http://www.opengroup.org/onlinepubs/009695399/functions/printf.html"><span class="kw3">printf</span></a><span class="br0">&#40;</span><span class="st0">&quot;Printing something: %d<span class="es1">\n</span>&quot;</span><span class="sy0">,</span> compute<span class="br0">&#40;</span>x<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">return</span> <span class="nu0">0</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre>
</dd></dl>

<p>
Vom genera fișierul <code>.bc</code> corespunzător:
</p>
<pre class="code bash">student<span class="sy0">@</span>cpl-vm ~ $ clang <span class="re5">-emit-llvm</span> ex.c <span class="re5">-c</span> <span class="re5">-o</span> ex.bc</pre>

<p>
Vom rula pass-ul <code>Hello</code> peste bitcode-ul obținut:
</p>
<pre class="code bash">student<span class="sy0">@</span>cpl-vm ~ $ opt <span class="re5">-load</span> llvm-3.6.2<span class="sy0">/</span>install<span class="sy0">/</span>lib<span class="sy0">/</span>LLVMHello.so <span class="re5">--hello</span> <span class="sy0">&lt;</span> ex.bc 
WARNING: You<span class="st_h">'re attempting to print out a bitcode file.
This is inadvisable as it may cause display problems. If
you REALLY want to taste LLVM bitcode first-hand, you
can force output with the `-f'</span> option.
&nbsp;
Hello: compute
Hello: main</pre>

</div>
<!-- EDIT4 SECTION "Hello World" [5057-6700] -->
<h3 class="sectionedit5" id="integrarea_unui_pas_in_llvm">Integrarea unui pas în LLVM</h3>
<div class="level3">

<p>
Pentru a nu mai fi nevoiți să specificăm biblioteca dinamică la runtime, aceasta trebuie să fie integrată în codul utilitarelor <code>opt</code> și <code>bugpoint</code>. Pentru a realiza acest lucru, trebuie să modificăm <a href="http://llvm.org/docs/WritingAnLLVMPass.html#quickstart" class="urlextern" title="http://llvm.org/docs/WritingAnLLVMPass.html#quickstart"  rel="nofollow">exemplul</a> dat în <strong>sursele</strong> de LLVM astfel:
</p>
<ul>
<li class="level1"><div class="li"> <code>lib/Transforms/Hello/Makefile</code></div>
<ul>
<li class="level2"><div class="li"> se şterge: <strong>LOADABLE_MODULE = 1</strong></div>
</li>
<li class="level2"><div class="li"> și se adaugă: <strong>BUILD_ARCHIVE = 1</strong></div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> <code>tools/opt/CMakeLists.txt</code></div>
<ul>
<li class="level2"><div class="li"> se adaugă noul pass în lista</div>
<ul>
<li class="level3"><div class="li"> <strong>set(LLVM_LINK_COMPONENTS ${LLVM_TARGETS_TO_BUILD} Analysis CodeGen Hello)</strong></div>
</li>
</ul>
</li>
<li class="level2"><div class="li"> la fel și pentru <code>tools/bugpoint/CMakeLists.txt</code></div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> se crează fişierul <code>include/llvm/Transforms/Hello.h</code> cu conţinutul </div>
<ul>
<li class="level2"><div class="li"> <pre class="code c"><span class="co2">#ifndef LLVM_TRANSFORMS_HELLO_H</span>
<span class="co2">#define LLVM_TRANSFORMS_HELLO_H</span>
namespace llvm <span class="br0">&#123;</span>
    class FunctionPass<span class="sy0">;</span>
        FunctionPass <span class="sy0">*</span>createHelloPass<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="co2">#endif</span></pre>
</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> se creeaza fișierul <code>lib/Transforms/Hello/LLVMBuild.txt</code> după formatul din <a href="http://llvm.org/docs/CommandGuide/llvm-build.html" class="urlextern" title="http://llvm.org/docs/CommandGuide/llvm-build.html"  rel="nofollow">sistemul de build</a> llvm.</div>
<ul>
<li class="level2"><div class="li"> ex: <pre class="code bash"><span class="br0">&#91;</span>component_0<span class="br0">&#93;</span>
<span class="kw3">type</span> = Library
name = Hello
parent = Transforms
library_name = hello
required_libraries = Analysis Support</pre>
</div>
</li>
<li class="level2"><div class="li"> se updatează și fișierul LLVMBuild.txt din directorul părinte pentru a include sub-directorul <code>Hello</code>. </div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> <code>lib/Transforms/Hello/CMakeLists.txt</code></div>
<ul>
<li class="level2"><div class="li"> se şterge <strong>add_llvm_loadable_module( LLVMHello Hello.cpp )</strong></div>
</li>
<li class="level2"><div class="li"> și se adaugă</div>
<ul>
<li class="level3"><div class="li"> <strong>add_llvm_library( LLVMHello Hello.cpp )</strong></div>
</li>
</ul>
</li>
</ul>
</li>
<li class="level1"><div class="li"> <code>lib/Transforms/Hello/Hello.cpp</code></div>
<ul>
<li class="level2"><div class="li"> se include</div>
<ul>
<li class="level3"><div class="li"> <strong>llvm/Transforms/Hello.h</strong></div>
</li>
</ul>
</li>
<li class="level2"><div class="li"> se adaugă</div>
<ul>
<li class="level3"><div class="li"><pre class="code c">FunctionPass<span class="sy0">*</span> llvm<span class="sy0">::</span><span class="me2">createHelloPass</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
   <span class="kw1">return</span> new Hello<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre>
</div>
</li>
</ul>
</li>
</ul>
</li>
<li class="level1"><div class="li"> <code>include/llvm/LinkAllPasses.h</code></div>
<ul>
<li class="level2"><div class="li"> se include <strong>llvm/Transforms/Hello.h</strong></div>
</li>
<li class="level2"><div class="li"> și se adaugă</div>
<ul>
<li class="level3"><div class="li"><pre class="code c"><span class="br0">&#40;</span><span class="kw4">void</span><span class="br0">&#41;</span> llvm<span class="sy0">::</span><span class="me2">createHelloPass</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>
</li>
</ul>
</li>
</ul>
</li>
<li class="level1"><div class="li"> se creeaza un director nou în care vor fi compilate sursele. De exemplu dacă sursele se află în directorul <strong>llvm-3.3.src</strong> și am creat pe același nivel directorul <strong>llvm</strong>, executăm din <strong>interiorul directorului nou creat</strong> comanda</div>
<ul>
<li class="level2"><div class="li"><pre class="code bash">cmake <span class="re5">-G</span> <span class="st0">&quot;Unix Makefiles&quot;</span> ..<span class="sy0">/</span>llvm-<span class="nu0">3.3</span>.src</pre>
</div>
</li>
<li class="level2"><div class="li"> urmată de comanda <pre class="code bash"> <span class="kw2">make</span> </pre>
</div>
</li>
</ul>
</li>
</ul>

</div>
<!-- EDIT5 SECTION "Integrarea unui pas în LLVM" [6701-] --></div>
</body>
</html>
