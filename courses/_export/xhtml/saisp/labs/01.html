    
    

<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <title>saisp:labs:01</title>
<meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="date" content="2016-02-28T23:44:58+0200"/>
<meta name="keywords" content="saisp,labs,01"/>
<link rel="search" type="application/opensearchdescription+xml" href="../../../../lib/exe/opensearch.php" title="CS Open CourseWare"/>
<link rel="start" href="../../../../../courses.1.html"/>
<link rel="alternate" type="application/rss+xml" title="Recent Changes" href="../../../../feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Current Namespace" href="../../../../feed.php%3Fmode=list&amp;ns=saisp:labs"/>
<link rel="alternate" type="text/html" title="Plain HTML" href="01.html"/>
<link rel="canonical" href="../../../../saisp/labs/01.html"/>
<link rel="stylesheet" type="text/css" href="../../../../lib/exe/css.php%3Ft=arctic&amp;tseed=1476798676.css"/>
<script type="text/javascript">/*<![CDATA[*/var NS='saisp:labs';var JSINFO = {"id":"saisp:labs:01","namespace":"saisp:labs","isadmin":0,"isauth":0};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../../../../lib/exe/js.php%3Ftseed=1476798676"></script>
<script type="text/x-mathjax-config">/*<![CDATA[*/MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ["$","$"], ["\\(","\\)"] ],
        displayMath: [ ["$$","$$"], ["\\[","\\]"] ],
        processEscapes: true
    }
});
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
<script type="text/javascript">/*<![CDATA[*/
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
		  
/*!]]>*/</script>
<script type="text/javascript">/*<![CDATA[*/
var pageTracker = _gat._getTracker("UA-38383934-1");
pageTracker._initData();
pageTracker._trackPageview();
		  
/*!]]>*/</script>
</head>
<body>
<div class="dokuwiki export">



<h1 class="sectionedit1" id="laborator_1_serviciul_ldap">Laborator 1. Serviciul LDAP</h1>
<div class="level1">

</div>
<!-- EDIT1 SECTION "Laborator 1. Serviciul LDAP" [12-54] -->
<h2 class="sectionedit2" id="cunostinte_si_abilitati_ce_vor_fi_dobandite">Cunoștințe și abilități ce vor fi dobândite</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Funcționarea protocolului LDAP. Cereri LDAP</div>
</li>
<li class="level1"><div class="li"> Căutarea în baza de date LDAP</div>
</li>
<li class="level1"><div class="li"> Folosirea bibliotecii client de LDAP</div>
</li>
<li class="level1"><div class="li"> Autentificarea pe bază de LDAP</div>
</li>
<li class="level1"><div class="li"> Integrarea LDAP cu alte aplicații</div>
</li>
</ul>

</div>
<!-- EDIT2 SECTION "Cunoștințe și abilități ce vor fi dobândite" [55-319] -->
<h2 class="sectionedit3" id="pregatire_infrastructura_de_laborator">Pregătire infrastructură de laborator</h2>
<div class="level2">

<p>
Vom rula o masină virtuală în <a href="http://cloud.curs.pub.ro" class="urlextern" title="http://cloud.curs.pub.ro"  rel="nofollow"> cloud-ul facultății</a>. Pentru a porni o astfel de masină urmăriți tutorialul de la <a href="https://cloud.curs.pub.ro/about/tutorial-for-students/" class="urlextern" title="https://cloud.curs.pub.ro/about/tutorial-for-students/"  rel="nofollow"> această adresă</a>. Când creați instanța de mașină virtuală (în fereastra “Launch instance”):
</p>
<ul>
<li class="level1"><div class="li"> La opțiunea <code>Availability zone</code> să alegeți <code>CI</code> sau <code>hp</code>.</div>
</li>
<li class="level3"><div class="li"> La opțiunea <code>Instance Boot Source</code> să alegeți <code>Boot from Image</code>.</div>
</li>
<li class="level3"><div class="li"> La opțiunea <code>Image Name</code> (apărută după ce efectuați pasul de mai sus) să alegeți imaginea <code>SAISP Template v1</code>.</div>
</li>
</ul>

<p>
Pentru a pregăti configurația de laborator, pe mașina virtuală folosiți comenzile următoare din contul utilizatorului <code>student</code>:
</p>
<ul>
<li class="level1"><div class="li"> <pre class="code -bash">student@mjolnir:~/saisp$ cd saisp/
student@mjolnir:~/saisp$ wget --user=user-curs --ask-password http://repository.grid.pub.ro/cs/saisp/laboratoare/lab-01.zip
student@mjolnir:~/saisp$ unzip lab-01.zip</pre>
</div>
</li>
</ul>

<p>
În urma dezarhivării rezultă trei fișiere imagine KVM (format <code>qcow2</code>) și un script de pornire a mașinilor virtuale. Imaginea de bază <code>base.qcow2</code> este baza pentru celelalte două fișiere: <code>ldap-client.qcow2</code> și <code>ldap-server.qcow2</code>.
</p>

<p>
Pentru pornirea celor două mașini virtuale (clientul de LDAP și serverul de LDAP) rulați scriptul de pornire:
</p>
<pre class="code -bash">student@mjolnir:~/saisp$ ./ldap-start-kvm</pre>

<p>
Pentru accesarea celor două mașini folosiți SSH către adresele IP aferente fiecăreia. Pentru conectarea la mașina virtuală pentru serverul de LDAP folosiți comanda
</p>
<pre class="code bash"><span class="co4">student@mjolnir:~/saisp$ </span><span class="kw2">ssh</span> <span class="re5">-l</span> root 192.168.0.2</pre>

<p>
iar pentru conectarea la clientul de LDAP folosiți comanda
</p>
<pre class="code bash"><span class="co4">student@mjolnir:~/saisp$ </span><span class="kw2">ssh</span> <span class="re5">-l</span> root 192.168.0.3</pre>

<p>
Parola pe cele două mașini virtuale este <code>student</code> atât pentru utilizatorul <code>root</code> cât și pentru utilizatorul <code>student</code>.
</p>
<div class="hiddenGlobal  hiddenActive"><div class="hiddenElements"></div><div class="hiddenHead  hiddenSinceBeginning"><div class="hiddenOnHidden">
<p>
Detalii rulare masina virtuala KVM local
</p>
</div><div class="hiddenOnVisible">
<p>
Detalii rulare masina virtuala KVM local
</p>
</div></div> <!-- .hiddenHead --><div class="hiddenBody">
<p>
Pentru a pregăti configurația de laborator va trebui să descărcați pe mașina fizică (mjolnir), în directorul saisp/, arhiva laboratorului (<code>base.qcow2</code> există deja):
</p>
<pre class="code -bash">student@mjolnir:~/saisp$ wget --user=user-curs --ask-password http://repository.grid.pub.ro/cs/saisp/laboratoare/base.qcow2
student@mjolnir:~/saisp$ wget --user=user-curs --ask-password http://repository.grid.pub.ro/cs/saisp/laboratoare/lab-01.zip
student@mjolnir:~/saisp$ unzip lab-01.zip</pre>

<p>
Puteți urma pașii de mai sus pentru a descărca infrastructura KVM pentru laborator pentru lucru acasă.
</p>
</div></div>
</div>
<!-- EDIT3 SECTION "Pregătire infrastructură de laborator" [320-2923] -->
<h2 class="sectionedit4" id="navigare">Navigare</h2>
<div class="level2">

<p>
<strong><span class="curid"><a href="../../../../saisp/labs/01.html" class="wikilink1" title="saisp:labs:01">Laboratorul 1</a></span></strong>
</p>

</div>
<!-- EDIT5 PLUGIN_INCLUDE_START "saisp:labs:01:meta:nav" [0-] --><div class="plugin_include_content plugin_include__saisp:labs:01:meta:nav">
<div class="level2">

<div><div id="nojs_indexmenu_46992407058356772b23a8" data-jsajax="%26skipfile%3D%252B/sidebar/" class="indexmenu_nojs">

<ul class="idx">
<li class="level1"><div class="li"><a href="../../../../saisp/labs/01/contents/01.html" class="wikilink1" title="saisp:labs:01:contents:01">01. [10p] Folosire client LDAP pentru interogare</a></div></li>
<li class="level1"><div class="li"><a href="../../../../saisp/labs/01/contents/02.html" class="wikilink1" title="saisp:labs:01:contents:02">02. [10p] Conectare securizată la serviciu de LDAP</a></div></li>
<li class="level1"><div class="li"><a href="../../../../saisp/labs/01/contents/03.html" class="wikilink1" title="saisp:labs:01:contents:03">03. [15p] Căutare în baza de date LDAP</a></div></li>
<li class="level1"><div class="li"><a href="../../../../saisp/labs/01/contents/04.html" class="wikilink1" title="saisp:labs:01:contents:04">04. [15p] Folosire programatică client de LDAP</a></div></li>
<li class="level1"><div class="li"><a href="../../../../saisp/labs/01/contents/05.html" class="wikilink1" title="saisp:labs:01:contents:05">05. [15p] Adăugare intrări în baza de date LDAP</a></div></li>
<li class="level1"><div class="li"><a href="../../../../saisp/labs/01/contents/06.html" class="wikilink1" title="saisp:labs:01:contents:06">06. [20p] Adăugare conturi de utilizatori în baza de date LDAP</a></div></li>
<li class="level1"><div class="li"><a href="../../../../saisp/labs/01/contents/07.html" class="wikilink1" title="saisp:labs:01:contents:07">07. [15p] Configurare suport de LDAP în DokuWiki</a></div></li>
<li class="level1"><div class="li"><a href="../../../../saisp/labs/01/contents/08.html" class="wikilink1" title="saisp:labs:01:contents:08">08. [BONUS - 10p] Configurare suport de LDAP în MediaWiki</a></div></li>
</ul>
</div></div>

</div>
<!-- EDIT6 PLUGIN_INCLUDE_END "saisp:labs:01:meta:nav" [0-] --></div>
<div class="level2">

</div>
<!-- EDIT4 SECTION "Navigare" [2924-3038] -->
<h2 class="sectionedit7" id="exercitii">Exerciții</h2>
<div class="level2">

</div>
<!-- EDIT8 PLUGIN_INCLUDE_START "saisp:labs:01:contents:01" [0-] --><div class="plugin_include_content plugin_include__saisp:labs:01:contents:01">

<h3 class="sectionedit10" id="p_folosire_client_ldap_pentru_interogare">01. [10p] Folosire client LDAP pentru interogare</h3>
<div class="level3">

<p>
Pentru început, ne propunem să interogăm baza de date LDAP. Cererile de interogare sunt adresate unui server, care accesează baza de date din spate și returnează informații dintr-un director. Comanda folosită pentru interogare este <code>ldapsearch</code>.
</p>

<p>
O modalitate simplă de interogare LDAP este chiar din cadrul serverului LDAP. Pe serverul LDAP, rulați comanda
</p>
<pre class="code bash"><span class="co4">root@ldap-server:~# </span>ldapsearch <span class="re5">-x</span> <span class="re5">-b</span> <span class="st0">&quot;dc=labs,dc=cs,dc=pub,dc=ro&quot;</span>
<span class="co0"># extended LDIF</span>
<span class="co0">#</span>
<span class="co0"># LDAPv3</span>
<span class="co0"># base &lt;dc=labs,dc=cs,dc=pub,dc=ro&gt; with scope subtree</span>
<span class="co0"># filter: (objectclass=*)</span>
<span class="co0"># requesting: ALL</span>
<span class="co0">#</span>
&nbsp;
<span class="co0"># labs.cs.pub.ro</span>
dn: <span class="re2">dc</span>=labs,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
<span class="br0">&#91;</span>...<span class="br0">&#93;</span></pre>

<p>
Comanda realizează o interogare a serverului LDAP și întoarce intrările aferente arborelui/directorului <code>dc=labs,dc=cs,dc=pub,dc=ro</code>.
</p>

<p>
Opțiuna <code>-x</code> folosește autentificare simplă, în loc de SASL. În cazul de față este vorba de o conectare anonimă, fără interogare. Opțiunea <code>-b</code> a comenzii <code>ldapsearch</code> indică punctul din arborele/directorul LDAP de unde se face parcurgerea.
</p>

<p>
Dacă vrem să nu afișăm informații despre versiunea LDAP sau comentarii LDIF, atunci putem folosi opțiunea <code>-LLL</code>:
</p>
<pre class="code bash"><span class="co4">root@ldap-server:~# </span>ldapsearch <span class="re5">-x</span> <span class="re5">-LLL</span> <span class="re5">-b</span> <span class="st0">&quot;dc=labs,dc=cs,dc=pub,dc=ro&quot;</span>
dn: <span class="re2">dc</span>=labs,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
<span class="br0">&#91;</span>...<span class="br0">&#93;</span></pre>

<p>
Ca să interogăm serverul de LDAP <strong>de pe stația client</strong> va trebui să precizăm care este <abbr title="Uniform Resource Identifier">URI</abbr>-ul serverului. Pentru a obține un rezultat similar, pe stația client trebuie să rulăm comanda de mai jos:
</p>
<pre class="code bash"><span class="co4">root@ldap-client:~# </span>ldapsearch <span class="re5">-x</span> <span class="re5">-LLL</span> <span class="re5">-H</span> ldap:<span class="sy0">//</span>ldap-server.local <span class="re5">-b</span> <span class="st0">&quot;dc=labs,dc=cs,dc=pub,dc=ro&quot;</span>
dn: <span class="re2">dc</span>=labs,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
<span class="br0">&#91;</span>...<span class="br0">&#93;</span></pre>

<p>
Opțiunea <code>-H</code> indică <abbr title="Uniform Resource Identifier">URI</abbr>-ul serverului la care se face conectarea. În cazul de fața este vorba de numele (în forma multicast <abbr title="Domain Name System">DNS</abbr> al) serverului prefixat de șirul <code>ldap://</code>.
</p>

<p>
În general, conexiunile LDAP de pe un client se fac către un același server așa că se pot reține <abbr title="Uniform Resource Identifier">URI</abbr>-ul de conectare și punctul de căutare de arbore în fișierul de configurare <code>/etc/ldap/ldap.conf</code>. Vom completa, folosind un editor, în fișierul de configurare <code>/etc/ldap/ldap.conf</code> directivele de configurare <code>BASE</code> (punctul de căutare – <em>search base</em>) și <code><abbr title="Uniform Resource Identifier">URI</abbr></code> (<abbr title="Uniform Resource Identifier">URI</abbr>-ul serverului). În final fișierul de configurare pe client va avea forma de mai jos:
</p>
<pre class="code bash"><span class="co4">root@ldap-client:~# </span><span class="kw2">cat</span> <span class="sy0">/</span>etc<span class="sy0">/</span>ldap<span class="sy0">/</span>ldap.conf
<span class="co0">#</span>
<span class="co0"># LDAP Defaults</span>
<span class="co0">#</span>
&nbsp;
<span class="co0"># See ldap.conf(5) for details</span>
<span class="co0"># This file should be world readable but not world writable.</span>
&nbsp;
BASE	<span class="re2">dc</span>=labs,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
URI	ldap:<span class="sy0">//</span>ldap-server.local
&nbsp;
<span class="co0">#SIZELIMIT	12</span>
<span class="co0">#TIMELIMIT	15</span>
<span class="co0">#DEREF		never</span>
&nbsp;
<span class="co0"># TLS certificates (needed for GnuTLS)</span>
TLS_CACERT	<span class="sy0">/</span>etc<span class="sy0">/</span>ssl<span class="sy0">/</span>certs<span class="sy0">/</span>ca-certificates.crt</pre>

<p>
Directivele <code>BASE</code> și <code><abbr title="Uniform Resource Identifier">URI</abbr></code> sunt configurate și nu mai este nevoie de folosirea opțiunilor <code>-b</code> (pentru <code>BASE</code>), respectiv <code>-H</code> (pentru <code><abbr title="Uniform Resource Identifier">URI</abbr></code>) pentru comanda <code>ldapsearch</code> pe stația client. Acum putem rula comanda simplu:
</p>
<pre class="code bash"><span class="co4">root@ldap-client:~# </span>ldapsearch <span class="re5">-x</span> <span class="re5">-LLL</span>
dn: <span class="re2">dc</span>=labs,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
<span class="br0">&#91;</span>...<span class="br0">&#93;</span></pre>

</div>
<!-- EDIT10 SECTION "01. [10p] Folosire client LDAP pentru interogare" [1-] --><!-- EDIT9 PLUGIN_INCLUDE_END "saisp:labs:01:contents:01" [0-] --></div>
<div class="level2">

</div>
<!-- EDIT11 PLUGIN_INCLUDE_START "saisp:labs:01:contents:02" [0-] --><div class="plugin_include_content plugin_include__saisp:labs:01:contents:02">

<h3 class="sectionedit13" id="p_conectare_securizata_la_serviciu_de_ldap">02. [10p] Conectare securizată la serviciu de LDAP</h3>
<div class="level3">

<p>
Informațiile accesibile prin LDAP sunt, în general, sensibile și este necesară securizarea comunicației. Pentru aceasta serverul LDAP poate fi configurat să folosească LDAPS (LDAP cu suport SSL) sau să folosească TLS.
</p>

</div>

<h4 id="folosire_ldaps_ldap_ssl">Folosire LDAPS (LDAP+SSL)</h4>
<div class="level4">

<p>
În cazul în care folosește LDAPS, serverul LDAP ascultă conexiuni pe portul <code>636</code> (portul aferent LDAPS), lucru care se poate observa cu ajutorul comenzii <code>netstat</code>:
</p>
<pre class="code bash"><span class="co4">root@ldap-server:~# </span><span class="kw2">netstat</span> <span class="re5">-tlpn</span> <span class="sy0">|</span> <span class="kw2">grep</span> slapd
tcp        <span class="nu0">0</span>      <span class="nu0">0</span> 0.0.0.0:<span class="nu0">636</span>             0.0.0.0:<span class="sy0">*</span>               LISTEN      <span class="nu0">1902</span><span class="sy0">/</span>slapd      
tcp        <span class="nu0">0</span>      <span class="nu0">0</span> 0.0.0.0:<span class="nu0">389</span>             0.0.0.0:<span class="sy0">*</span>               LISTEN      <span class="nu0">1902</span><span class="sy0">/</span>slapd      
tcp6       <span class="nu0">0</span>      <span class="nu0">0</span> :::<span class="nu0">636</span>                  :::<span class="sy0">*</span>                    LISTEN      <span class="nu0">1902</span><span class="sy0">/</span>slapd      
tcp6       <span class="nu0">0</span>      <span class="nu0">0</span> :::<span class="nu0">389</span>                  :::<span class="sy0">*</span>                    LISTEN      <span class="nu0">1902</span><span class="sy0">/</span>slapd </pre>

<p>
Serverul LDAP ascultă, așadar, conexiuni nesecurizate pe portul <code>389</code> și conexiuni securizate (LDAPS) pe portul <code>636</code>. Serverul LDAP poartă numele <code>slapd</code> (<em>Standalone LDAP Daemon</em>).
</p>

<p>
De pe client dacă vrem să folosim conexiune securizată, vom folosi <abbr title="Uniform Resource Identifier">URI</abbr>-ul începând cu șirul <code>ldaps://</code>:
</p>
<pre class="code bash"><span class="co4">root@ldap-client:~# </span>ldapsearch <span class="re5">-x</span> <span class="re5">-LLL</span> <span class="re5">-H</span> ldaps:<span class="sy0">//</span>ldap-server.local
ldap_sasl_bind<span class="br0">&#40;</span>SIMPLE<span class="br0">&#41;</span>: Can<span class="st_h">'t contact LDAP server (-1)</span></pre>

<p>
Obținem o eroare de conectare. În cazul conexiunilor LDAPS aceasta sa datorează configurării necorespunzătoare a certificatelor. Întrucât pe serverul LDAP(S) am configurat un certificat self-signed, vom ignora verificarea certificatelor. Pentru aceasta folosim un editor pentru a adăuga linia de mai jos la sfârșitul fișierului <code>/etc/ldap/ldap.conf</code> de pe stația client:
</p>
<pre class="code bash">TLS_REQCERT	never</pre>

<p>
Acum conexiune va funcționa peste LDAPS:
</p>
<pre class="code bash"><span class="co4">root@ldap-client:~# </span>ldapsearch <span class="re5">-x</span> <span class="re5">-LLL</span> <span class="re5">-H</span> ldaps:<span class="sy0">//</span>ldap-server.local
dn: <span class="re2">dc</span>=labs,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
<span class="br0">&#91;</span>...<span class="br0">&#93;</span></pre>

<p>
Dacă dorim, putem actualiza directiva <code><abbr title="Uniform Resource Identifier">URI</abbr></code> din fișierul <code>/etc/ldap/ldap.conf</code> pentru a realiza implicit conexiuni pe LDAPS:
</p>
<pre class="code bash">URI	ldaps:<span class="sy0">//</span>ldap-server.local</pre>

<p>
<p><div class="noteimportant">
Folosirea liniei
</p>
<pre class="code">TLS_REQCERT     never</pre>

<p>
 în fișierul <code>/etc/ldap/ldap.conf</code> permite conexiunea LDAPS ignorând validitatea certificatului serverului. Este o configurare rapidă, dar cu probleme de securitate. Pentru servere de producție este nevoie de verificarea validității certificatului folosind directive precum <code>TLS_CACERT</code> sau <code>TLS_CACERTDIR</code>.

</div></p>
</p>

</div>

<h4 id="folosire_ldap_cu_tls">Folosire LDAP cu TLS</h4>
<div class="level4">

<p>
Un alt mod de a securiza comunicația LDAP este prin intermediul suportului TLS. Suportul TLS nu necesită ca serverul să asculte conexiuni pe alt port. Se folosește inițial protocolul LDAP în clar și apoi se declanșează handshake-ul TLS în urma căruia comunicația va fi securizată. Pentru a realiza o conexiune securizată cu suport TLS, folosim opțiunea <code>-Z</code> a comenzii <code>ldapsearch</code>, la fel ca mai jos (pe stația client):
</p>
<pre class="code bash"><span class="co4">root@ldap-client:~# </span>ldapsearch <span class="re5">-x</span> <span class="re5">-LLL</span> <span class="re5">-Z</span> <span class="re5">-H</span> ldap:<span class="sy0">//</span>ldap-server.local
dn: <span class="re2">dc</span>=labs,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro</pre>

<p>
În general, serverul LDAP va fi configurat în așa fel încât să impună folosirea TLS pentru operațiile sensibile. În această situația absența opțiunii <code>-Z</code> va conduce la afișarea unui mesaj de eroare pe client.
</p>

</div>

<h4 id="exercitiuinterogare_swarmcspubro">Exercițiu: Interogare swarm.cs.pub.ro</h4>
<div class="level4">

<p>
Pe serverul <code>swarm.cs.pub.ro</code> rulează un server LDAP. Punctul de cautare în arbore este <code>dc=swarm,dc=cs,dc=pub,dc=ro</code>. Interogați serverul LDAP folosind LDAP, LDAPS și LDAP cu suport SSL. Ce moduri de interogare sunt disponibile pe server?
</p>

</div>
<!-- EDIT13 SECTION "02. [10p] Conectare securizată la serviciu de LDAP" [1-] --><!-- EDIT12 PLUGIN_INCLUDE_END "saisp:labs:01:contents:02" [0-] --></div>
<div class="level2">

</div>
<!-- EDIT14 PLUGIN_INCLUDE_START "saisp:labs:01:contents:03" [0-] --><div class="plugin_include_content plugin_include__saisp:labs:01:contents:03">

<h3 class="sectionedit16" id="p_cautare_in_baza_de_date_ldap">03. [15p] Căutare în baza de date LDAP</h3>
<div class="level3">

<p>
Output-ul comenzii de interogare LDAP a serverului <code>swarm.cs.pub.ro</code> este consistent. De multe ori dorim să căutăm în baza de date LDAP și să extragem doar anumite intrări similar comenzii <code>select</code> din SQL.
</p>

</div>

<h4 id="informatii_din_subarbori">Informații din subarbori</h4>
<div class="level4">

<p>
Un prim mod de căutare este selectarea doar a intrării căutate (fără subarbore) sau doar a primului nivel din arbore, ca mai jos:
</p>
<pre class="code bash"><span class="co4">root@ldap-client:~# </span>ldapsearch <span class="re5">-x</span> <span class="re5">-LLL</span> <span class="re5">-s</span> base <span class="re5">-H</span> ldaps:<span class="sy0">//</span>swarm.cs.pub.ro <span class="re5">-b</span> <span class="st0">&quot;dc=swarm,dc=cs,dc=pub,dc=ro&quot;</span>
dn: <span class="re2">dc</span>=swarm,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
objectClass: top
objectClass: dcObject
objectClass: organization
o: University Politehnica of Bucharest
dc: swarm
&nbsp;
&nbsp;
<span class="co4">root@ldap-client:~# </span>ldapsearch <span class="re5">-x</span> <span class="re5">-LLL</span> <span class="re5">-s</span> one <span class="re5">-H</span> ldaps:<span class="sy0">//</span>swarm.cs.pub.ro <span class="re5">-b</span> <span class="st0">&quot;dc=swarm,dc=cs,dc=pub,dc=ro&quot;</span>
dn: <span class="re2">cn</span>=admin,<span class="re2">dc</span>=swarm,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
objectClass: simpleSecurityObject
objectClass: organizationalRole
cn: admin
description: LDAP administrator
&nbsp;
dn: <span class="re2">ou</span>=People,<span class="re2">dc</span>=swarm,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
ou: People
objectClass: organizationalUnit
&nbsp;
dn: <span class="re2">ou</span>=Group,<span class="re2">dc</span>=swarm,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
ou: Group
objectClass: organizationalUnit</pre>

<p>
Prima comandă extrage doar intrarea de bază, identificată de <em>domain name</em>-ul (DN) <code>dc=swarm,dc=cs,dc=pub,dc=ro</code>. A doua extrage primul nivel din arborele/directorul LDAP, adică intrarile indentificate de DN-urile <code>cn=admin,dc=swarm,dc=cs,dc=pub,dc=ro</code>, <code>ou=People,dc=swarm,dc=cs,dc=pub,dc=ro</code>, <code>ou=Group,dc=swarm,dc=cs,dc=pub,dc=ro</code>.
</p>

<p>
Un mod uzual de căutare este doar într-un subarbore al directorului LDAP. Astfel, dacă dorim să extragem doar intrările din grupuri, vom folosi comanda:
</p>
<pre class="code bash"><span class="co4">root@ldap-client:~# </span>ldapsearch <span class="re5">-x</span> <span class="re5">-LLL</span> <span class="re5">-H</span> ldaps:<span class="sy0">//</span>swarm.cs.pub.ro <span class="re5">-b</span> <span class="st0">&quot;ou=Group,dc=swarm,dc=cs,dc=pub,dc=ro&quot;</span>
dn: <span class="re2">ou</span>=Group,<span class="re2">dc</span>=swarm,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
ou: Group
objectClass: organizationalUnit
&nbsp;
dn: <span class="re2">cn</span>=rosedu,<span class="re2">ou</span>=Group,<span class="re2">dc</span>=swarm,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
cn: rosedu
<span class="br0">&#91;</span>...<span class="br0">&#93;</span></pre>

</div>

<h4 id="extragere_de_atribute">Extragere de atribute</h4>
<div class="level4">

<p>
Așa cum comanda <code>select</code> din SQL extrage doar anumite coloane dintr-un tabel, putem selecta, folosind comanda <code>ldapsearch</code> anumite atribute ale intrărilor în baza de date LDAP.
</p>

<p>
Spre exemplu, dacă vrem să afișăm doar uid-ul utilizatorilor din baza de date LDAP, vom folosi comanda
</p>
<pre class="code bash"><span class="co4">root@ldap-client:~# </span>ldapsearch <span class="re5">-x</span> <span class="re5">-LLL</span> <span class="re5">-H</span> ldaps:<span class="sy0">//</span>swarm.cs.pub.ro <span class="re5">-b</span> <span class="st0">&quot;dc=swarm,dc=cs,dc=pub,dc=ro&quot;</span> uid
<span class="br0">&#91;</span>...<span class="br0">&#93;</span>
dn: <span class="re2">uid</span>=ddvlad,<span class="re2">ou</span>=People,<span class="re2">dc</span>=swarm,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
uid: ddvlad
&nbsp;
dn: <span class="re2">uid</span>=roxanam,<span class="re2">ou</span>=People,<span class="re2">dc</span>=swarm,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
uid: roxanam
&nbsp;
dn: <span class="re2">uid</span>=razvan,<span class="re2">ou</span>=People,<span class="re2">dc</span>=swarm,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
uid: razvan</pre>

<p>
Folosirea atributului <code>uid</code> la sfârșitul comenzii de mai sus înseamnă selectarea doar a acelui câmp.
</p>

<p>
<p><div class="noteclassic">
Câmpul <code>dn</code> va fi întotdeauna selectat pentru că indică în mod unic intrarea în LDAP.

</div></p>
</p>

<p>
Dacă dorim să selectăm uid-ul, adresa de e-mail și numele vom folosi comanda
</p>
<pre class="code bash"><span class="co4">root@ldap-client:~# </span>ldapsearch <span class="re5">-x</span> <span class="re5">-LLL</span> <span class="re5">-H</span> ldaps:<span class="sy0">//</span>swarm.cs.pub.ro <span class="re5">-b</span> <span class="st0">&quot;dc=swarm,dc=cs,dc=pub,dc=ro&quot;</span> uid mail cn
<span class="br0">&#91;</span>...<span class="br0">&#93;</span>
dn: <span class="re2">uid</span>=ddvlad,<span class="re2">ou</span>=People,<span class="re2">dc</span>=swarm,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
uid: ddvlad
cn: Vlad Dogaru
mail: XXXXXXX
&nbsp;
dn: <span class="re2">uid</span>=roxanam,<span class="re2">ou</span>=People,<span class="re2">dc</span>=swarm,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
uid: roxanam
cn: Roxana Murarus
mail: XXXXXXX
&nbsp;
dn: <span class="re2">uid</span>=razvan,<span class="re2">ou</span>=People,<span class="re2">dc</span>=swarm,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
uid: razvan
cn: Razvan Deaconescu
mail: XXXXXXX</pre>

<p>
Altfel spus, pentru a selecta mai multe atribute le transmitem ca argument comenzii <code>ldapsearch</code>.
</p>

</div>

<h4 id="filtrare_dupa_atribute">Filtrare după atribute</h4>
<div class="level4">

<p>
În SQL, clauza <code>where</code> permite selectarea doar anumitor intrări. La fel permite și comanda <code>ldapsearch</code> folosirea de filtre de căutare.
</p>

<p>
Astfel, pentru a selecta intrările de utilizator al căror prenume este <code>Silviu</code> vom folosi comanda
</p>
<pre class="code bash"><span class="co4">root@ldap-client:~# </span>ldapsearch <span class="re5">-x</span> <span class="re5">-LLL</span> <span class="re5">-H</span> ldaps:<span class="sy0">//</span>swarm.cs.pub.ro <span class="re5">-b</span> <span class="st0">&quot;dc=swarm,dc=cs,dc=pub,dc=ro&quot;</span> <span class="re2">givenName</span>=Silviu
dn: <span class="re2">uid</span>=silviu,<span class="re2">ou</span>=People,<span class="re2">dc</span>=swarm,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
uid: silviu
cn: Silviu Grijincu
<span class="br0">&#91;</span>...<span class="br0">&#93;</span></pre>

<p>
Dacă vrem să aflăm informații despre contul aferent lui Mihai Carabaș, și nu știm uid-ul său, vom folosi comanda
</p>
<pre class="code bash"><span class="co4">root@ldap-client:~# </span>ldapsearch <span class="re5">-x</span> <span class="re5">-LLL</span> <span class="re5">-H</span> ldaps:<span class="sy0">//</span>swarm.cs.pub.ro <span class="re5">-b</span> <span class="st0">&quot;dc=swarm,dc=cs,dc=pub,dc=ro&quot;</span> <span class="re2">cn</span>=<span class="st0">&quot;Mihai Carabas&quot;</span>
dn: <span class="re2">uid</span>=mihaic,<span class="re2">ou</span>=People,<span class="re2">dc</span>=swarm,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
uid: mihaic
sn: Carabas
<span class="br0">&#91;</span>...<span class="br0">&#93;</span></pre>

<p>
Dacă știam uid-ul căutam direct după uid:
</p>
<pre class="code bash"><span class="co4">root@ldap-client:~# </span>ldapsearch <span class="re5">-x</span> <span class="re5">-LLL</span> <span class="re5">-H</span> ldaps:<span class="sy0">//</span>swarm.cs.pub.ro <span class="re5">-b</span> <span class="st0">&quot;dc=swarm,dc=cs,dc=pub,dc=ro&quot;</span> <span class="re2">uid</span>=mihaic
dn: <span class="re2">uid</span>=mihaic,<span class="re2">ou</span>=People,<span class="re2">dc</span>=swarm,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
uid: mihaic
sn: Carabas
<span class="br0">&#91;</span>...<span class="br0">&#93;</span></pre>

<p>
Filtrele de căutare (<em>search filters</em>) sunt expresii care fac match pe anumite atribute din intrările LDAP și le afișează doar pe acelea. Filtrele pot conține și <em>glob</em>-uri pentru a permite match pe mai multe valori ale atributelor. Astfel, pentru a selecta toate persoanele al căror nume de familie începe cu șirul <code>An</code> folosim expresia:
</p>
<pre class="code bash"><span class="co4">root@ldap-client:~# </span>ldapsearch <span class="re5">-x</span> <span class="re5">-LLL</span> <span class="re5">-H</span> ldaps:<span class="sy0">//</span>swarm.cs.pub.ro <span class="re5">-b</span> <span class="st0">&quot;dc=swarm,dc=cs,dc=pub,dc=ro&quot;</span> <span class="re2">sn</span>=<span class="st0">&quot;An*&quot;</span>
dn: <span class="re2">uid</span>=aandrei,<span class="re2">ou</span>=People,<span class="re2">dc</span>=swarm,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
uid: aandrei
cn: Alexandru Andrei
sn: Andrei
<span class="br0">&#91;</span>...<span class="br0">&#93;</span></pre>

<p>
Atributul <code>sn</code> înseamnă numele de familie (<em>surname</em>) iar <em>glob</em>-ul <code>An*</code> însemnă șirurile care încep cu <code>An</code>.
</p>

<p>
La fel cum comanda <code>select</code> este combinată cu <code>where</code>, vom putea selecta doar anumite atribute ale unor intrări. Dacă dorim să afișăm dar cn-ul și e-mail-ul rezultatelor comenzii de mai sus, vom folosi comanda
</p>
<pre class="code bash"><span class="co4">root@ldap-client:~# </span>ldapsearch <span class="re5">-x</span> <span class="re5">-LLL</span> <span class="re5">-H</span> ldaps:<span class="sy0">//</span>swarm.cs.pub.ro <span class="re5">-b</span> <span class="st0">&quot;dc=swarm,dc=cs,dc=pub,dc=ro&quot;</span> <span class="re2">sn</span>=<span class="st0">&quot;An*&quot;</span> cn mail
dn: <span class="re2">uid</span>=aandrei,<span class="re2">ou</span>=People,<span class="re2">dc</span>=swarm,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
cn: Alexandru Andrei
mail: XXXXXXX
<span class="br0">&#91;</span>...<span class="br0">&#93;</span></pre>

<p>
În cazul acesta, după comanda de căutare am precizat filtrul de căutare (<code>sn=“An*”</code>) și apoi atributele care vor fi selectate (<code>cn mail</code>).
</p>

</div>

<h4 id="exercitii_de_cautare">Exerciții de căutare</h4>
<div class="level4">

<p>
Realizați următoarele căutări în baza de date LDAP de pe <code>swarm.cs.pub.ro</code>:
</p>
<ol>
<li class="level1"><div class="li"> Extrageți utilizatorii al căror nume de familie este <code>Popescu</code>.</div>
</li>
<li class="level1"><div class="li"> Extrageți uid-ul și cn-ul utilizatorilor a căror adresă de e-mail conține șirul <code>@cti.pub.ro</code>.</div>
</li>
<li class="level1"><div class="li"> Extrageți utilizatorii al căror nume de familie nu se termină în <code>escu</code>.</div>
</li>
<li class="level1"><div class="li"> Extrageți utilizatorii al căror prenume este <code>Vlad</code> <strong>sau</strong> <code>Andrei</code>.</div>
</li>
<li class="level1"><div class="li"> Extrageți uid-ul, e-mail-ul și numele de familie al utilizatorilor al căror prenume este <code>Vlad</code> sau <code>Andrei</code>.</div>
</li>
</ol>

<p>
<p><div class="noteimportant">
Detalii legate de folosirea filtrelor de căutare găsiți la pagina <a href="http://www.centos.org/docs/5/html/CDS/ag/8.0/Finding_Directory_Entries-LDAP_Search_Filters.html" class="urlextern" title="http://www.centos.org/docs/5/html/CDS/ag/8.0/Finding_Directory_Entries-LDAP_Search_Filters.html"  rel="nofollow">http://www.centos.org/docs/5/html/CDS/ag/8.0/Finding_Directory_Entries-LDAP_Search_Filters.html</a>.
</p>

<p>
Este recomandat să puneți expresiile de filtrare între apostroafe sau ghilimele ca să preveniți interpretarea caracterelor speciale de shell.

</div></p>
</p>

</div>
<!-- EDIT16 SECTION "03. [15p] Căutare în baza de date LDAP" [1-] --><!-- EDIT15 PLUGIN_INCLUDE_END "saisp:labs:01:contents:03" [0-] --></div>
<div class="level2">

</div>
<!-- EDIT17 PLUGIN_INCLUDE_START "saisp:labs:01:contents:04" [0-] --><div class="plugin_include_content plugin_include__saisp:labs:01:contents:04">

<h3 class="sectionedit19" id="p_folosire_programatica_client_de_ldap">04. [15p] Folosire programatică client de LDAP</h3>
<div class="level3">

<p>
Pe stația client este instalat pachetul <code>python-ldap</code> util pentru programarea unui client LDAP în Python.
</p>

<p>
Fișierul de mai jos implementează căutarea intrărilor LDAP pentru utilizatorii al căror atribut <code>cn</code> începe cu <code>Mihai</code> și afișează pentru aceștia atributele <code>cn</code> și <code>e-mail</code>.
</p>
<dl class="file">
<dt><a href="../../../code/saisp/labs/01%3Fcodeblock=28" title="Download Snippet" class="mediafile mf_py">simple-ldap.py</a></dt>
<dd><pre class="code file python"><span class="co1">#!/usr/bin/env python</span>
&nbsp;
<span class="kw1">import</span> <span class="kw3">sys</span>
<span class="kw1">import</span> ldap
&nbsp;
<span class="kw1">def</span> main<span class="br0">&#40;</span><span class="br0">&#41;</span>:
    ldap.<span class="me1">set_option</span><span class="br0">&#40;</span>ldap.<span class="me1">OPT_PROTOCOL_VERSION</span><span class="sy0">,</span> <span class="nu0">3</span><span class="br0">&#41;</span>
    l <span class="sy0">=</span> ldap.<span class="me1">initialize</span><span class="br0">&#40;</span><span class="st0">&quot;ldaps://swarm.cs.pub.ro&quot;</span><span class="br0">&#41;</span>
    entries <span class="sy0">=</span> l.<span class="me1">search_s</span><span class="br0">&#40;</span><span class="st0">&quot;ou=People,dc=swarm,dc=cs,dc=pub,dc=ro&quot;</span><span class="sy0">,</span> ldap.<span class="me1">SCOPE_SUBTREE</span><span class="sy0">,</span> <span class="st0">'(cn=Mihai*)'</span><span class="sy0">,</span> <span class="br0">&#91;</span><span class="st0">'cn'</span><span class="sy0">,</span> <span class="st0">'mail'</span><span class="br0">&#93;</span><span class="br0">&#41;</span>
&nbsp;
    <span class="kw1">for</span> dn<span class="sy0">,</span> attrs <span class="kw1">in</span> entries:
        <span class="kw1">print</span> <span class="st0">'Found:'</span><span class="sy0">,</span> <span class="kw3">repr</span><span class="br0">&#40;</span>dn<span class="br0">&#41;</span>
        <span class="kw1">print</span> attrs
&nbsp;
<span class="kw1">if</span> __name__ <span class="sy0">==</span> <span class="st0">&quot;__main__&quot;</span>:
    <span class="kw3">sys</span>.<span class="me1">exit</span><span class="br0">&#40;</span>main<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span></pre>
</dd></dl>

<p>
Fișierul se găsește și pe stația client, în directorul <code>/root/</code>, și îl putem rula:
</p>
<pre class="code bash"><span class="co4">root@ldap-client:~# </span>python simple-ldap.py 
Found: <span class="st_h">'uid=mihai,ou=People,dc=swarm,dc=cs,dc=pub,dc=ro'</span>
<span class="br0">&#123;</span><span class="st_h">'mail'</span>: <span class="br0">&#91;</span><span class="st_h">'XXXXXX@gmail.com'</span><span class="br0">&#93;</span>, <span class="st_h">'cn'</span>: <span class="br0">&#91;</span><span class="st_h">'Mihai Maruseac'</span><span class="br0">&#93;</span><span class="br0">&#125;</span>
Found: <span class="st_h">'uid=moro,ou=People,dc=swarm,dc=cs,dc=pub,dc=ro'</span>
<span class="br0">&#123;</span><span class="st_h">'mail'</span>: <span class="br0">&#91;</span><span class="st_h">'XXXXXX@gmail.com'</span><span class="br0">&#93;</span>, <span class="st_h">'cn'</span>: <span class="br0">&#91;</span><span class="st_h">'Mihai Morogan'</span><span class="br0">&#93;</span><span class="br0">&#125;</span>
<span class="br0">&#91;</span>...<span class="br0">&#93;</span></pre>

<p>
Actualizați scriptul astfel încât sa extragă din intrările de mai sus acele intrări ale căror adresă de e-mail conține șirul <code>@gmail.com</code>. Apoi afișați doar atributele <code>uid</code>, <code>cn</code> și <code>email</code> pe o singură linie, separate prin virgulă, la fel ca mai jos:
</p>
<pre class="code">mihai, Mihai Maruseac, XXXXXX@gmail.com
moro, Mihai Morogan, XXXXXX@gmail.com</pre>

<p>
<p><div class="noteclassic">
Variabila <code>attrs</code> este un dicționar. Pentru a obține fiecare element numit <code>item</code> dintr-un dicționar <code>d</code> folosiți construcția <code>d[&#039;item&#039;]</code>.
</p>

<p>
Fiecare element din dicționarul <code>attrs</code> este o listă. Pentru a obține primul element (cel căutat) din listă, folosiți o expresie de forma <code>l[0]</code>, unde <code>l</code> este lista.

</div></p>
</p>

</div>
<!-- EDIT19 SECTION "04. [15p] Folosire programatică client de LDAP" [1-] --><!-- EDIT18 PLUGIN_INCLUDE_END "saisp:labs:01:contents:04" [0-] --></div>
<div class="level2">

</div>
<!-- EDIT20 PLUGIN_INCLUDE_START "saisp:labs:01:contents:05" [0-] --><div class="plugin_include_content plugin_include__saisp:labs:01:contents:05">

<h3 class="sectionedit22" id="p_adaugare_intrari_in_baza_de_date_ldap">05. [15p] Adăugare intrări în baza de date LDAP</h3>
<div class="level3">

<p>
Vrem să populăm baza de date LDAP cu intrări. Pentru aceasta trebuie redactate fișiere de configurare în format LDIF care să fie apoi adăuagate în baza de date LDAP.
</p>

<p>
Fișierele de configurare se găsesc în format LDIF pe stația client în directorul <code>/etc/ldap/ldif/</code>:
</p>
<pre class="code bash">root<span class="sy0">@</span>ldap-client:<span class="sy0">/</span>etc<span class="sy0">/</span>ldap<span class="sy0">/</span>ldif<span class="co0"># ls</span>
o-protoss.ldif    ou-khalai.ldif   uid-amengsk.ldif  uid-zeratul.ldif
o-terran.ldif     ou-nerazim.ldif  uid-artanis.ldif
ou-dominion.ldif  ou-raiders.ldif  uid-raynor.ldif</pre>

<p>
Pentru a adăuga intrări în baza de date LDAP folosim comanda <code>ldapadd</code>. Trebuie să precizăm care este <code>dn</code>-ul contului de administrator (parola este <code>student</code>):
</p>
<pre class="code bash">root<span class="sy0">@</span>ldap-client:<span class="sy0">/</span>etc<span class="sy0">/</span>ldap<span class="sy0">/</span>ldif<span class="co0"># ldapadd -x -D cn=admin,dc=labs,dc=cs,dc=pub,dc=ro -W -f o-terran.ldif </span>
Enter LDAP Password: 
adding new entry <span class="st0">&quot;o=Terran,dc=labs,dc=cs,dc=pub,dc=ro&quot;</span>
&nbsp;
root<span class="sy0">@</span>ldap-client:<span class="sy0">/</span>etc<span class="sy0">/</span>ldap<span class="sy0">/</span>ldif<span class="co0"># ldapadd -x -D cn=admin,dc=labs,dc=cs,dc=pub,dc=ro -W -f ou-dominion.ldif </span>
Enter LDAP Password: 
adding new entry <span class="st0">&quot;ou=Dominion,o=Terran,dc=labs,dc=cs,dc=pub,dc=ro&quot;</span>
&nbsp;
root<span class="sy0">@</span>ldap-client:<span class="sy0">/</span>etc<span class="sy0">/</span>ldap<span class="sy0">/</span>ldif<span class="co0"># ldapadd -x -D cn=admin,dc=labs,dc=cs,dc=pub,dc=ro -W -f ou-raiders.ldif </span>
Enter LDAP Password: 
adding new entry <span class="st0">&quot;ou=Raiders,o=Terran,dc=labs,dc=cs,dc=pub,dc=ro&quot;</span>
&nbsp;
root<span class="sy0">@</span>ldap-client:<span class="sy0">/</span>etc<span class="sy0">/</span>ldap<span class="sy0">/</span>ldif<span class="co0"># ldapadd -x -D cn=admin,dc=labs,dc=cs,dc=pub,dc=ro -W -f uid-raynor.ldif </span>
Enter LDAP Password: 
adding new entry <span class="st0">&quot;uid=raynor,ou=Raiders,o=Terran,dc=labs,dc=cs,dc=pub,dc=ro&quot;</span>
&nbsp;
root<span class="sy0">@</span>ldap-client:<span class="sy0">/</span>etc<span class="sy0">/</span>ldap<span class="sy0">/</span>ldif<span class="co0"># ldapadd -x -D cn=admin,dc=labs,dc=cs,dc=pub,dc=ro -W -f uid-amengsk.ldif </span>
Enter LDAP Password: 
adding new entry <span class="st0">&quot;uid=amengsk,ou=Dominion,o=Terran,dc=labs,dc=cs,dc=pub,dc=ro&quot;</span></pre>

<p>
Opțiunea <code>-D</code> precizează <code>dn</code>-ul utilizatorului privilegiat. Opțiunea <code>-f</code> precizează fișierul format LDIF care va fi adăugat. Iar opțiunea <code>-W</code> precizează că se va introduce parola de la intrarea standard.
</p>

<p>
Intrările adăugate se găsesc acum în baza de date LDAP:
</p>
<pre class="code bash">root<span class="sy0">@</span>ldap-client:<span class="sy0">/</span>etc<span class="sy0">/</span>ldap<span class="sy0">/</span>ldif<span class="co0"># ldapsearch -x -LLL dn</span>
dn: <span class="re2">dc</span>=labs,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
&nbsp;
dn: <span class="re2">cn</span>=admin,<span class="re2">dc</span>=labs,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
&nbsp;
dn: <span class="re2">o</span>=Terran,<span class="re2">dc</span>=labs,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
&nbsp;
dn: <span class="re2">o</span>=Protoss,<span class="re2">dc</span>=labs,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
&nbsp;
dn: <span class="re2">ou</span>=Dominion,<span class="re2">o</span>=Terran,<span class="re2">dc</span>=labs,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
&nbsp;
dn: <span class="re2">ou</span>=Raiders,<span class="re2">o</span>=Terran,<span class="re2">dc</span>=labs,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
&nbsp;
dn: <span class="re2">uid</span>=raynor,<span class="re2">ou</span>=Raiders,<span class="re2">o</span>=Terran,<span class="re2">dc</span>=labs,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
&nbsp;
dn: <span class="re2">uid</span>=amengsk,<span class="re2">ou</span>=Dominion,<span class="re2">o</span>=Terran,<span class="re2">dc</span>=labs,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro</pre>

<p>
Adăugați și celelate intrări din fișierele LDIF din directorul <code>/etc/ldap/ldif/</code>. Există lipsuri în anumite fișiere pe care trebuie să le rezolvați.
</p>

<p>
<p><div class="noteclassic">
Acolo unde vă solicită un câmp completați cu o valoare potrivită.

</div></p>
</p>

<p>
Creați două noi fișiere:
</p>
<ul>
<li class="level1"><div class="li"> <code>uid-vmengsk.ldif</code> conține informații despre <code>Valerian Mengsk</code> (Dominion).</div>
</li>
<li class="level1"><div class="li"> <code>uid-horner.ldif</code> conține informații despre <code>Matt Horner</code> (Raiders).</div>
</li>
</ul>

<p>
Adăugați aceste fișiere la baza de date LDAP.
</p>

<p>
<p><div class="notetip">
Se recomandă să porniți de la fișiere existente și să le modificați pe acelea. Puteți porni de la fișierele <code>uid-amengsk.ldif</code> și <code>uid-raynor.ldif</code>.

</div></p>
</p>

<p>
În final listați conținutul bazei de date.
</p>

</div>
<!-- EDIT22 SECTION "05. [15p] Adăugare intrări în baza de date LDAP" [1-] --><!-- EDIT21 PLUGIN_INCLUDE_END "saisp:labs:01:contents:05" [0-] --></div>
<div class="level2">

</div>
<!-- EDIT23 PLUGIN_INCLUDE_START "saisp:labs:01:contents:06" [0-] --><div class="plugin_include_content plugin_include__saisp:labs:01:contents:06">

<h3 class="sectionedit25" id="p_adaugare_conturi_de_utilizatori_in_baza_de_date_ldap">06. [20p] Adăugare conturi de utilizatori în baza de date LDAP</h3>
<div class="level3">

<p>
Pentru a putea folosi conturi din baza de date LDAP pentru anumite forme de autentificare, este necesar ca intrările să aibă ca <code>objectClass</code> atât <code>posixAccount</code> cât și <code>shadowAccount</code>. Cele două clase conțin informații precum <code>uid</code>, <code>password</code>, <code>loginShell</code>, <code>uidNumber</code>, <code>gidNumber</code>.
</p>

<p>
Trebuie, așadar, să modificăm intrările de tip utilizator existente în baza de date LDAP. Modificările se realizează tot prin intermediul unui fișier LDIF. Astfel, pentru a adăuga informații din clasa <code>posixAccount</code> și <code>shadowAccount</code> pentru utilizatorul <code>amengsk</code> vom folosi un fișier cu următorul conținut:
</p>
<dl class="file">
<dt><a href="../../../code/saisp/labs/01%3Fcodeblock=44" title="Download Snippet" class="mediafile mf_ldif">account-uid-amengsk.ldif</a></dt>
<dd><pre class="code file none">dn: uid=amengsk,ou=Dominion,o=Terran,dc=labs,dc=cs,dc=pub,dc=ro
changetype: modify
add: objectClass
objectClass: posixAccount
-
add: uidNumber
uidNumber: 1001
-
add: gidNumber
gidNumber: 1000
-
add: homeDirectory
homeDirectory: /home/amengsk
-
add: loginShell
loginShell: /bin/bash
-
add: gecos
gecos: Arcturus Mengsk,,,
-
add: objectClass
objectClass: shadowAccount
-</pre>
</dd></dl>

<p>
Acest fișier se găsește și pe stația client în directorul <code>/etc/ldap/ldif/modify/</code>, cu numele <code>account-uid-amengsk.ldif</code>.
</p>

<p>
Adăugăm noile informații folosind comanda <code>ldapmodify</code>, cu o sintaxă similară comenzii <code>ldapadd</code>:
</p>
<pre class="code bash"><span class="co4">root@ldap-client:/etc/ldap/ldif/modify# </span>ldapmodify <span class="re5">-x</span> <span class="re5">-D</span> <span class="re2">cn</span>=admin,<span class="re2">dc</span>=labs,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro <span class="re5">-W</span> <span class="re5">-f</span> account-uid-amengsk.ldif</pre>

<p>
Acum verificăm modificările în baza de date LDAP folosind comanda <code>ldapsearch</code>:
</p>
<pre class="code bash">root<span class="sy0">@</span>ldap-client:<span class="sy0">/</span>etc<span class="sy0">/</span>ldap<span class="sy0">/</span>ldif<span class="sy0">/</span>modify<span class="co0"># ldapsearch -x -LLL uid=amengsk</span>
dn: <span class="re2">uid</span>=amengsk,<span class="re2">ou</span>=Dominion,<span class="re2">o</span>=Terran,<span class="re2">dc</span>=labs,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
uid: amengsk
cn: Arcturus Mengsk
givenName: Arcturus
sn: Mengsk
mail: mengsk<span class="sy0">@</span>dominion.terran.mil
objectClass: person
objectClass: inetOrgPerson
objectClass: posixAccount
objectClass: shadowAccount
uidNumber: <span class="nu0">1001</span>
gidNumber: <span class="nu0">1000</span>
homeDirectory: <span class="sy0">/</span>home<span class="sy0">/</span>amengsk
loginShell: <span class="sy0">/</span>bin<span class="sy0">/</span><span class="kw2">bash</span>
gecos: Arcturus Mengsk,,,</pre>

<p>
Pentru a fi informațiile complete trebuie completate câmpurile legate de parole. Pentru aceasta se folosește comanda <code>ldappasswd</code>:
</p>
<pre class="code bash">root<span class="sy0">@</span>ldap-client:<span class="sy0">/</span>etc<span class="sy0">/</span>ldap<span class="sy0">/</span>ldif<span class="sy0">/</span>modify<span class="co0"># ldappasswd -x -D cn=admin,dc=labs,dc=cs,dc=pub,dc=ro -W -S uid=amengsk,ou=Dominion,o=Terran,dc=labs,dc=cs,dc=pub,dc=ro</span>
New password: 
Re-enter new password: 
Enter LDAP Password:</pre>

<p>
Opțiunea <code>-W</code> folosită și în cazul comenzilor <code>ldapadd</code> și <code>ldappaswd</code> înseamnă că parola utilizatorului de bind (cel care face modificarea, în cazul de față <code>cn=admin,dc=labs,dc=cs,dc=pub,dc=ro</code>) se va citi de la intrarea standard. Opțiunea <code>-S</code> spune că parola care va fi completată utilizatorului transmis ca parametru (<code>uid=amengsk…</code>) va fi citită, de asemenea, de la intrarea standard. În rularea de mai sus se cere întâi parola utilizatorului primit ca parametru (introduceți ce parolă doriți), se confirmă acea parolă și apoi se cere parola de bind.
</p>

<p>
În acest moment utilizatorul are configurată parola. Pentru a verifica acest lucru, putem să citim intrarea din baza de date LDAP. Câmpul de parolă este însă accesibil doar utilizatorului propriu sau doar celui privilegiat. Vom face citirea folosind utilizatorul propriu (bind):
</p>
<pre class="code bash">root<span class="sy0">@</span>ldap-client:<span class="sy0">/</span>etc<span class="sy0">/</span>ldap<span class="sy0">/</span>ldif<span class="sy0">/</span>modify<span class="co0"># ldapsearch -x -LLL -D 'uid=amengsk,ou=Dominion,o=Terran,dc=labs,dc=cs,dc=pub,dc=ro' -W uid=amengsk userPassword</span>
Enter LDAP Password: 
dn: <span class="re2">uid</span>=amengsk,<span class="re2">ou</span>=Dominion,<span class="re2">o</span>=Terran,<span class="re2">dc</span>=labs,<span class="re2">dc</span>=cs,<span class="re2">dc</span>=pub,<span class="re2">dc</span>=ro
userPassword:: <span class="re2">e1NTSEF9NDhXajhSbzZ6THNWZ1YrRjRnNjRITno4blNYaWhSblo</span>=</pre>

<p>
În comanda de mai sus am realizat bind la serverul LDAP folosind chiar utilizatorul <code>amengsk</code>, am folosit opțiunea <code>-W</code> pentru a citi parola de la intrarea standard și apoi am solicitat afișarea câmpului <code>userPassword</code> în format <code>base64</code>.
</p>

<p>
<strong>Exercițiu</strong>: Realizați pașii de mai sus și pentru utilizatorii <code>raynor</code>, <code>vmengsk</code>, <code>horner</code>, <code>zeratul</code> și <code>artanis</code>.
</p>

<p>
<p><div class="noteclassic">
Creați copii ale fișierului <code>/etc/ldap/ldif/account-uid-mengsk.ldif</code>, încărcați-le în baza de date LDAP și apoi configurați parola pentru fiecare utilizator. Incrementați pentru fiecare utilizator adăugat valoarea pentru numărul de UID (<code>uidNumber</code>).

</div></p>
</p>

</div>
<!-- EDIT25 SECTION "06. [20p] Adăugare conturi de utilizatori în baza de date LDAP" [1-] --><!-- EDIT24 PLUGIN_INCLUDE_END "saisp:labs:01:contents:06" [0-] --></div>
<div class="level2">

</div>
<!-- EDIT26 PLUGIN_INCLUDE_START "saisp:labs:01:contents:07" [0-] --><div class="plugin_include_content plugin_include__saisp:labs:01:contents:07">

<h3 class="sectionedit28" id="p_configurare_suport_de_ldap_in_dokuwiki">07. [15p] Configurare suport de LDAP în DokuWiki</h3>
<div class="level3">

<p>
Folosind conturile de mai sus putem realiza autentificarea în diverse servicii care folosesc ca backend de autentificare LDAP. Un astfel de serviciu este wiki-ul de tipul DokuWiki.
</p>

<p>
Pe stația client este instalat și configurat serverul web Apache cu suport PHP și pachetul <code>php5-ldap</code> care oferă implementarea clientului de LDAP în PHP. Alte module (<code>userdir</code>, <code>ssl</code>) sunt configurate și activate.
</p>

<p>
Vom configura o instanță de DokuWiki în contul utilizatorului <code>student</code> de pe stația client. În directorul home al utilizatorului <code>student</code> găsiți creat directorul <code>public_html/dokuwiki/</code> unde vom instala instanța de DokuWiki. Pentru instalarea instanței intrăm în directorul <code>admin-public.git/dokuwiki/</code> din directorul home al utilizatorului <code>student</code> și rulăm scriptul de instalare <code>dw-install</code>. Întâi rulăm scriptul fără argumente ca să vedem ce opțiuni sunt disponibile:
</p>
<pre class="code bash">student<span class="sy0">@</span>ldap-client:~<span class="sy0">/</span>admin-public.git<span class="sy0">/</span>dokuwiki$ .<span class="sy0">/</span>dw-install
DokuWiki basic installation script
  Usage:
    .<span class="sy0">/</span>dw-install installation-directory download-url wiki-url
  Sample usage:
    .<span class="sy0">/</span>dw-install ~<span class="sy0">/</span>public_html<span class="sy0">/</span>dw-test<span class="sy0">/</span> http:<span class="sy0">//</span>www.splitbrain.org<span class="sy0">/</span>_media<span class="sy0">/</span>projects<span class="sy0">/</span>dokuwiki<span class="sy0">/</span>dokuwiki-<span class="nu0">2011</span>-05-25a.tgz http:<span class="sy0">//</span>swarm.cs.pub.ro<span class="sy0">/</span>~razvan<span class="sy0">/</span>dw-test</pre>

<p>
Apoi rulăm scriptul pentru realizarea instalării efective:
</p>
<pre class="code bash">student<span class="sy0">@</span>ldap-client:~<span class="sy0">/</span>admin-public.git<span class="sy0">/</span>dokuwiki$ .<span class="sy0">/</span>dw-install ~<span class="sy0">/</span>public_html<span class="sy0">/</span>dokuwiki<span class="sy0">/</span> http:<span class="sy0">//</span>download.dokuwiki.org<span class="sy0">/</span>src<span class="sy0">/</span>dokuwiki<span class="sy0">/</span>dokuwiki-stable.tgz http:<span class="sy0">//</span>192.168.0.3<span class="sy0">/</span>~student<span class="sy0">/</span>dokuwiki
&nbsp;
<span class="sy0">*</span> Logging information to <span class="sy0">/</span>tmp<span class="sy0">/</span>tmp.anntIlR19E.
<span class="sy0">*</span> Using download <span class="kw2">link</span> http:<span class="sy0">//</span>download.dokuwiki.org<span class="sy0">/</span>src<span class="sy0">/</span>dokuwiki<span class="sy0">/</span>dokuwiki-stable.tgz
  <span class="sy0">*</span> Downloading DokuWiki ... done.
<span class="sy0">*</span> Preparing installation folder <span class="sy0">/</span>home<span class="sy0">/</span>student<span class="sy0">/</span>public_html<span class="sy0">/</span>dokuwiki<span class="sy0">/</span> ... done.
<span class="sy0">*</span> Installing plugins
  <span class="sy0">*</span> Installing plugin: Creole ... done.
  <span class="sy0">*</span> Installing plugin: Google Analytics ... done.
  <span class="sy0">*</span> Installing plugin: Include ... done.
  <span class="sy0">*</span> Installing plugin: Index-Menu ... done.
  <span class="sy0">*</span> Installing plugin: Display-Wiki-Page ...done.
  <span class="sy0">*</span> Installing plugin: authsplit ...done.
  <span class="sy0">*</span> Installing plugin: authchained ...done.
&nbsp;
Installation complete.
<span class="nu0">1</span>. Open <span class="kw1">in</span> web browser: http:<span class="sy0">//</span>192.168.0.3<span class="sy0">/</span>~student<span class="sy0">/</span>dokuwiki<span class="sy0">/</span>install.php
<span class="nu0">2</span>. Fill required information to <span class="kw3">complete</span> the basic installation.
<span class="nu0">3</span>. Remove <span class="sy0">/</span>home<span class="sy0">/</span>student<span class="sy0">/</span>public_html<span class="sy0">/</span>dokuwiki<span class="sy0">//</span>install.php.bak file.
<span class="nu0">4</span>. Run:
   .<span class="sy0">/</span>dw-post-install <span class="sy0">/</span>home<span class="sy0">/</span>student<span class="sy0">/</span>public_html<span class="sy0">/</span>dokuwiki<span class="sy0">/</span> <span class="sy0">/</span>~student<span class="sy0">/</span>dokuwiki<span class="sy0">/</span></pre>

<p>
Apoi parcurgem pașii de mai sus (1, 2, 3, 4) ca să definitivăm instalarea. În acest moment, la adresa <a href="http://192.168.0.3/~student/dokuwiki/" class="urlextern" title="http://192.168.0.3/~student/dokuwiki/"  rel="nofollow">http://192.168.0.3/~student/dokuwiki/</a> poate fi accesat wiki-ul. Se poate face autentificarea cu utilizatorul indicat la pasul 1, în interfața web de instalare/configurare a DokuWiki.
</p>

<p>
Pentru a realiza suport de autentificare prin LDAP folosim <a href="https://www.dokuwiki.org/plugin:authldap" class="urlextern" title="https://www.dokuwiki.org/plugin:authldap"  rel="nofollow">indicațiile de pe site-ul DokuWiki</a>.
</p>

<p>
Pentru început, adăugăm în fișierul de configurare <code>/home/student/public_html/dokuwiki/conf/local.php</code> suportul pentru autentificarea LDAP, prin adăugarea liniilor:
</p>
<pre class="code php"><span class="re0">$conf</span><span class="br0">&#91;</span><span class="st_h">'authtype'</span><span class="br0">&#93;</span>       <span class="sy0">=</span> <span class="st_h">'authldap'</span><span class="sy0">;</span>
<span class="re0">$conf</span><span class="br0">&#91;</span><span class="st_h">'plugin'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'authldap'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'server'</span><span class="br0">&#93;</span>      <span class="sy0">=</span> <span class="st_h">'ldaps://192.168.0.2'</span><span class="sy0">;</span>
<span class="re0">$conf</span><span class="br0">&#91;</span><span class="st_h">'plugin'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'authldap'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'version'</span><span class="br0">&#93;</span>     <span class="sy0">=</span> <span class="nu0">3</span><span class="sy0">;</span>
<span class="re0">$conf</span><span class="br0">&#91;</span><span class="st_h">'plugin'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'authldap'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'usertree'</span><span class="br0">&#93;</span>    <span class="sy0">=</span> <span class="st_h">'dc=labs,dc=cs,dc=pub,dc=ro'</span><span class="sy0">;</span>
<span class="re0">$conf</span><span class="br0">&#91;</span><span class="st_h">'plugin'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'authldap'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'grouptree'</span><span class="br0">&#93;</span>   <span class="sy0">=</span> <span class="st_h">'dc=labs,dc=cs,dc=pub,dc=ro'</span><span class="sy0">;</span>
<span class="re0">$conf</span><span class="br0">&#91;</span><span class="st_h">'plugin'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'authldap'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'userfilter'</span><span class="br0">&#93;</span>  <span class="sy0">=</span> <span class="st_h">'(&amp;(uid=%{user})(objectClass=posixAccount))'</span><span class="sy0">;</span>
<span class="re0">$conf</span><span class="br0">&#91;</span><span class="st_h">'plugin'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'authldap'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'groupfilter'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="st_h">'(&amp;(objectClass=posixGroup)(|(gidNumber=%{gid})(memberUID=%{user})))'</span><span class="sy0">;</span></pre>

<p>
Dacă reaccesăm acum pagina instanței de wiki (<a href="http://192.168.0.3/~student/dokuwiki/" class="urlextern" title="http://192.168.0.3/~student/dokuwiki/"  rel="nofollow">http://192.168.0.3/~student/dokuwiki/</a>), vom primi mesajul “User authentication is temporarily unavailable. If this situation persists, please inform your Wiki Admin.” Pentru a rezolva această problemă activăm suportul pentru LDAP în fișierul <code>/home/student/public_html/dokuwiki/conf/plugins.local.php</code> și activăm linia corespunzătoare modulului LDAP:
</p>
<pre class="code php"><span class="re0">$plugins</span><span class="br0">&#91;</span><span class="st_h">'authldap'</span><span class="br0">&#93;</span>  <span class="sy0">=</span> <span class="nu0">1</span><span class="sy0">;</span></pre>

<p>
<p><div class="noteimportant">
Întrucât fișierul <code>/home/student/public_html/dokuwiki/conf/plugins.local.php</code> este posibil deținut de utilizatorul <code>www-data</code>, nu-l veți putea modifica. Îl puteți în schimb șterge. Pentru a-l putea edita urmați pașii
</p>
<ol>
<li class="level1"><div class="li"> Creați o copie a fișierului.</div>
</li>
<li class="level1"><div class="li"> Ștergeți fișierul.</div>
</li>
<li class="level1"><div class="li"> Redenumiți copia în numele fișierului.</div>
</li>
<li class="level1"><div class="li"> Editați fișierul.</div>
</li>
</ol>

<p>
Comenzile sunt următoarele:
</p>
<pre class="code bash">student<span class="sy0">@</span>ldap-client:~<span class="sy0">/</span>public_html<span class="sy0">/</span>dokuwiki<span class="sy0">/</span>conf$ <span class="kw2">cp</span> plugins.local.php tmp.plugins.php
student<span class="sy0">@</span>ldap-client:~<span class="sy0">/</span>public_html<span class="sy0">/</span>dokuwiki<span class="sy0">/</span>conf$ <span class="kw2">rm</span> plugins.local.php 
rm: remove write-protected regular <span class="kw2">file</span> ‘plugins.local.php’? y
student<span class="sy0">@</span>ldap-client:~<span class="sy0">/</span>public_html<span class="sy0">/</span>dokuwiki<span class="sy0">/</span>conf$ <span class="kw2">mv</span> tmp.plugins.php plugins.local.php
student<span class="sy0">@</span>ldap-client:~<span class="sy0">/</span>public_html<span class="sy0">/</span>dokuwiki<span class="sy0">/</span>conf$ <span class="kw2">vi</span> plugins.local.php</pre>

<p>

</div></p>
</p>

<p>
În acest moment configurația este finalizată, iar autentificarea pe instanța de wiki (accesibilă la <a href="http://192.168.0.3/~student/dokuwiki/" class="urlextern" title="http://192.168.0.3/~student/dokuwiki/"  rel="nofollow">http://192.168.0.3/~student/dokuwiki/</a>) va putea fi realizată folosind conturile de utilizatori LDAP adăugate atnterior.
</p>

</div>
<!-- EDIT28 SECTION "07. [15p] Configurare suport de LDAP în DokuWiki" [1-] --><!-- EDIT27 PLUGIN_INCLUDE_END "saisp:labs:01:contents:07" [0-] --></div>
<div class="level2">

</div>
<!-- EDIT29 PLUGIN_INCLUDE_START "saisp:labs:01:contents:08" [0-] --><div class="plugin_include_content plugin_include__saisp:labs:01:contents:08">

<h3 class="sectionedit31" id="bonus_-_10p_configurare_suport_de_ldap_in_mediawiki">08. [BONUS - 10p] Configurare suport de LDAP în MediaWiki</h3>
<div class="level3">

<p>
MediaWiki este una dintre cele mai cunoscute și folosite soluții de wiki. Spre deosebire de DokuWiki folosește o bază de date. Pentru aceasta am instalat pe stația client un server MySQL.
</p>

<p>
Similar cu DokuWiki vom instala MediaWiki în directorul <code>public_html/mediawiki/</code> din directorul home al utilizatorului <code>student</code>. Pentru instalare vom folosi fișierul arhivă <code>mediawiki-1.22.2.tar.gz</code> din directorul home al utilizatorului <code>student</code>. Vom urma indicațiile de instalare din <a href="http://www.mediawiki.org/wiki/Manual:Installing_MediaWiki" class="urlextern" title="http://www.mediawiki.org/wiki/Manual:Installing_MediaWiki"  rel="nofollow">pagina de instalare a MediaWiki</a>.
</p>

</div>

<h4 id="configurare_baza_de_date">Configurare bază de date</h4>
<div class="level4">

<p>
În primă fază vom configura baza de date. Pentru început ne vom conecta cu utilizatorul privilegiat al MySQL (parola este <code>student</code>):
</p>
<pre class="code bash"><span class="co4">student@ldap-client:~$ </span>mysql <span class="re5">-u</span> root <span class="re5">-pstudent</span>
<span class="br0">&#91;</span>...<span class="br0">&#93;</span>
mysql<span class="sy0">&gt;</span> </pre>

<p>
Astfel conectați vom crea baza de date pentru MediaWiki (denumită <code>wikidb</code>):
</p>
<pre class="code bash">mysql<span class="sy0">&gt;</span> create database wikidb;
Query OK, <span class="nu0">1</span> row affected <span class="br0">&#40;</span><span class="nu0">0.08</span> sec<span class="br0">&#41;</span></pre>

<p>
și apoi creăm utilizatorul care să fie folosit de MediaWiki pentru accesarea bazei de date (denumit <code>wikiuser</code>, folosibil de pe <code>localhost</code>):
</p>
<pre class="code bash">mysql<span class="sy0">&gt;</span> grant index, create, <span class="kw1">select</span>, insert, update, delete, alter, lock tables on wikidb.<span class="sy0">*</span> to <span class="st_h">'wikiuser'</span><span class="sy0">@</span><span class="st_h">'localhost'</span> identified by <span class="st_h">'student'</span>;
Query OK, <span class="nu0">0</span> rows affected <span class="br0">&#40;</span><span class="nu0">0.00</span> sec<span class="br0">&#41;</span></pre>

<p>
Am configurat baza de date MySQL și acum putem ieși din modul de configurare:
</p>
<pre class="code bash">mysql<span class="sy0">&gt;</span> <span class="kw3">exit</span>
Bye
<span class="co4">student@ldap-client:~$ </span></pre>

</div>

<h4 id="instalare_mediawiki">Instalare MediaWiki</h4>
<div class="level4">

<p>
După cum am spus vom instala MediaWiki în directorul <code>public_html/mediaiki/</code> din directorul home al utilizatorului <code>student</code>. Pentru început vom dezarhiva, în acel director, arhiva <code>~student/public_html/mediawiki-1.22.2.tar.gz</code>, ca utilizatorul <code>student</code>. Vom rula comenzile de mai jos:
</p>
<pre class="code bash"><span class="co4">student@ldap-client:~$ </span><span class="kw2">ls</span>
admin-public.git  mediawiki-1.22.2.tar.gz  public_html
<span class="co4">student@ldap-client:~$ </span><span class="kw3">cd</span> public_html<span class="sy0">/</span>
student<span class="sy0">@</span>ldap-client:~<span class="sy0">/</span>public_html$ <span class="kw2">ls</span>
dokuwiki
student<span class="sy0">@</span>ldap-client:~<span class="sy0">/</span>public_html$ <span class="kw2">tar</span> xzf ..<span class="sy0">/</span>mediawiki-1.22.2.tar.gz 
student<span class="sy0">@</span>ldap-client:~<span class="sy0">/</span>public_html$ <span class="kw2">ls</span>
dokuwiki  mediawiki-1.22.2
student<span class="sy0">@</span>ldap-client:~<span class="sy0">/</span>public_html$ <span class="kw2">mv</span> mediawiki-1.22.2<span class="sy0">/</span> mediawiki
student<span class="sy0">@</span>ldap-client:~<span class="sy0">/</span>public_html$ <span class="kw2">ls</span>
dokuwiki  mediawiki</pre>

<p>
Mai sus am redenumit directorul obținut după dezarhivare din <code>mediawiki-1.22.2/</code> în <code>mediawiki/</code>.
</p>

<p>
În continuare vom rula scriptul de instalare al MediaWiki. Accesăm <abbr title="Uniform Resource Locator">URL</abbr>-ul aferent MediaWiki: <a href="http://192.168.0.3/~student/mediawiki/" class="urlextern" title="http://192.168.0.3/~student/mediawiki/"  rel="nofollow">http://192.168.0.3/~student/mediawiki/</a>. De la acesta vom continua către pagina de configurare: <a href="http://192.168.0.3/~student/mediawiki/mw-config/index.php" class="urlextern" title="http://192.168.0.3/~student/mediawiki/mw-config/index.php"  rel="nofollow">http://192.168.0.3/~student/mediawiki/mw-config/index.php</a>. În acea pagină realizăm configurarea dorită, adică pașii:
</p>
<ul>
<li class="level1"><div class="li"> Limba dorită: vom opta pentru valoarea implicită (engleză).</div>
</li>
<li class="level1"><div class="li"> Verificările de mediu vor fi trecute: vom apăsa butonul “Continue”.</div>
</li>
<li class="level1"><div class="li"> La configurările de bază de date, vom folosi pentru diversele câmpuri următoarele valori:</div>
<ul>
<li class="level2"><div class="li"> <em>Database host</em>: <code>localhost</code></div>
</li>
<li class="level2"><div class="li"> <em>Database name</em>: <code>wikidb</code> (configurat anterior)</div>
</li>
<li class="level2"><div class="li"> <em>Database table prefix</em>: nu completăm nimic (nu dorim să avem un prefix în numele tabelelor din baza de date)</div>
</li>
<li class="level2"><div class="li"> <em>Database username</em>: <code>wikiuser</code> (configurat anterior)</div>
</li>
<li class="level2"><div class="li"> <em>Database password</em>: <code>student</code> (configurat anterior)</div>
</li>
</ul>
</li>
<li class="level1"><div class="li"> În opțiunile de bază de date alegem <code>InnoDB</code> ca engine de stocare și <code>UTF-8</code> ca set de caractere.</div>
</li>
<li class="level1"><div class="li"> În fereastra denumită “Name” completați ce opțiuni doriți.</div>
</li>
<li class="level1"><div class="li"> În celelalte ferestre alegeți, în continuare, ceea ce vi se pare potrivit.</div>
</li>
<li class="level1"><div class="li"> După realizarea configurărilor de mai sus, se va rula scriptul intern de configurare.</div>
</li>
<li class="level1"><div class="li"> Apoi se descarcă scriptul de configurare a wiki-ului. Acesta trebuie copiat în directorul de instalare al MediaWiki. Pentru aceasta, mergem în directorul unde a fost descărcat pe sistemul fizic și îl copiem în directorul de instalare folosind comanda <code>scp</code>:<pre class="code bash">student<span class="sy0">@</span>mjolnir:~<span class="sy0">/</span>Downloads$ <span class="kw2">scp</span> LocalSettings.php student<span class="sy0">@</span>192.168.0.3:public_html<span class="sy0">/</span>mediawiki<span class="sy0">/</span>
student<span class="sy0">@</span>192.168.0.3<span class="st_h">'s password: 
LocalSettings.php                             100% 4296     4.2KB/s   00:00</span></pre>
</div>
</li>
<li class="level1"><div class="li"> Acum putem accesa wiki-ul folosind <abbr title="Uniform Resource Locator">URL</abbr>-ul <a href="http://192.168.0.3/~student/mediawiki/index.php/Main_Page" class="urlextern" title="http://192.168.0.3/~student/mediawiki/index.php/Main_Page"  rel="nofollow">http://192.168.0.3/~student/mediawiki/index.php/Main_Page</a>.</div>
</li>
</ul>

</div>

<h4 id="configuare_autentificare_prin_ldap">Configuare autentificare prin LDAP</h4>
<div class="level4">

<p>
Pentru început trebuie să adăugăm <a href="http://www.mediawiki.org/wiki/Special:ExtensionDistributor/LdapAuthentication" class="urlextern" title="http://www.mediawiki.org/wiki/Special:ExtensionDistributor/LdapAuthentication"  rel="nofollow">extensia de LDAP aferentă MediaWiki</a>. Este deja descărcată în fișierul <code>wikimedia-mediawiki…</code> din directorul home al utilizatorului <code>student</code> de pe stația client. O vom dezarhiva în subdirectorul <code>extensions/</code> din directorul de instalare al MediaWiki (în cazul nostru <code>~student/public_html/mediawiki/</code>):
</p>
<pre class="code bash"><span class="co4">student@ldap-client:~$ </span><span class="kw3">cd</span> public_html<span class="sy0">/</span>mediawiki<span class="sy0">/</span>extensions<span class="sy0">/</span>
&nbsp;
student<span class="sy0">@</span>ldap-client:~<span class="sy0">/</span>public_html<span class="sy0">/</span>mediawiki<span class="sy0">/</span>extensions$ <span class="kw2">tar</span> xzf ~<span class="sy0">/</span>wikimedia-mediawiki-extensions-LdapAuthentication-2.0c-<span class="nu0">31</span>-g300d43f.tar.gz
&nbsp;
student<span class="sy0">@</span>ldap-client:~<span class="sy0">/</span>public_html<span class="sy0">/</span>mediawiki<span class="sy0">/</span>extensions$ <span class="kw2">ls</span>
Cite                Poem
ConfirmEdit         README
Gadgets             Renameuser
ImageMap            SimpleAntiSpam
InputBox            SpamBlacklist
Interwiki           SyntaxHighlight_GeSHi
LocalisationUpdate  TitleBlacklist
Nuke                WikiEditor
ParserFunctions     wikimedia-mediawiki-extensions-LdapAuthentication-300d43f
PdfHandler
&nbsp;
student<span class="sy0">@</span>ldap-client:~<span class="sy0">/</span>public_html<span class="sy0">/</span>mediawiki<span class="sy0">/</span>extensions$ <span class="kw2">mv</span> wikimedia-mediawiki-extensions-LdapAuthentication-300d43f<span class="sy0">/</span> LdapAuthentication
&nbsp;
student<span class="sy0">@</span>ldap-client:~<span class="sy0">/</span>public_html<span class="sy0">/</span>mediawiki<span class="sy0">/</span>extensions$ <span class="kw2">ls</span>
Cite         Interwiki           PdfHandler      SpamBlacklist
ConfirmEdit  LdapAuthentication  Poem            SyntaxHighlight_GeSHi
Gadgets      LocalisationUpdate  README          TitleBlacklist
ImageMap     Nuke                Renameuser      WikiEditor
InputBox     ParserFunctions     SimpleAntiSpam</pre>

<p>
Am redenumit mai sus directorul aferent extensiei de LDAP pentru MediaWiki în <code>LdapAuthentication/</code>.
</p>

<p>
Pentru configurarea autentificării prin LDAP pentru MediaWiki urmărim <a href="http://www.mediawiki.org/wiki/Extension:LDAP_Authentication/Options" class="urlextern" title="http://www.mediawiki.org/wiki/Extension:LDAP_Authentication/Options"  rel="nofollow">pagina aferentă pentru configurare</a>. Configurările vor fi realizate din directorul de instalare al MediaWiki (adică <code>~student/public_html/mediawiki/</code>).
</p>

<p>
Adăugăm suport pentru autentificarea pe bază de LDAP în fișierul <code>LocalSettings.php</code>, folosind un editor. Le adăugăm la sfârșitul fișierului ca să avem rezultatul de mai jos:
</p>
<pre class="code bash">student<span class="sy0">@</span>ldap-client:~<span class="sy0">/</span>public_html<span class="sy0">/</span>mediawiki$ <span class="kw2">tail</span> <span class="re5">-5</span> LocalSettings.php
&nbsp;
<span class="co0"># End of automatically generated settings.</span>
<span class="co0"># Add more configuration options below.</span>
require_once<span class="br0">&#40;</span> <span class="st0">&quot;<span class="es2">$IP</span>/extensions/LdapAuthentication/LdapAuthentication.php&quot;</span> <span class="br0">&#41;</span>;
require_once<span class="br0">&#40;</span> <span class="st0">&quot;<span class="es2">$IP</span>/includes/AuthPlugin.php&quot;</span> <span class="br0">&#41;</span>;
<span class="re1">$wgAuth</span> = new LdapAuthenticationPlugin<span class="br0">&#40;</span><span class="br0">&#41;</span>;</pre>

<p>
Adăugăm apoi, în continuare în același fișier (<code>LocalSettings.php</code>) directivele de configurare specifice pentru serverul de LDAP:
</p>
<pre class="code php"><span class="re0">$wgLDAPDomainNames</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">&#40;</span>
  <span class="st_h">'my-ldap-server'</span><span class="sy0">,</span>
<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$wgLDAPServerNames</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">&#40;</span>
  <span class="st_h">'my-ldap-server'</span> <span class="sy0">=&gt;</span> <span class="st_h">'ldap-server.local'</span><span class="sy0">,</span>
<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$wgLDAPUseLocal</span> <span class="sy0">=</span> <span class="kw4">false</span><span class="sy0">;</span>
<span class="re0">$wgLDAPEncryptionType</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">&#40;</span>
  <span class="st_h">'my-ldap-server'</span> <span class="sy0">=&gt;</span> <span class="st_h">'ssl'</span><span class="sy0">,</span>
<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$wgLDAPPort</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">&#40;</span>
  <span class="st_h">'my-ldap-server'</span> <span class="sy0">=&gt;</span> <span class="nu0">636</span><span class="sy0">,</span>
<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$wgLDAPSearchAttributes</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">&#40;</span>
  <span class="st_h">'my-ldap-server'</span> <span class="sy0">=&gt;</span> <span class="st_h">'uid'</span>
<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$wgLDAPBaseDNs</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">&#40;</span>
  <span class="st_h">'my-ldap-server'</span> <span class="sy0">=&gt;</span> <span class="st_h">'dc=labs,dc=cs,dc=pub,dc=ro'</span><span class="sy0">,</span>
<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="co2"># To pull e-mail address from LDAP
</span><span class="re0">$wgLDAPPreferences</span> <span class="sy0">=</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">&#40;</span>
  <span class="st_h">'my-ldap-server'</span> <span class="sy0">=&gt;</span> <a href="http://www.php.net/array"><span class="kw3">array</span></a><span class="br0">&#40;</span> <span class="st_h">'email'</span> <span class="sy0">=&gt;</span> <span class="st_h">'mail'</span><span class="br0">&#41;</span>
<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="co1">// May use debug level 3 for extensive debugging.</span>
<span class="co1">// $wgLDAPDebug = 1;</span>
<span class="co1">// $wgDebugLogGroups['ldap'] = '/tmp/debug.log';</span></pre>

<p>
Am marcat opțiunea de debug comentată. La nevoie poate fi decomentată și valoarea sa crescută până la 3 pentru mesaje detaliate.
</p>

<p>
O dată realizată configurația LDAP în fișierul de configurare (<code>LocalSettings.php</code>), va trebui să creăm tabelele aferente în baza de date. Pentru aceasta rulăm scriptul de actualizare:
</p>
<pre class="code bash">student<span class="sy0">@</span>ldap-client:~<span class="sy0">/</span>public_html<span class="sy0">/</span>mediawiki$ php maintenance<span class="sy0">/</span>update.php
<span class="br0">&#91;</span>...<span class="br0">&#93;</span>
Creating ldap_domains table ...done.
...site_stats is populated...done.
...rev_len column of revision table already populated.
...Update <span class="st_h">'populate rev_sha1'</span> already logged <span class="kw2">as</span> completed.
...img_sha1 column of image table already populated.
...protocol-relative URLs <span class="kw1">in</span> externallinks table already fixed.
...fa_sha1 column of filearchive table already populated.
Purging caches...done.
&nbsp;
Done.</pre>

<p>
După aceasta se accesează instanța de MediaWiki (<a href="http://192.168.0.3/~student/mediawiki/index.php/Main_Page" class="urlextern" title="http://192.168.0.3/~student/mediawiki/index.php/Main_Page"  rel="nofollow">http://192.168.0.3/~student/mediawiki/index.php/Main_Page</a>) și apoi se poate folosi link-ul “Log in” pentru autentificarea folosind LDAP. La opțiunea “Your domain:” se păstrează valoarea <code>my-ldap-server</code>.
</p>

</div>
<!-- EDIT31 SECTION "08. [BONUS - 10p] Configurare suport de LDAP în MediaWiki" [1-] --><!-- EDIT30 PLUGIN_INCLUDE_END "saisp:labs:01:contents:08" [0-] --></div>
<div class="level2">

</div>
<!-- EDIT32 PLUGIN_INCLUDE_START "saisp:labs:01:contents:sidebar" [0-] --><div class="plugin_include_content plugin_include__saisp:labs:01:contents:sidebar">

<h3 class="sectionedit34" id="navigare1">Navigare</h3>
<div class="level3">

<p>
<strong><span class="curid"><a href="../../../../saisp/labs/01.html" class="wikilink1" title="saisp:labs:01">Laboratorul 1</a></span></strong>
</p>

</div>
<!-- EDIT35 PLUGIN_INCLUDE_START "saisp:labs:01:meta:nav" [0-] --><div class="plugin_include_content plugin_include__saisp:labs:01:meta:nav">
<div class="level4">

<div><div id="nojs_indexmenu_46992407058356772b23a8" data-jsajax="%26skipfile%3D%252B/sidebar/" class="indexmenu_nojs">

<ul class="idx">
<li class="level1"><div class="li"><a href="../../../../saisp/labs/01/contents/01.html" class="wikilink1" title="saisp:labs:01:contents:01">01. [10p] Folosire client LDAP pentru interogare</a></div></li>
<li class="level1"><div class="li"><a href="../../../../saisp/labs/01/contents/02.html" class="wikilink1" title="saisp:labs:01:contents:02">02. [10p] Conectare securizată la serviciu de LDAP</a></div></li>
<li class="level1"><div class="li"><a href="../../../../saisp/labs/01/contents/03.html" class="wikilink1" title="saisp:labs:01:contents:03">03. [15p] Căutare în baza de date LDAP</a></div></li>
<li class="level1"><div class="li"><a href="../../../../saisp/labs/01/contents/04.html" class="wikilink1" title="saisp:labs:01:contents:04">04. [15p] Folosire programatică client de LDAP</a></div></li>
<li class="level1"><div class="li"><a href="../../../../saisp/labs/01/contents/05.html" class="wikilink1" title="saisp:labs:01:contents:05">05. [15p] Adăugare intrări în baza de date LDAP</a></div></li>
<li class="level1"><div class="li"><a href="../../../../saisp/labs/01/contents/06.html" class="wikilink1" title="saisp:labs:01:contents:06">06. [20p] Adăugare conturi de utilizatori în baza de date LDAP</a></div></li>
<li class="level1"><div class="li"><a href="../../../../saisp/labs/01/contents/07.html" class="wikilink1" title="saisp:labs:01:contents:07">07. [15p] Configurare suport de LDAP în DokuWiki</a></div></li>
<li class="level1"><div class="li"><a href="../../../../saisp/labs/01/contents/08.html" class="wikilink1" title="saisp:labs:01:contents:08">08. [BONUS - 10p] Configurare suport de LDAP în MediaWiki</a></div></li>
</ul>
</div></div>

</div>
<!-- EDIT36 PLUGIN_INCLUDE_END "saisp:labs:01:meta:nav" [0-] --></div>
<div class="level4">

</div>
<!-- EDIT34 SECTION "Navigare" [1-] --><!-- EDIT33 PLUGIN_INCLUDE_END "saisp:labs:01:contents:sidebar" [0-] --></div>
<div class="level2">

</div>
<!-- EDIT7 SECTION "Exerciții" [3039-] --></div>
</body>
</html>
