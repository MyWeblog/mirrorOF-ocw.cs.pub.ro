    
    

<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <title>ndk:courses:02</title>
<meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="date" content="2014-08-10T13:54:18+0300"/>
<meta name="keywords" content="ndk,courses,02"/>
<link rel="search" type="application/opensearchdescription+xml" href="../../../../lib/exe/opensearch.php" title="CS Open CourseWare"/>
<link rel="start" href="../../../../../courses.1.html"/>
<link rel="alternate" type="application/rss+xml" title="Recent Changes" href="../../../../feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Current Namespace" href="../../../../feed.php%3Fmode=list&amp;ns=ndk:courses"/>
<link rel="alternate" type="text/html" title="Plain HTML" href="02.html"/>
<link rel="canonical" href="../../../../ndk/courses/02.html"/>
<link rel="stylesheet" type="text/css" href="../../../../lib/exe/css.php%3Ft=arctic&amp;tseed=1479898000.css"/>
<script type="text/javascript">/*<![CDATA[*/var NS='ndk:courses';var JSINFO = {"id":"ndk:courses:02","namespace":"ndk:courses","isadmin":0,"isauth":0};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../../../../lib/exe/js.php%3Ftseed=1479898000"></script>
<script type="text/x-mathjax-config">/*<![CDATA[*/MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ["$","$"], ["\\(","\\)"] ],
        displayMath: [ ["$$","$$"], ["\\[","\\]"] ],
        processEscapes: true
    }
});
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
<script type="text/javascript">/*<![CDATA[*/
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
		  
/*!]]>*/</script>
<script type="text/javascript">/*<![CDATA[*/
var pageTracker = _gat._getTracker("UA-38383934-1");
pageTracker._initData();
pageTracker._trackPageview();
		  
/*!]]>*/</script>
</head>
<body>
<div class="dokuwiki export">
<!-- TOC START -->
<div id="dw__toc">
<h3 class="toggle">Table of Contents</h3>
<div>

<ul class="toc">
<li class="level2"><div class="li"><a href="02.html#android_platform">02. Android Platform</a></div>
<ul class="toc">
<li class="level3"><div class="li"><a href="02.html#lecture">Lecture</a></div></li>
<li class="level3"><div class="li"><a href="02.html#practical">Practical</a></div>
<ul class="toc">
<li class="level4"><div class="li"><a href="02.html#task_1_-_launching_an_activity">Task 1 - Launching an Activity</a></div></li>
<li class="level4"><div class="li"><a href="02.html#task_2_-_lists_and_adapters">Task 2 - Lists and Adapters</a></div></li>
<li class="level4"><div class="li"><a href="02.html#task_3_-_data_storage">Task 3 - Data storage</a></div></li>
<li class="level4"><div class="li"><a href="02.html#task_4_-_creating_a_broadcast_receiver">Task 4 - Creating a Broadcast Receiver</a></div></li>
<li class="level4"><div class="li"><a href="02.html#bonustask_5_-_creating_and_interacting_with_a_service">Bonus: Task 5 - Creating and interacting with a Service</a></div></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<!-- TOC END -->

<h2 class="sectionedit1" id="android_platform">02. Android Platform</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Description: Development environment on Android, overview of the Android SDK</div>
</li>
<li class="level1"><div class="li"> Practical part: Android SDK development</div>
</li>
</ul>

</div>
<!-- EDIT1 SECTION "02. Android Platform" [1-160] -->
<h3 class="sectionedit2" id="lecture">Lecture</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"><a href="../../../../_media/ndk/courses/lecture-2.pdf" class="media mediafile mf_pdf" title="ndk:courses:lecture-2.pdf (2.4 MB)"> Lecture Slides</a></div>
</li>
</ul>

<p>
<iframe title="" src="../../../../_media/ndk/courses/lecture-2.pdf" style="width:98%; height:400px"></iframe>
</p>

</div>
<!-- EDIT2 SECTION "Lecture" [161-302] -->
<h3 class="sectionedit3" id="practical">Practical</h3>
<div class="level3">

<p>
Lab archive: <a href="../../../../_media/ndk/courses/lab-2.zip" class="media mediafile mf_zip" title="ndk:courses:lab-2.zip (2.7 KB)">lab-2.zip</a>
Solved tasks: <a href="../../../../_media/ndk/courses/lab-2-solved.zip" class="media mediafile mf_zip" title="ndk:courses:lab-2-solved.zip (2.9 MB)">lab-2-solved.zip</a>
</p>

</div>

<h4 id="task_1_-_launching_an_activity">Task 1 - Launching an Activity</h4>
<div class="level4">

<p>
Create a new project and add a button to the main activity layout. Get a reference to this button in the onCreate method in MainActivity.
Add a new Activity to the project. You can add a new activity automatically by right clicking on the project and selecting <strong>New &gt; Android Activity</strong> from the menu. This will start a wizard similar to the one at application creation. In the new Activity override the onCreate method and use the setContentView method to change the layout to the layout you just created.
</p>

<p>
Back in MainActivity, add code to the onClick of the OnClickListener so that the new activity gets started. To start a new Activity you have to create an intent first. An intent to launch an activity explicitly takes two parameters: a Context and the Class of the second activity. Use getBaseContext() or v.getContext() to obtain a context.
</p>
<pre class="code">public void onClick(View v) {
	Intent i = new Intent(getBaseContext(), NewActivity.class);
}</pre>

<p>
Then, to launch the activity you must call: 
</p>
<pre class="code">startActivity(i);</pre>

<p>
Before launching the new activity, it must be declared in AndroidManifest.xml file. If you create the activity manually, you will have to add a similar line to the following one to the manifest file. If you created the activity through the wizard, it should have been added automatically.
</p>
<pre class="code">&lt;activity
   android:name=&quot;com.example.test.NewActivity&quot; /&gt;       </pre>

<p>
In the onCreate of the second activity make sure you use setContentView to the layout of the second activity and call the onCreate of the super class. If you created the Activity manually, you will also have to create an empty layout.
</p>
<pre class="code">super.onCreate(savedInstanceState);
setContentView(R.layout.new_activity);</pre>

<p>
Intents also contains a dictionary of data. Add an EditText box to your main activity layout and a TextView to your second activity layout.
When clicking the button, get the text from the EditText element, add it to the intent. Then, in your second activity, get the string from the intent and display it in the TextView. (Hint: <a href="http://developer.android.com/reference/android/content/Intent.html#putExtra%28java.lang.String,%20java.lang.CharSequence%29" class="urlextern" title="http://developer.android.com/reference/android/content/Intent.html#putExtra%28java.lang.String,%20java.lang.CharSequence%29"  rel="nofollow">Intent.putExtra</a>,  <a href="http://developer.android.com/reference/android/content/Intent.html#getStringExtra%28java.lang.String%29" class="urlextern" title="http://developer.android.com/reference/android/content/Intent.html#getStringExtra%28java.lang.String%29"  rel="nofollow">Intent.getStringExtra</a> and <a href="http://developer.android.com/reference/android/app/Activity.html#getIntent%28%29" class="urlextern" title="http://developer.android.com/reference/android/app/Activity.html#getIntent%28%29"  rel="nofollow">Activity.getIntent</a>)
</p>

</div>

<h4 id="task_2_-_lists_and_adapters">Task 2 - Lists and Adapters</h4>
<div class="level4">

<p>
Lists contain multiple items. Each item in the list has a layout, and usually all items in a list have the same layout. To account for this, ListViews must have an adapter which creates the View for each item. Usually it&#039;s easiest to extend ArrayAdapter, since it already has methods to add or remove items from the list (unless you have different types of items).
</p>

<p>
Add a ListView to your second activity. You will use the <strong>list_item.xml</strong> layout, MenuItem.java and MenuAdapter.java classes found in the lab archive. You have to implement the getView method of the MenuAdapter class such that it will properly display items of the MenuItem type. Look for the TODO comments.
</p>

<p>
You can use the layout inflater to create the views (or reuse the View the method receives, but make sure it&#039;s not null first):
</p>
<pre class="code">LayoutInflater inflater = (LayoutInflater)context.getSystemService
      (Context.LAYOUT_INFLATER_SERVICE);</pre>

<p>
To inflate a view use the inflater you obtained and call the <a href="http://developer.android.com/reference/android/view/LayoutInflater.html#inflate%28int,%20android.view.ViewGroup%29" class="urlextern" title="http://developer.android.com/reference/android/view/LayoutInflater.html#inflate%28int,%20android.view.ViewGroup%29"  rel="nofollow">inflate</a> method, giving it the <strong>list_item</strong> layout, and a null ViewGroup. Then, set the correct text on the TextViews inside the new View. Use findViewById on the View to get the TextViews.
</p>

<p>
Use this code to test your getView implementation:
</p>
<pre class="code">List&lt;MenuItem&gt; items = new ArrayList&lt;MenuItem&gt;();
ListView lv = (ListView) findViewById(R.id.listView1);
ArrayAdapter&lt;MenuItem&gt; list = new MenuAdapter(this, items);
list.add(new MenuItem(&quot;Coffee&quot;, 6, &quot;Simple black coffee&quot;));
list.add(new MenuItem(&quot;Caffe latte&quot;, 7, &quot;Coffee with milk&quot;));
list.add(new MenuItem(&quot;Espresso&quot;, 7, &quot;Simple espresso&quot;));
list.add(new MenuItem(&quot;Caffe macchiatto&quot;, 8, &quot;Espresso with foamed milk&quot;));
lv.setAdapter(list);</pre>

</div>

<h4 id="task_3_-_data_storage">Task 3 - Data storage</h4>
<div class="level4">

<p>
Add another two EditText elements to your first activity: one accepting strings and another accepting an integer. Add another button, label it “Add”. You will use this button to insert items into a database using a Content Provider, and the second activity will query this content provider. To add a Content Provider right click on the project folder and select <strong>New &gt; Other</strong> and from here, select <strong>Android &gt; Android Object</strong> and then Content Provider. You will need to provide an authority, typically this is the class name and package of the Content Manager to avoid naming issues with other apps.
</p>

<p>
It should generate a new ContentProvider. A ContentProvider does not need a specific backend, it can be used just as well for databases or data from files or the internet. In this task we will create an interface over a SQLite database.
</p>

<p>
First, there is some setup involved for convenience:
</p>
<pre class="code">private static final UriMatcher sUriMatcher;
static int TABLE = 1;
static int ROW = 2;

static {
	sUriMatcher = new UriMatcher(UriMatcher.NO_MATCH);
	// first parameter should be the authority declared in the manifest
	sUriMatcher.addURI(&quot;com.example.test.MyContentProvider&quot;, &quot;menu&quot;, TABLE);
	sUriMatcher.addURI(&quot;com.example.test.MyContentProvider&quot;, &quot;menu/#&quot;, ROW);		
}</pre>

<p>
This will generate an <abbr title="Uniform Resource Identifier">URI</abbr> Matcher which will help identify what kind of requests need to be processed.
</p>

<p>
Secondly, again, for convenience, a SQLiteOpenHelper class should be created.
</p>
<pre class="code">static class DatabaseHelper extends SQLiteOpenHelper {

	DatabaseHelper(Context context) {
		// context, db name, cursor factory - null for default, db version
		super(context, &quot;sample.db&quot;, null, 1);
	}

	@Override
	public void onCreate(SQLiteDatabase db) {
		db.execSQL(&quot;CREATE TABLE IF NOT EXISTS menu (&quot;
				+ &quot;id INTEGER PRIMARY KEY,&quot;
				+ &quot;name TEXT,&quot;
				+ &quot;desc TEXT,&quot;
				+ &quot;price INTEGER&quot;
				+ &quot;);&quot;);
	}

	@Override
	public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {
		//This should repopulate the table in the new database as well
		db.execSQL(&quot;DROP TABLE IF EXISTS menu&quot;);
		onCreate(db);
	}
}</pre>

<p>
Then, in onCreate you have to create an instance of this helper class and return true.
</p>
<pre class="code">static DatabaseHelper dbHelper;

public boolean onCreate() {
	dbHelper = new DatabaseHelper(getContext());
	return true;
}</pre>

<p>
Your task is to implement insert and query. Insert should check the ContentValue (only if the <abbr title="Uniform Resource Identifier">URI</abbr> matches the table, not a row), insert it into the table, and return the new row&#039;s <abbr title="Uniform Resource Identifier">URI</abbr>. Query should return the rows in the table which match the given parameters (including the ID, if it&#039;s given in the <abbr title="Uniform Resource Identifier">URI</abbr>) and return the cursor.
</p>

<p>
Use the DatabaseHelper to access the database (see getReadableDatabase, getWritableDatabase) and SQLiteQueryBuilder to create a query. Use the UriMatcher to check <abbr title="Uniform Resource Identifier">URI</abbr> type and validity.
</p>

<p>
Then, to test, insert items into the database in the MainActivity, and query the database and build the list from the database in the second activity.
</p>

<p>
Example inserting an item into the database:
</p>
<pre class="code">b2.setOnClickListener(new View.OnClickListener() {

	@Override
	public void onClick(View v) {
		ContentValues cv = new ContentValues();
		cv.put(&quot;name&quot;, ed1.getText().toString());
		cv.put(&quot;desc&quot;, ed2.getText().toString());
		cv.put(&quot;price&quot;, Integer.decode(ed3.getText().toString()));

		Uri u = getContentResolver().insert(Uri.parse(&quot;content://com.example.test.MyContentProvider/menu/&quot;), cv);
		Log.d(&quot;URI&quot;, u.toString());
	}
});</pre>

</div>

<h4 id="task_4_-_creating_a_broadcast_receiver">Task 4 - Creating a Broadcast Receiver</h4>
<div class="level4">

<p>
To add a Broadcast Receiver right click on the project folder and select <strong>New &gt; Other</strong> and from here, select <strong>Android &gt; Android Object</strong> and then Broadcast Receiver. By default it is created without an intent filter, but we will access it explicitly, so there is no need to add an intent filter.
</p>

<p>
Go back the adapter you created previously. Add an onClickListener to the view created in getView. Make it so that when you click on item it creates an Intent containing context and the receiver&#039;s class name and add the name of the clicked item using putExtra. Afterwards, use sendBroadcast to send the intent to the BroadcastReceiver.
</p>
<pre class="code">Intent i = new Intent(context, MyReceiver.class);
i.putExtra(&quot;name&quot;, getItem(position).getName());
context.sendBroadcast(i);</pre>

<p>
Inside the receiver, in the onReceive method, retrieve the String added to the intent and display it using a toast notification.
</p>
<pre class="code">Toast.makeText(context, name, Toast.LENGTH_LONG).show();</pre>

</div>

<h4 id="bonustask_5_-_creating_and_interacting_with_a_service">Bonus: Task 5 - Creating and interacting with a Service</h4>
<div class="level4">

<p>
There are multiple types of services (although they are not exclusive): started services and bound services. A started service receives commands, it runs them and when it&#039;s done with all the commands it stops. Bound services should be running as long as at least one client is still connected or until they are done with their tasks.
</p>

<p>
There are several ways to communicate with a bound service: you can either call functions from them directly if they&#039;re in the same application - for example, you bind to them and they generate data for you as long as they are running, you can call a function to retrieve data. This is useful when you have multiple activities which use the same data and you want to keep the service running during your application&#039;s lifetime. The second way is using a Messenger. This creates an interface similar to a socket where you assign a handler to call when you receive data. This allows for two way communication, and doesn&#039;t require you to use AIDL, although it uses it internally. The third way is to use AIDL, generate an interface and stubs and create a custom way to call functions in another process.
</p>

<p>
This task requires you to create a service and use Messenger to communicate between your activity and the service.
</p>

<p>
You have to create a new class which extends Handler and override handleMessage. In handleMessage you should check the value of the what field. This should indicate the type of message. You should define these values as static finals inside the Service. For now define three values: REQUEST_ACTION_LOCAL, REQUEST_ACTION_GLOBAL, REGISTER and UNREGISTER (1, 2, 3 and 4). In case of REGISTER or UNREGISTER, check the replyTo to field and add the Messenger to a list of Messengers or remove it. In case of REQUEST_ACTION_LOCAL send a message with a random integer to the Messenger in the replyTo field. In case of REQUEST_ACTION_GLOBAL send a message to all the registered Messengers. Add logs to all the cases, to see what the Service is doing. Also, remember to catch RemoteException (and remove from the list of messengers the ones that throw this exception when sending to them).
</p>

<p>
In the Activity, create a ServiceConnection object in which you create a Messenger object from the IBinder you receive in onServiceConnected, and set it to null in onServiceDisconnected.
</p>

<p>
Then bind to the service in onCreate (mConnection is the ServiceConnection):
</p>
<pre class="code">bindService(new Intent(this, MessengerService.class), mConnection,
	Context.BIND_AUTO_CREATE);</pre>

<p>
Next, create a Messenger, and a handler, like previously. You should use the same codes as before. This time you only have to log the messages received from the service.
</p>

<p>
Use Message.obtain to get a Message. The handler parameter should be null, the second parameter should be the action you want to execute. You have to set the replyTo field separately, set it to the Messenger you have created in the activity (not the one you created from the IBinder). Next, call the send of the Messenger tied to the service.
</p>

<p>
Add four buttons: one to sent a REQUEST_ACTION_LOCAL, one for REQUEST_ACTION_GLOBAL, one for REGISTER and the other for UNREGISTER. Check if the output is what you expected.
</p>

<p>
Do unbindService when leaving the activity (onPause).
</p>

</div>
<!-- EDIT3 SECTION "Practical" [303-] --></div>
</body>
</html>
