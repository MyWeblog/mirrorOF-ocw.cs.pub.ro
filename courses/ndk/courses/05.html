    
    

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
 "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
 lang="en" dir="ltr">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>
    05. NDK Integration (JNI)    [CS Open CourseWare]
  </title>

  <meta name="generator" content="DokuWiki"/>
<meta name="robots" content="index,follow"/>
<meta name="date" content="2014-08-10T13:56:59+0300"/>
<meta name="keywords" content="ndk,courses,05"/>
<link rel="search" type="application/opensearchdescription+xml" href="../../lib/exe/opensearch.php" title="CS Open CourseWare"/>
<link rel="start" href="../../../courses.1.html"/>
<link rel="alternate" type="application/rss+xml" title="Recent Changes" href="../../feed.php"/>
<link rel="alternate" type="application/rss+xml" title="Current Namespace" href="../../feed.php%3Fmode=list&amp;ns=ndk:courses"/>
<link rel="alternate" type="text/html" title="Plain HTML" href="../../_export/xhtml/ndk/courses/05.html"/>
<link rel="canonical" href="05.html"/>
<link rel="stylesheet" type="text/css" href="../../lib/exe/css.php%3Ft=arctic&amp;tseed=1479898000.css"/>
<script type="text/javascript">/*<![CDATA[*/var NS='ndk:courses';var JSINFO = {"id":"ndk:courses:05","namespace":"ndk:courses","isadmin":0,"isauth":0};
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="../../lib/exe/js.php%3Ftseed=1479898000"></script>
<script type="text/x-mathjax-config">/*<![CDATA[*/MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ["$","$"], ["\\(","\\)"] ],
        displayMath: [ ["$$","$$"], ["\\[","\\]"] ],
        processEscapes: true
    }
});
/*!]]>*/</script>
<script type="text/javascript" charset="utf-8" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script>
<script type="text/javascript">/*<![CDATA[*/
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
		  
/*!]]>*/</script>
<script type="text/javascript">/*<![CDATA[*/
var pageTracker = _gat._getTracker("UA-38383934-1");
pageTracker._initData();
pageTracker._trackPageview();
		  
/*!]]>*/</script>

  <link rel="shortcut icon" href="../../lib/tpl/arctic/images/favicon.ico" />

  
</head>
<body>
<div id="wrapper" class='show'>
  <div class="dokuwiki">

    
    <div class="stylehead">
      <div class="header">
        <div class="pagename">
          <a href="../index.html"><img height="70" src="../../res/sigla_ndk.png"/> </a>        </div>
        <div class="logo">
          <a style="color: #AAA !important;" href="../../systems/index.html"/><img height="70" src="../../res/systems.png" name="dokuwiki__top"/></a>        </div>
      </div>
    
       
      <div class="breadcrumbs">
              </div>
      
            </div>

                  <div class="bar" id="bar__top">
        <div class="bar-left">
                  </div>
        <div class="bar-right">
          <a href="05%3Fdo=recent.html"  class="action recent" accesskey="r" rel="nofollow" title="Recent changes [R]">Recent changes</a><a href="05%3Fdo=login&amp;sectok=f62420cf5b01253da4b50505d148181b.html"  class="action login" rel="nofollow" title="Login">Login</a>        </div>
    </div>
        
    
    
    
              <div class="left_page">
          
<h2 class="sectionedit1" id="ndk_integration_jni">05. NDK Integration (JNI)</h2>
<div class="level2">
<ul>
<li class="level1"><div class="li"> Description: Integrating NDK into Android SDK apps, Standard JNI, Android JNI</div>
</li>
<li class="level1"><div class="li"> Practical part: NDK Apps/libraries called from Java or Java called from C/C++</div>
</li>
<li class="level1"><div class="li"> Semester project starts: select topic and start development</div>
</li>
</ul>

</div>

<h3 class="sectionedit2" id="lecture">Lecture</h3>
<div class="level3">
<ul>
<li class="level1"><div class="li"><a href="../../_media/ndk/courses/lecture-5.pdf" class="media mediafile mf_pdf" title="ndk:courses:lecture-5.pdf (2.1 MB)"> Lecture Slides</a></div>
</li>
</ul>

<p>
<iframe title="" src="../../_media/ndk/courses/lecture-5.pdf" style="width:98%; height:400px"></iframe>
</p>

</div>

<h3 class="sectionedit3" id="practical">Practical</h3>
<div class="level3">

<p>
Lab archive: <a href="../../_media/ndk/courses/lab-5.zip" class="media mediafile mf_zip" title="ndk:courses:lab-5.zip (552.3 KB)">lab-5.zip</a>
Lab solutions: <a href="../../_media/ndk/courses/lab-5-solved.zip" class="media mediafile mf_zip" title="ndk:courses:lab-5-solved.zip (1.4 KB)">lab-5-solved.zip</a>
</p>

</div>

<h4 id="resources">Resources</h4>
<div class="level4">
<ul>
<li class="level1"><div class="li"> <a href="http://docs.oracle.com/javase/1.5.0/docs/guide/jni/spec/types.html" class="urlextern" title="http://docs.oracle.com/javase/1.5.0/docs/guide/jni/spec/types.html"  rel="nofollow">http://docs.oracle.com/javase/1.5.0/docs/guide/jni/spec/types.html</a></div>
</li>
<li class="level1"><div class="li"> <a href="http://docs.oracle.com/javase/7/docs/technotes/guides/jni/spec/functions.html" class="urlextern" title="http://docs.oracle.com/javase/7/docs/technotes/guides/jni/spec/functions.html"  rel="nofollow">http://docs.oracle.com/javase/7/docs/technotes/guides/jni/spec/functions.html</a></div>
</li>
</ul>

</div>

<h4 id="task_0">Task 0</h4>
<div class="level4">

<p>
Download the lab archive and import the project into Eclipse (<strong>New &gt; Project</strong> and then <strong>Android &gt; Android Project from existing code</strong>). Build and run the application. You will notice there are 8 buttons, each with a TextView associated. Each of them correspond to a task, in order.
</p>

</div>

<h4 id="task_1_-_call_a_java_method_from_native_code">Task 1 - Call a Java method from native code</h4>
<div class="level4">

<p>
For the first task you have to call the setText() method from native code. To do this, you have to call
</p>
<pre class="code C">env<span class="sy0">-&gt;</span>CallVoidMethod<span class="br0">&#40;</span>obj<span class="sy0">,</span> mID<span class="br0">&#41;</span><span class="sy0">;</span></pre>

<p>
where obj is the object you want to call the method on and mID is the method ID. The Void in the name suggests that the method returns void.
</p>

<p>
To get the method ID you have to call
</p>
<pre class="code C">jmethodID mID <span class="sy0">=</span> env<span class="sy0">-&gt;</span>GetMethodID<span class="br0">&#40;</span>cls<span class="sy0">,</span> <span class="st0">&quot;setText&quot;</span><span class="sy0">,</span> <span class="st0">&quot;()V&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>

<p>
where cls is the class the method is part of, the first string is the method name and the second string is a method signature. In this case, the method takes no parameters ”()” and returns void “V”.
</p>

<p>
Finally, to get the class, call
</p>
<pre class="code C">jclass cls <span class="sy0">=</span> env<span class="sy0">-&gt;</span>FindClass<span class="br0">&#40;</span><span class="st0">&quot;ndk/lab5/tasks/MainActivity&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>

<p>
which has a single parameter, the class name and package, with the path divided by ”/”.
</p>

<p>
It is good practice to check for null when getting a class or methodID, and treating the error as required.
</p>

</div>

<h4 id="task_2_-_call_a_java_method_with_a_parameter_from_native_code">Task 2 - Call a Java method with a parameter from native code</h4>
<div class="level4">

<p>
For the second task you have to call setText(String) method from native code. This is similar to the above task execept the method signature has changed, instead of <strong>()V</strong>, the new method signature will be <strong>(Ljava/lang/String;)V</strong>. All parameters must have ; after them if they are objects. Objects are defined as L followed by the fully qualified class. Check the <a href="http://docs.oracle.com/javase/1.5.0/docs/guide/jni/spec/types.html" class="urlextern" title="http://docs.oracle.com/javase/1.5.0/docs/guide/jni/spec/types.html"  rel="nofollow">JNI Types Documentation</a>.
</p>

<p>
To set the parameter, create a new jstring, and give it as a parameter after the methodID.
</p>
<pre class="code C">jstring str <span class="sy0">=</span> env<span class="sy0">-&gt;</span>NewStringUTF<span class="br0">&#40;</span><span class="st0">&quot;OK&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
env<span class="sy0">-&gt;</span>CallVoidMethod<span class="br0">&#40;</span>obj<span class="sy0">,</span> mID<span class="sy0">,</span> str<span class="br0">&#41;</span><span class="sy0">;</span></pre>

<p>
Remember to release the string after you are done with it.
</p>
<pre class="code C">env<span class="sy0">-&gt;</span>ReleaseStringUTFChars<span class="br0">&#40;</span>str<span class="sy0">,</span> env<span class="sy0">-&gt;</span>GetStringUTFChars<span class="br0">&#40;</span>str<span class="sy0">,</span> NULL<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>

</div>

<h4 id="task_3_-_get_the_return_value_of_a_java_method">Task 3 - Get the return value of a Java method</h4>
<div class="level4">

<p>
Call String getInput(). This method returns the content of the EditText box under of task 3. There are three things that need to change from the first task: the method name, the method signature, which will now be <strong>()Ljava/lang/String;</strong> and the method call itself, which should be
</p>
<pre class="code C">jstring str <span class="sy0">=</span> <span class="br0">&#40;</span>jstring<span class="br0">&#41;</span> env<span class="sy0">-&gt;</span>CallObjectMethod<span class="br0">&#40;</span>obj<span class="sy0">,</span> mID<span class="br0">&#41;</span><span class="sy0">;</span></pre>

<p>
Now, call setText(String, int), giving it as parameters the int that task3 receives and the jstring obtained from getInput. There is an easy way to obtain the signature of a function by using javap. Call it like this:
</p>
<pre class="code C">javap <span class="sy0">-</span>classpath $WORKSPACE<span class="sy0">/</span>Lab5_Tasks<span class="sy0">/</span>bin<span class="sy0">/</span>classes<span class="sy0">/</span> <span class="sy0">-</span>p <span class="sy0">-</span>s ndk.<span class="me1">lab5</span>.<span class="me1">tasks</span>.<span class="me1">MainActivity</span></pre>

<p>
javap is used to disassemble java files, and the -s parameter is used to generate the signatures for public functions and fields, -p tells it to also generate signatures for private members of the class.
Remember to call ReleaseStringUTFChars after you are done with the string.
</p>

</div>

<h4 id="task_4_-_call_a_static_method">Task 4 - Call a static method</h4>
<div class="level4">

<p>
This time, you have to call the getInt method and then check the result with checkInt. These are static methods. Accessing static methods is very similar to accessing instance methods. There are two changes: instead of using GetMethodID, use GetStaticMethodID,
and when calling the function use CallStatic&lt;Type&gt;Method, passing the class instead of an object as first parameter.
</p>

</div>

<h4 id="task_5_-_get_the_value_of_a_field">Task 5 - Get the value of a field</h4>
<div class="level4">

<p>
Get value of the field “field” and return it. Getting the value of field means calling
</p>
<pre class="code C">jint i <span class="sy0">=</span> env<span class="sy0">-&gt;</span>GetIntField<span class="br0">&#40;</span>obj<span class="sy0">,</span> fID<span class="br0">&#41;</span><span class="sy0">;</span></pre>

<p>
where obj is the object and fID is a jfieldID containing the ID of the field.
To get the field ID, you need the class, obtained like in the previous exercises and to call
</p>
<pre class="code C">jfieldID fID <span class="sy0">=</span> env<span class="sy0">-&gt;</span>GetFieldID<span class="br0">&#40;</span>cls<span class="sy0">,</span> <span class="st0">&quot;field&quot;</span><span class="sy0">,</span> <span class="st0">&quot;I&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>

<p>
where, cls is the jclass, “field” is the field name and “I” is the signature. Field signatures can also be obtained with javap (or by checking the <a href="http://docs.oracle.com/javase/1.5.0/docs/guide/jni/spec/types.html" class="urlextern" title="http://docs.oracle.com/javase/1.5.0/docs/guide/jni/spec/types.html"  rel="nofollow">JNI Types Documentation</a>).
</p>

</div>

<h4 id="task_6_-_set_the_value_of_a_field">Task 6 - Set the value of a field</h4>
<div class="level4">

<p>
Set the value of the field “field” with the value received as a parameter. Instead of calling GetIntField, you will have to call
</p>
<pre class="code C">env<span class="sy0">-&gt;</span>SetIntField<span class="br0">&#40;</span>obj<span class="sy0">,</span> fID<span class="sy0">,</span> i<span class="br0">&#41;</span><span class="sy0">;</span></pre>

<p>
with i being the value you wish to set the field to.
</p>

</div>

<h4 id="task_7_-_generate_an_exception">Task 7 - Generate an exception</h4>
<div class="level4">

<p>
Generate an exception. To generate an exception you have to get the class of the exception and then call
</p>
<pre class="code C">env<span class="sy0">-&gt;</span>ThrowNew<span class="br0">&#40;</span>exception<span class="sy0">,</span> <span class="st0">&quot;JNI Generated Exception&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>

<p>
where exception is the class of the exception. The string provides additional information.
</p>

</div>

<h4 id="task_8_-_check_for_an_exception">Task 8 - Check for an exception</h4>
<div class="level4">

<p>
Call the generateException method and check if it generated an exception. Return JNI_TRUE if yes, and JNI_FALSE otherwise.
To check for an exception you can either call
</p>
<pre class="code C">jboolean ex <span class="sy0">=</span> env<span class="sy0">-&gt;</span>ExceptionCheck<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>

<p>
which returns JNI_TRUE if an exception has occurred and JNI_FALSE otherwise or
</p>
<pre class="code C">jthrowable ex <span class="sy0">=</span> env<span class="sy0">-&gt;</span>ExceptionOccured<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>

<p>
and check if ex is null or not.
Remember to clear exception status, otherwise it will be thrown back to the JVM when the function returns.
</p>
<pre class="code C">env<span class="sy0">-&gt;</span>ExceptionClear<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>

</div>

        </div>
        <div class="right_sidebar">
          <form action="../../start.html" accept-charset="utf-8" class="search" id="dw__search" method="get"><div class="no"><input type="hidden" name="do" value="search" /><input type="text" id="qsearch__in" accesskey="f" name="id" class="edit" title="[F]" /><input type="submit" value="Search" class="button" title="Search" /><div id="qsearch__out" class="ajax_qsearch JSpopup"></div></div></form>          <div class="namespace_sidebar sidebar_box">

<p>
<a href="../grading.html" class="wikilink1" title="ndk:grading">Rules and Grading</a> <br/>

<a href="../register.html" class="wikilink1" title="ndk:register">Class Register</a>
</p>

<h1 class="sectionedit1" id="lectures_labs">Lectures &amp; labs</h1>
<div class="level1">

<div><div id="nojs_indexmenu_128158496258357ac9b2202" data-jsajax="" class="indexmenu_nojs">

<ul class="idx">
<li class="level1"><div class="li"><a href="01.html" class="wikilink1" title="ndk:courses:01">01. Android Technology</a></div></li>
<li class="level1"><div class="li"><a href="02.html" class="wikilink1" title="ndk:courses:02">02. Android Platform</a></div></li>
<li class="level1"><div class="li"><a href="03.html" class="wikilink1" title="ndk:courses:03">03. Android Internals</a></div></li>
<li class="level1"><div class="li"><a href="04.html" class="wikilink1" title="ndk:courses:04">04. C, Bionic and Low-Level Libraries</a></div></li>
<li class="level1"><div class="li"><span class="curid"><a href="05.html" class="wikilink1" title="ndk:courses:05">05. NDK Integration (JNI)</a></span></div></li>
<li class="level1"><div class="li"><a href="06.html" class="wikilink1" title="ndk:courses:06">06. NDK Integration (JNI)</a></div></li>
<li class="level1"><div class="li"><a href="07.html" class="wikilink1" title="ndk:courses:07">07. Debugging and Profiling</a></div></li>
<li class="level1"><div class="li"><a href="08.html" class="wikilink1" title="ndk:courses:08">08. OpenGL on Android</a></div></li>
<li class="level1"><div class="li"><a href="09.html" class="wikilink1" title="ndk:courses:09">09. Native Activity</a></div></li>
<li class="level1"><div class="li"><a href="10.html" class="wikilink1" title="ndk:courses:10">10. Renderscript</a></div></li>
<li class="level1"><div class="li"><a href="11.html" class="wikilink1" title="ndk:courses:11">11. NDK Optimization and Portability</a></div></li>
</ul>
</div></div>

</div>
<!-- EDIT1 SECTION "Lectures & labs" [73-130] -->
<h1 class="sectionedit2" id="resources">Resources</h1>
<div class="level1">

<div><div id="nojs_indexmenu_183931641158357ac9b31a2" data-jsajax="" class="indexmenu_nojs">

<ul class="idx">
<li class="level1"><div class="li"><a href="../resources/01.html" class="wikilink1" title="ndk:resources:01">Resources</a></div></li>
</ul>
</div></div>

</div>
<!-- EDIT2 SECTION "Resources" [131-184] -->
<h1 class="sectionedit3" id="assignments">Assignments</h1>
<div class="level1">

<div><div id="nojs_indexmenu_126541187358357ac9b4142" data-jsajax="" class="indexmenu_nojs">

<ul class="idx">
<li class="level1"><div class="li"><a href="../assignments/project.html" class="wikilink1" title="ndk:assignments:project">Project</a></div></li>
<li class="level1"><div class="li"><a href="../assignments/warmup.html" class="wikilink1" title="ndk:assignments:warmup">Warm-up assignment</a></div></li>
</ul>
</div></div>

</div>
<!-- EDIT3 SECTION "Assignments" [185-] -->
</div>
<div class="toc_sidebar sidebar_box">
<!-- TOC START -->
<div id="sb__right__dw__toc">
<h3 class="toggle">Table of Contents</h3>
<div>

<ul class="toc">
<li class="level2"><div class="li"><a href="05.html#ndk_integration_jni">05. NDK Integration (JNI)</a></div>
<ul class="toc">
<li class="level3"><div class="li"><a href="05.html#lecture">Lecture</a></div></li>
<li class="level3"><div class="li"><a href="05.html#practical">Practical</a></div>
<ul class="toc">
<li class="level4"><div class="li"><a href="05.html#resources">Resources</a></div></li>
<li class="level4"><div class="li"><a href="05.html#task_0">Task 0</a></div></li>
<li class="level4"><div class="li"><a href="05.html#task_1_-_call_a_java_method_from_native_code">Task 1 - Call a Java method from native code</a></div></li>
<li class="level4"><div class="li"><a href="05.html#task_2_-_call_a_java_method_with_a_parameter_from_native_code">Task 2 - Call a Java method with a parameter from native code</a></div></li>
<li class="level4"><div class="li"><a href="05.html#task_3_-_get_the_return_value_of_a_java_method">Task 3 - Get the return value of a Java method</a></div></li>
<li class="level4"><div class="li"><a href="05.html#task_4_-_call_a_static_method">Task 4 - Call a static method</a></div></li>
<li class="level4"><div class="li"><a href="05.html#task_5_-_get_the_value_of_a_field">Task 5 - Get the value of a field</a></div></li>
<li class="level4"><div class="li"><a href="05.html#task_6_-_set_the_value_of_a_field">Task 6 - Set the value of a field</a></div></li>
<li class="level4"><div class="li"><a href="05.html#task_7_-_generate_an_exception">Task 7 - Generate an exception</a></div></li>
<li class="level4"><div class="li"><a href="05.html#task_8_-_check_for_an_exception">Task 8 - Check for an exception</a></div></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<!-- TOC END -->
</div>
        </div>
      
    
      <div class="stylefoot">
        <div class="meta">
          <div class="user">
                    </div>
          <div class="doc">
          ndk/courses/05.txt · Last modified: 2014/08/10 13:56 by petre.eftime          </div>
        </div>
      </div>

    <div class="clearer"></div>

    
                <div class="bar" id="bar__bottom">
      <div class="bar-left">
        <a href="05%3Fdo=revisions.html"  class="action revs" accesskey="o" rel="nofollow" title="Old revisions [O]">Old revisions</a>      </div>
      <div class="bar-right">
        <a href="05%3Fdo=media&amp;ns=ndk%253Acourses.html"  class="action media" rel="nofollow" title="Media Manager">Media Manager</a><a href="05.html#dokuwiki__top"  class="action top" accesskey="t" rel="nofollow" title="Back to top [T]">Back to top</a>      </div>
    </div>
    <div class="clearer"></div>
            
    <div align="center" class="footerinc">
  <div class="license"><a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="../../lib/images/license/button/cc-by-sa.png" alt="CC Attribution-Share Alike 3.0 Unported" /></a></div>
  <a target="_blank" href="http://www.chimeric.de" title="www.chimeric.de"><img src="../../lib/tpl/arctic/images/button-chimeric-de.png" width="80" height="15" alt="www.chimeric.de" border="0" /></a>

  <a target="_blank" href="http://jigsaw.w3.org/css-validator/check/referer" title="Valid CSS"><img src="../../lib/tpl/arctic/images/button-css.png" width="80" height="15" alt="Valid CSS" border="0" /></a>

  <a target="_blank" href="http://wiki.splitbrain.org/wiki:dokuwiki" title="Driven by DokuWiki"><img src="../../lib/tpl/arctic/images/button-dw.png" width="80" height="15" alt="Driven by DokuWiki" border="0" /></a>

  <a target="_blank" href="http://www.firefox-browser.de" title="do yourself a favour and use a real browser - get firefox"><img src="../../lib/tpl/arctic/images/button-firefox.png" width="80" height="15" alt="do yourself a favour and use a real browser - get firefox!!" border="0" /></a>
  
  <a target="_blank" href="../../feed.php" title="Recent changes RSS feed"><img src="../../lib/tpl/arctic/images/button-rss.png" width="80" height="15" alt="Recent changes RSS feed" border="0" /></a>

  <a target="_blank" href="http://validator.w3.org/check/referer" title="Valid XHTML 1.0"><img src="../../lib/tpl/arctic/images/button-xhtml.png" width="80" height="15" alt="Valid XHTML 1.0" border="0" /></a>
</div>

  </div>
</div>

<div class="no"><img src="../../lib/exe/indexer.php%3Fid=ndk%253Acourses%253A05&amp;1479899849" width="2" height="1" alt="" /></div>
</body>
</html>
